<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitDock Hub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* GitDock Hub — same design language as main dashboard */
    :root {
      --bg0: #08090a;
      --bg1: #111318;
      --bg2: #1a1d24;
      --bg3: #282c37;
      --border: rgba(255,255,255,0.06);
      --border-active: rgba(255,255,255,0.13);
      --t1: #e2e4e9;
      --t2: #8c90a0;
      --t3: #585c6d;
      --blue: #3b82f6;
      --green: #22c55e;
      --yellow: #eab308;
      --red: #ef4444;
      --purple: #a78bfa;
      --orange: #f97316;
      --cyan: #22d3ee;
      --r: 10px;
      --tr: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
      --shadow-glow: 0 0 20px rgba(59,130,246,0.12), 0 0 60px rgba(59,130,246,0.04);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { height: 100%; }
    body {
      font-family: var(--font);
      background: var(--bg0);
      color: var(--t1);
      line-height: 1.6;
      height: 100%;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.14); }

    /* Top bar — matches GitDock app-top */
    .top-bar {
      flex-shrink: 0;
      height: 52px;
      padding: 0 20px;
      background: rgba(17,19,24,0.8);
      backdrop-filter: blur(24px) saturate(180%);
      -webkit-backdrop-filter: blur(24px) saturate(180%);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      position: relative;
      z-index: 100;
    }
    .top-bar::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent 5%, rgba(59,130,246,0.35) 30%, rgba(167,139,250,0.3) 50%, rgba(34,211,238,0.25) 70%, transparent 95%);
    }
    .top-bar-left { display: flex; align-items: center; gap: 12px; }
    .hub-logo {
      width: 32px; height: 32px;
      border-radius: 8px;
      overflow: hidden;
      flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 16px rgba(59,130,246,0.2);
    }
    .hub-logo img { width: 100%; height: 100%; object-fit: cover; }
    .top-bar h1 { font-size: 15px; font-weight: 700; letter-spacing: -0.02em; }
    .top-bar nav { display: flex; gap: 6px; align-items: center; }
    .top-bar a, .top-bar button {
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--t2);
      font-size: 12px;
      font-family: var(--font);
      cursor: pointer;
      text-decoration: none;
      transition: var(--tr);
      font-weight: 500;
    }
    .top-bar a:hover, .top-bar button:hover { color: var(--t1); border-color: var(--border-active); background: rgba(255,255,255,0.03); }
    .top-bar a.nav-active { background: rgba(59,130,246,0.12); border-color: rgba(59,130,246,0.3); color: var(--blue); font-weight: 600; }
    .top-bar button.btn-logout:hover { border-color: rgba(239,68,68,0.35); color: var(--red); background: rgba(239,68,68,0.05); }

    .main {
      flex: 1;
      overflow: auto;
      padding: 24px;
      background: radial-gradient(ellipse at 50% 0%, rgba(59,130,246,0.03) 0%, transparent 60%);
    }

    /* Login — landing-style card (cta-box + hero) */
    .login-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 32px 24px;
      position: relative;
      overflow: hidden;
    }
    .login-wrap::before {
      content: '';
      position: absolute;
      top: -30%;
      left: 50%;
      transform: translateX(-50%);
      width: 700px;
      height: 700px;
      background: radial-gradient(circle, rgba(59,130,246,0.08) 0%, rgba(167,139,250,0.04) 40%, transparent 70%);
      pointer-events: none;
    }
    .login-box {
      position: relative;
      width: 100%;
      max-width: 420px;
      padding: 48px 40px;
      background: var(--bg1);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4), 0 0 40px rgba(59,130,246,0.06);
      overflow: hidden;
    }
    .login-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--blue), var(--purple));
    }
    .login-box .login-logo {
      margin: 0 auto 24px;
      display: block;
      text-align: center;
    }
    .login-box .login-logo img {
      height: 120px;
      width: auto;
      display: inline-block;
      vertical-align: middle;
    }
    .login-box h2 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
      text-align: center;
    }
    .login-box h2 .grad {
      background: linear-gradient(135deg, var(--blue), var(--purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .login-box .login-sub {
      color: var(--t2);
      font-size: 14px;
      text-align: center;
      margin-bottom: 28px;
      line-height: 1.5;
    }
    .login-box input {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 16px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--t1);
      font-size: 14px;
      font-family: var(--font);
      outline: none;
      transition: var(--tr);
    }
    .login-box input:focus {
      border-color: rgba(59,130,246,0.5);
      box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
    }
    .login-box input::placeholder { color: var(--t3); }
    .login-box button[type="submit"] {
      width: 100%;
      padding: 12px 24px;
      background: var(--blue);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      font-family: var(--font);
      cursor: pointer;
      transition: var(--tr);
      margin-top: 8px;
    }
    .login-box button[type="submit"]:hover {
      background: #2563eb;
      box-shadow: 0 0 20px rgba(59,130,246,0.3);
    }
    .login-box .error {
      color: var(--red);
      font-size: 13px;
      margin-top: 12px;
      text-align: center;
    }
    .login-box .login-link {
      text-align: center;
      margin-top: 16px;
      font-size: 13px;
      color: var(--t2);
    }
    .login-box .login-link a {
      color: var(--blue);
      text-decoration: none;
    }
    .login-box .login-link a:hover { text-decoration: underline; }

    /* Password field wrapper */
    .pw-wrap { position: relative; width: 100%; }
    .pw-wrap input { padding-right: 44px; }
    .pw-toggle {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(calc(-50% - 8px));
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      color: var(--t3);
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s;
    }
    .pw-toggle:hover { color: var(--t1); }
    .pw-toggle svg { width: 18px; height: 18px; }

    .view { display: none; }
    .view.active { display: block; }

    .page-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; letter-spacing: -0.02em; }
    .overview-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
    .stat-card .stat-value { display: block; font-size: 24px; font-weight: 700; letter-spacing: -0.02em; color: var(--t1); }
    .stat-card .stat-label { font-size: 12px; color: var(--t3); text-transform: uppercase; letter-spacing: 0.04em; }
    .stat-card .stat-meta { display: block; font-size: 11px; color: var(--t2); margin-top: 4px; }
    .stat-card--attention .stat-value { color: var(--orange); }
    @media (max-width: 720px) { .overview-stats { grid-template-columns: repeat(2, 1fr); } }
    .section { margin-bottom: 28px; }
    .sec-hdr { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
    .section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.7px;
      color: var(--t3);
      font-weight: 600;
    }
    .sec-cnt { background: var(--bg3); color: var(--t2); padding: 2px 9px; border-radius: 10px; font-size: 11px; font-weight: 600; }

    /* Sync issues */
    .issues-list { list-style: none; }
    .issue-item {
      padding: 14px 16px;
      margin-bottom: 8px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      font-size: 13px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      transition: var(--tr);
    }
    .issue-item:hover { border-color: var(--border-active); }
    .issue-item.unpushed { border-left: 3px solid var(--yellow); }
    .issue-item.behind { border-left: 3px solid var(--orange); }
    .issue-item.dirty { border-left: 3px solid var(--red); }
    .issue-item.stale_machine { border-left: 3px solid var(--t3); }
    .issue-item.branch_mismatch, .issue-item.dirty_multiple { border-left: 3px solid var(--red); }
    .issue-type { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--t3); flex-shrink: 0; }
    .issue-msg { flex: 1; }

    /* Machine grid — card style like GitDock repo cards */
    .machine-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
    .machine-grid.pulse { animation: pulse-bg 0.6s ease-out; }
    @keyframes pulse-bg { 0% { opacity: 1; } 50% { opacity: 0.85; } 100% { opacity: 1; } }
    .machine-card {
      padding: 20px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      cursor: pointer;
      transition: var(--tr);
    }
    .machine-card:hover {
      border-color: rgba(59,130,246,0.4);
      box-shadow: var(--shadow-md), 0 0 0 1px rgba(59,130,246,0.06);
    }
    .machine-card h3 { font-size: 15px; font-weight: 600; margin-bottom: 8px; letter-spacing: -0.01em; }
    .machine-card .meta { font-size: 12px; color: var(--t2); margin-bottom: 10px; }
    .machine-card .stats { font-size: 11px; color: var(--t3); display: flex; gap: 14px; }
    .machine-card .stats span.issues { color: var(--orange); font-weight: 600; }
    .machine-card .stats span.issues.zero { color: var(--green); }

    /* Machine detail */
    .machine-detail-header { margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
    .machine-detail-title-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 8px; }
    .machine-detail-header h2 { font-size: 20px; font-weight: 700; margin: 0; letter-spacing: -0.02em; }
    .machine-detail-actions { display: flex; gap: 8px; }
    .machine-detail-rename-wrap { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
    .machine-detail-rename-wrap input { flex: 1; min-width: 180px; padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; background: var(--bg); color: var(--t1); }
    .machine-detail-header .back {
      font-size: 12px; color: var(--blue); cursor: pointer; margin-bottom: 12px;
      display: inline-flex; align-items: center; gap: 4px;
      transition: var(--tr);
    }
    .machine-detail-header .back:hover { opacity: 0.9; text-decoration: underline; }
    .machine-detail-toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .machine-detail-search { position: relative; flex: 1; min-width: 200px; max-width: 320px; }
    .machine-detail-search input {
      width: 100%;
      padding: 8px 12px 8px 32px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--t1);
      font-size: 13px;
      font-family: var(--font);
      outline: none;
      transition: var(--tr);
    }
    .machine-detail-search input:focus { border-color: rgba(59,130,246,0.5); }
    .machine-detail-search input::placeholder { color: var(--t3); }
    .machine-detail-search .search-icon {
      position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
      color: var(--t3); pointer-events: none;
    }
    .machine-detail-filters { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
    .machine-detail-filters .fbtn {
      padding: 4px 10px; border-radius: 6px; border: 1px solid var(--border);
      background: transparent; color: var(--t2); font-size: 11px; font-family: var(--font);
      cursor: pointer; transition: var(--tr);
    }
    .machine-detail-filters .fbtn:hover { border-color: var(--border-active); color: var(--t1); }
    .machine-detail-filters .fbtn.on { background: rgba(59,130,246,0.12); border-color: rgba(59,130,246,0.3); color: var(--blue); font-weight: 600; }
    .machine-detail-repo-count { font-size: 12px; color: var(--t3); }
    .repos-toolbar { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
    .repo-card-machine { font-size: 11px; color: var(--t3); margin-top: 4px; }
    .repo-card-machine .machine-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; background: var(--bg-hover); color: var(--t2); margin-right: 4px; }
    .repo-card-multimachine { font-size: 11px; color: var(--orange); margin-top: 2px; }
    .repo-list { list-style: none; padding: 0; margin: 0; }
    /* View toggle */
    .repo-view-toggle { display: flex; align-items: center; gap: 4px; }
    .repo-view-toggle .vbtn {
      padding: 6px 12px; border-radius: 8px; border: 1px solid var(--border);
      background: transparent; color: var(--t2); font-size: 12px; font-family: var(--font);
      cursor: pointer; transition: var(--tr); font-weight: 500;
    }
    .repo-view-toggle .vbtn:hover { border-color: var(--border-active); color: var(--t1); }
    .repo-view-toggle .vbtn.on { background: rgba(59,130,246,0.12); border-color: rgba(59,130,246,0.3); color: var(--blue); font-weight: 600; }
    /* Cards grid */
    .repo-list--cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(310px, 1fr)); gap: 14px; }
    .repo-list--cards .repo-card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      transition: var(--tr);
      cursor: pointer;
    }
    .repo-list--cards .repo-card:hover { border-color: var(--border-active); box-shadow: var(--shadow-sm); }
    .repo-list--cards .repo-card.rc--attention { border-left: 3px solid var(--orange); }
    .repo-list--cards .repo-card.rc--clean { border-left: 3px solid rgba(34,197,94,0.25); }
    .rc-front { padding: 14px 16px; user-select: none; }
    .rc-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .rc-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .rc-dot--clean { background: var(--green); box-shadow: 0 0 6px rgba(34,197,94,0.4); }
    .rc-dot--dirty { background: var(--red); box-shadow: 0 0 6px rgba(239,68,68,0.4); }
    .rc-dot--ahead { background: var(--yellow); box-shadow: 0 0 6px rgba(234,179,8,0.4); }
    .rc-dot--behind { background: var(--orange); box-shadow: 0 0 6px rgba(249,115,22,0.4); }
    .rc-name { font-weight: 600; font-size: 15px; color: var(--t1); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .rc-branch { font-size: 11px; font-family: 'SF Mono','Cascadia Code','Fira Code',monospace; color: var(--t2); background: var(--bg3); padding: 2px 8px; border-radius: 4px; flex-shrink: 0; }
    .rc-chevron { font-size: 14px; color: var(--t2); width: 26px; height: 26px; display: inline-flex; align-items: center; justify-content: center; border: 1px solid var(--border-active); border-radius: 50%; transition: transform 0.2s ease, background 0.2s ease; flex-shrink: 0; }
    .repo-card:hover .rc-chevron { color: var(--t1); }
    .repo-card.rc-expanded .rc-chevron { transform: rotate(90deg); }
    .rc-subrow { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--t3); margin-bottom: 10px; }
    .rc-time { cursor: help; }
    .rc-machine-badge { font-size: 10px; padding: 1px 6px; border-radius: 4px; background: rgba(167,139,250,0.1); color: var(--purple); }
    .rc-stats { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .rc-counters { display: flex; gap: 4px; }
    .rc-stat { display: inline-flex; align-items: center; gap: 4px; font-size: 13px; padding: 4px 10px; border-radius: 6px; background: rgba(255,255,255,0.03); border: 1px solid transparent; transition: var(--tr); }
    .rc-stat-lbl { font-weight: 700; font-size: 12px; }
    .rc-stat-val { font-weight: 600; color: var(--t2); }
    .rc-stat--staged .rc-stat-lbl { color: var(--green); }
    .rc-stat--modified .rc-stat-lbl { color: var(--yellow); }
    .rc-stat--untracked .rc-stat-lbl { color: var(--cyan); }
    .rc-stat--conflict .rc-stat-lbl { color: var(--red); }
    .rc-stat.rc-stat--hot { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.08); }
    .rc-stat.rc-stat--hot .rc-stat-val { color: #fff; font-weight: 700; }
    .rc-sync { display: flex; gap: 10px; font-size: 11px; margin-top: 8px; }
    .rc-sync-item { display: inline-flex; align-items: center; gap: 3px; color: var(--t3); }
    .rc-sync-item .arrow { font-size: 12px; }
    .rc-sync-item.rc-sync--ahead .arrow, .rc-sync-item.rc-sync--ahead .num { color: var(--yellow); font-weight: 600; }
    .rc-sync-item.rc-sync--behind .arrow, .rc-sync-item.rc-sync--behind .num { color: var(--orange); font-weight: 600; }
    .rc-badge { font-size: 10px; padding: 3px 10px; border-radius: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; flex-shrink: 0; }
    .rc-badge--clean { background: rgba(34,197,94,0.12); color: var(--green); }
    .rc-badge--dirty { background: rgba(239,68,68,0.12); color: var(--red); }
    .rc-badge--ahead { background: rgba(234,179,8,0.12); color: var(--yellow); }
    .rc-badge--behind { background: rgba(249,115,22,0.12); color: var(--orange); }
    .rc-detail { max-height: 0; overflow: hidden; transition: max-height 0.3s cubic-bezier(0.4,0,0.2,1), opacity 0.25s ease; opacity: 0; }
    .repo-card.rc-expanded .rc-detail { max-height: 250px; opacity: 1; }
    .rc-detail-inner { padding: 0 16px 14px; border-top: 1px solid var(--border); padding-top: 12px; }
    .rc-detail-section { margin-bottom: 10px; }
    .rc-detail-section:last-child { margin-bottom: 0; }
    .rc-detail-lbl { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--t3); margin-bottom: 3px; }
    .rc-detail-msg { font-size: 12px; color: var(--t1); line-height: 1.5; }
    .rc-detail-msg[data-tip] { cursor: help; }
    #hub-tooltip {
      position: fixed; z-index: 99999; pointer-events: none;
      max-width: 400px; padding: 10px 14px;
      background: var(--bg3); color: var(--t1); border: 1px solid var(--border-active); border-radius: 8px;
      font-size: 12px; line-height: 1.5; white-space: pre-wrap; word-break: break-word;
      box-shadow: var(--shadow-lg);
      opacity: 0; transition: opacity 0.15s ease;
    }
    #hub-tooltip.visible { opacity: 1; }
    .rc-detail-meta { font-size: 11px; color: var(--t3); margin-top: 2px; }
    .rc-detail-bar { display: flex; height: 4px; border-radius: 2px; overflow: hidden; background: var(--border); margin-top: 6px; }
    .rc-detail-bar-seg { height: 100%; }
    .rc-detail-bar-seg.seg-ahead { background: var(--yellow); }
    .rc-detail-bar-seg.seg-behind { background: var(--orange); }
    .rc-detail-pills { display: flex; gap: 6px; flex-wrap: wrap; }
    .rc-detail-pill { font-size: 10px; padding: 2px 8px; border-radius: 4px; background: var(--bg3); color: var(--t2); }
    .rc-multimachine { font-size: 10px; color: var(--orange); }
    .summary-dirty--clean { color: var(--t3); }
    /* List view — aligned columns */
    .repo-list--list .repo-row {
      display: grid;
      grid-template-columns: minmax(140px, 1fr) 100px 90px 110px 80px;
      align-items: center;
      gap: 16px;
      padding: 12px 16px;
      margin-bottom: 6px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      font-size: 13px;
      transition: var(--tr);
    }
    .repo-list--list .repo-row:hover { border-color: var(--border-active); }
    .repo-list--list .repo-row.repo-row-needs-attention { border-left: 3px solid var(--orange); }
    .repo-list--list .repo-row-top { display: contents; }
    .repo-list--list .repo-row .name { font-weight: 600; font-size: 14px; }
    .repo-list--list .repo-row .account-pill { font-size: 11px; padding: 2px 8px; border-radius: 6px; background: var(--bg3); color: var(--t2); justify-self: center; }
    .repo-list--list .repo-row .branch { font-size: 12px; color: var(--t2); font-family: var(--mono, monospace); justify-self: center; }
    .repo-list--list .repo-row .ahead-behind { font-size: 11px; color: var(--t2); justify-self: center; }
    .repo-list--list .repo-row .badge { justify-self: end; }
    .repo-list--list .repo-row-meta { grid-column: 1 / -1; font-size: 12px; color: var(--t3); line-height: 1.4; padding-top: 4px; border-top: 1px solid var(--border); margin-top: 4px; }
    .repo-list--list .repo-row-meta .last-commit { color: var(--t2); }
    .repo-list--list .repo-row-meta .summary-dirty { color: var(--red); font-size: 11px; }
    /* Shared row styles (list content) */
    .repo-row .name { font-weight: 600; font-size: 14px; }
    .repo-row .account-pill { font-size: 10px; padding: 2px 8px; border-radius: 6px; background: var(--bg3); color: var(--t2); }
    .repo-row .branch { font-size: 12px; color: var(--t2); font-family: var(--mono, monospace); }
    .repo-row .badge {
      font-size: 10px;
      padding: 3px 10px;
      border-radius: 6px;
      font-weight: 600;
    }
    .repo-row .badge.clean { background: rgba(34,197,94,0.15); color: var(--green); }
    .repo-row .badge.dirty { background: rgba(239,68,68,0.15); color: var(--red); }
    .repo-row .badge.ahead { background: rgba(234,179,8,0.15); color: var(--yellow); }
    .repo-row .badge.behind { background: rgba(249,115,22,0.15); color: var(--orange); }
    .repo-row .ahead-behind { font-size: 11px; color: var(--t2); }
    .repo-row .ahead-behind .ahead-n { color: var(--yellow); }
    .repo-row .ahead-behind .behind-n { color: var(--orange); }
    .repo-row-meta { font-size: 12px; color: var(--t3); line-height: 1.4; }
    .repo-row-meta .last-commit { color: var(--t2); }
    .repo-row-meta .summary-dirty { color: var(--red); font-size: 11px; }
    .repo-list-empty { color: var(--t3); font-size: 13px; padding: 24px; text-align: center; }

    /* Buttons — match GitDock */
    .btn {
      padding: 6px 14px; border-radius: 8px;
      border: 1px solid var(--border); background: transparent;
      color: var(--t2); font-size: 12px; font-family: var(--font);
      cursor: pointer; transition: var(--tr);
      display: inline-flex; align-items: center; gap: 6px;
      font-weight: 500;
    }
    .btn:hover { border-color: var(--border-active); color: var(--t1); background: rgba(255,255,255,0.03); }
    .btn-primary { background: var(--blue); border-color: transparent; color: #fff; font-weight: 600; }
    .btn-primary:hover { background: #2563eb; box-shadow: 0 0 20px rgba(59,130,246,0.25); }
    .btn-danger { border-color: var(--border); color: var(--t2); }
    .btn-danger:hover { border-color: rgba(239,68,68,0.35); color: var(--red); background: rgba(239,68,68,0.05); }
    .btn-sm { padding: 4px 10px; font-size: 11px; border-radius: 6px; }

    /* Settings / Keys */
    .keys-list { list-style: none; }
    .key-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      margin-bottom: 8px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      font-size: 13px;
      transition: var(--tr);
    }
    .key-row:hover { border-color: var(--border-active); }
    .key-row .label { font-weight: 600; }
    .key-row .meta { font-size: 11px; color: var(--t3); margin-top: 2px; }
    .key-row button { padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); background: transparent; color: var(--t2); font-size: 11px; font-family: var(--font); cursor: pointer; transition: var(--tr); }
    .key-row button:hover { color: var(--red); border-color: rgba(239,68,68,0.35); background: rgba(239,68,68,0.05); }
    .new-key-box {
      margin-top: 24px;
      padding: 24px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--r);
    }
    .new-key-box .section-title { margin-bottom: 12px; }
    .new-key-box input {
      padding: 9px 12px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--bg1); color: var(--t1); font-size: 13px;
      width: 220px; margin-right: 10px;
      font-family: var(--font);
    }
    .new-key-box input:focus { outline: none; border-color: rgba(59,130,246,0.5); }
    .new-key-box button { padding: 9px 18px; border-radius: 8px; border: none; background: var(--blue); color: #fff; font-size: 13px; font-weight: 600; font-family: var(--font); cursor: pointer; transition: var(--tr); }
    .new-key-box button:hover { background: #2563eb; box-shadow: 0 0 16px rgba(59,130,246,0.2); }
    .new-key-result {
      margin-top: 14px; padding: 14px;
      background: var(--bg1); border: 1px solid var(--border);
      border-radius: var(--r); font-size: 12px; word-break: break-all;
    }
    .new-key-result .copy-btn { margin-top: 10px; padding: 6px 12px; font-size: 11px; cursor: pointer; border-radius: 6px; border: 1px solid var(--border); background: transparent; color: var(--t2); font-family: var(--font); transition: var(--tr); }
    .new-key-result .copy-btn:hover { color: var(--blue); border-color: rgba(59,130,246,0.4); }
    .empty-msg { color: var(--t3); font-size: 13px; }
    .empty-state-onboarding { text-align: center; padding: 48px 24px; max-width: 420px; margin: 0 auto; }
    .empty-state-onboarding .empty-state-logo { margin-bottom: 20px; }
    .empty-state-onboarding .empty-state-logo img { width: 56px; height: 56px; opacity: 0.9; }
    .empty-state-onboarding .empty-state-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; color: var(--t1); }
    .empty-state-onboarding .empty-state-desc { font-size: 13px; color: var(--t2); margin-bottom: 20px; line-height: 1.5; }
    .empty-state-onboarding .empty-state-steps { text-align: left; font-size: 13px; color: var(--t2); line-height: 1.8; margin: 0 auto 24px; padding-left: 20px; max-width: 320px; }
    .empty-state-onboarding .empty-state-steps strong { color: var(--t1); }
    .empty-state-onboarding .btn { margin-bottom: 12px; }
    .empty-state-onboarding .empty-state-hint { font-size: 12px; color: var(--t3); }
  </style>
</head>
<body>
  <div id="hub-tooltip"></div>
  <div id="loginView" class="login-wrap">
    <div class="login-box" id="loginBox">
      <span class="login-logo"><img src="/gitdock-logo-removebg.png" alt="GitDock"></span>
      <h2><span class="grad">GitDock Hub</span></h2>
      <p class="login-sub" id="loginSub">Sign in to view your machines and sync status.</p>
      <form id="loginForm">
        <input type="email" id="loginEmail" placeholder="Email" autocomplete="email" required>
        <div class="pw-wrap">
          <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password" required>
          <button type="button" class="pw-toggle" tabindex="-1" aria-label="Toggle password visibility">
            <svg class="eye-show" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>
            <svg class="eye-hide" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><path d="M14.12 14.12a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
          </button>
        </div>
        <button type="submit">Sign in</button>
      </form>
      <p class="login-link"><a href="#" id="showRegister">Create account</a></p>
      <div id="loginError" class="error" style="display:none"></div>
    </div>
    <div class="login-box" id="registerBox" style="display:none">
      <span class="login-logo"><img src="/gitdock-logo-removebg.png" alt="GitDock"></span>
      <h2><span class="grad">Create account</span></h2>
      <p class="login-sub">Register to use GitDock Hub.</p>
      <form id="registerForm">
        <input type="email" id="registerEmail" placeholder="Email" autocomplete="email" required>
        <div class="pw-wrap">
          <input type="password" id="registerPassword" placeholder="Password" autocomplete="new-password" required>
          <button type="button" class="pw-toggle" tabindex="-1" aria-label="Toggle password visibility">
            <svg class="eye-show" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>
            <svg class="eye-hide" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><path d="M14.12 14.12a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
          </button>
        </div>
        <div class="pw-wrap">
          <input type="password" id="registerConfirm" placeholder="Confirm password" autocomplete="new-password" required>
          <button type="button" class="pw-toggle" tabindex="-1" aria-label="Toggle password visibility">
            <svg class="eye-show" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>
            <svg class="eye-hide" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><path d="M14.12 14.12a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
          </button>
        </div>
        <button type="submit">Create account</button>
      </form>
      <p class="login-link"><a href="#" id="showLogin">Already have an account? Sign in</a></p>
      <div id="registerError" class="error" style="display:none"></div>
    </div>
  </div>

  <div id="appView" style="display:none">
    <header class="top-bar">
      <div class="top-bar-left">
        <div class="hub-logo" title="GitDock"><img src="/gitdock-logo.png" alt="GitDock"></div>
        <h1>GitDock Hub</h1>
      </div>
      <nav>
        <span class="top-bar-email" id="userEmail" style="font-size: 12px; color: var(--t2); margin-right: 8px;"></span>
        <span class="top-bar-updated" id="lastUpdated" style="font-size: 11px; color: var(--t3); margin-right: 12px;"></span>
        <a href="#" data-view="overview" id="navOverview">Overview</a>
        <a href="#" data-view="repos" id="navRepos">Repos</a>
        <a href="#" data-view="settings" id="navSettings">Settings</a>
        <button type="button" id="logoutBtn" class="btn-logout">Log out</button>
      </nav>
    </header>
    <main class="main">
      <div id="overviewView" class="view active">
        <div class="overview-stats" id="overviewStatsBar">
          <div class="stat-card">
            <span class="stat-value" id="statMachines">0</span>
            <span class="stat-label">Machines</span>
            <span class="stat-meta" id="statMachinesMeta">—</span>
          </div>
          <div class="stat-card">
            <span class="stat-value" id="statRepos">0</span>
            <span class="stat-label">Repositories</span>
          </div>
          <div class="stat-card">
            <span class="stat-value" id="statClean">0</span>
            <span class="stat-label">Clean</span>
          </div>
          <div class="stat-card stat-card--attention">
            <span class="stat-value" id="statAttention">0</span>
            <span class="stat-label">Needs Attention</span>
          </div>
        </div>
        <div class="section">
          <div class="sec-hdr">
            <span class="section-title">Sync issues</span>
            <span class="sec-cnt" id="issuesCount">0</span>
          </div>
          <ul id="issuesList" class="issues-list"></ul>
          <p id="noIssues" class="empty-msg" style="display:none;">No sync issues detected.</p>
        </div>
        <div class="section">
          <div class="sec-hdr">
            <span class="section-title">Machines</span>
            <span class="sec-cnt" id="machinesCount">0</span>
          </div>
          <div id="machineGrid" class="machine-grid"></div>
          <p id="noMachines" class="empty-msg" style="display:none;">No machines have reported yet. Configure the Hub in your local GitDock and start the agent.</p>
          <div id="emptyStateOnboarding" class="empty-state-onboarding" style="display:none;">
            <div class="empty-state-logo"><img src="/gitdock-logo.png" alt="GitDock"></div>
            <h3 class="empty-state-title">Connect your machines</h3>
            <p class="empty-state-desc">Once connected, you’ll see all your repos and sync status here.</p>
            <ol class="empty-state-steps">
              <li>Open GitDock on your machine.</li>
              <li>Go to <strong>Hub settings</strong>.</li>
              <li>Enter your Hub URL and API key.</li>
            </ol>
            <button type="button" id="emptyStateCreateKeyBtn" class="btn btn-primary">Create API key</button>
            <p class="empty-state-hint">Create a key in Settings, then add it in GitDock’s config.</p>
          </div>
        </div>
      </div>
      <div id="reposView" class="view">
        <div class="repos-toolbar">
          <div class="machine-detail-search">
            <span class="search-icon"><svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor"><path d="M10.68 11.74a6 6 0 1 1 1.06-1.06l3.04 3.04a.75.75 0 1 1-1.06 1.06l-3.04-3.04ZM11.5 7a4.5 4.5 0 1 0-9 0 4.5 4.5 0 0 0 9 0Z"/></svg></span>
            <input type="text" id="allReposSearch" placeholder="Search repos..." autocomplete="off">
          </div>
          <div class="machine-detail-filters">
            <button type="button" class="fbtn on" data-allfilter="all">All</button>
            <button type="button" class="fbtn" data-allfilter="clean">Clean</button>
            <button type="button" class="fbtn" data-allfilter="dirty">Dirty</button>
            <button type="button" class="fbtn" data-allfilter="ahead">Ahead</button>
            <button type="button" class="fbtn" data-allfilter="behind">Behind</button>
          </div>
          <div class="repo-view-toggle repo-view-toggle--all">
            <button type="button" class="vbtn on" data-allview-mode="cards" title="Card layout">Cards</button>
            <button type="button" class="vbtn" data-allview-mode="list" title="List layout">List</button>
          </div>
          <span class="machine-detail-repo-count" id="allReposCount">0 repos</span>
        </div>
        <ul id="allReposList" class="repo-list repo-list--cards"></ul>
        <p id="allReposEmpty" class="repo-list-empty" style="display:none;">No repositories match the filter.</p>
      </div>
      <div id="machineDetailView" class="view">
        <div class="machine-detail-header">
          <a class="back" href="#" data-view="overview">&larr; Back to overview</a>
          <div class="machine-detail-title-row">
            <h2 id="machineDetailName">—</h2>
            <div class="machine-detail-actions">
              <button type="button" id="machineDetailRenameBtn" class="btn btn-sm">Rename</button>
              <button type="button" id="machineDetailDeleteBtn" class="btn btn-sm btn-danger">Remove machine</button>
            </div>
          </div>
          <div id="machineDetailRenameWrap" class="machine-detail-rename-wrap" style="display:none;">
            <input type="text" id="machineDetailRenameInput" placeholder="Machine name" maxlength="128">
            <button type="button" id="machineDetailRenameSave" class="btn btn-sm btn-primary">Save</button>
            <button type="button" id="machineDetailRenameCancel" class="btn btn-sm">Cancel</button>
          </div>
          <p id="machineDetailMeta" class="meta" style="color: var(--t2); font-size: 12px;"></p>
        </div>
        <div class="machine-detail-toolbar">
          <div class="machine-detail-search">
            <span class="search-icon"><svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor"><path d="M10.68 11.74a6 6 0 1 1 1.06-1.06l3.04 3.04a.75.75 0 1 1-1.06 1.06l-3.04-3.04ZM11.5 7a4.5 4.5 0 1 0-9 0 4.5 4.5 0 0 0 9 0Z"/></svg></span>
            <input type="text" id="machineDetailSearch" placeholder="Search repos..." autocomplete="off">
          </div>
          <div class="machine-detail-filters">
            <button type="button" class="fbtn on" data-filter="all">All</button>
            <button type="button" class="fbtn" data-filter="clean">Clean</button>
            <button type="button" class="fbtn" data-filter="dirty">Dirty</button>
            <button type="button" class="fbtn" data-filter="ahead">Ahead</button>
            <button type="button" class="fbtn" data-filter="behind">Behind</button>
          </div>
          <div class="repo-view-toggle">
            <button type="button" class="vbtn on" data-view-mode="cards" title="Card layout">Cards</button>
            <button type="button" class="vbtn" data-view-mode="list" title="List layout">List</button>
          </div>
          <span class="machine-detail-repo-count" id="machineDetailRepoCount">0 repos</span>
        </div>
        <ul id="machineDetailRepos" class="repo-list repo-list--cards"></ul>
        <p id="machineDetailReposEmpty" class="repo-list-empty" style="display:none;">No repositories match the filter.</p>
      </div>
      <div id="settingsView" class="view">
        <div class="page-title">API keys</div>
        <p style="color: var(--t2); font-size: 13px; margin-bottom: 16px;">Use these keys in your local GitDock <code>config.json</code> under <code>hub.apiKey</code>. Each machine can use the same key.</p>
        <ul id="keysList" class="keys-list"></ul>
        <div class="new-key-box">
          <div class="section-title">Generate new key</div>
          <input type="text" id="newKeyLabel" placeholder="Label (e.g. My devices)" maxlength="128">
          <button type="button" id="createKeyBtn" class="btn btn-primary">Create key</button>
          <div id="newKeyResult" class="new-key-result" style="display:none"></div>
        </div>
      </div>
    </main>
  </div>

  <script>
    (function() {
      var tipEl = document.getElementById('hub-tooltip');
      document.addEventListener('mouseover', function(e) {
        var t = e.target.closest('[data-tip]');
        if (t) {
          tipEl.textContent = t.getAttribute('data-tip');
          tipEl.classList.add('visible');
        } else {
          tipEl.classList.remove('visible');
        }
      });
      document.addEventListener('mousemove', function(e) {
        if (tipEl.classList.contains('visible')) {
          tipEl.style.left = Math.min(e.clientX + 12, window.innerWidth - tipEl.offsetWidth - 16) + 'px';
          tipEl.style.top = (e.clientY - tipEl.offsetHeight - 12) + 'px';
        }
      });
      document.addEventListener('mouseout', function(e) {
        if (e.target.closest && e.target.closest('[data-tip]') && !e.relatedTarget?.closest?.('[data-tip]')) {
          tipEl.classList.remove('visible');
        }
      });

      const API = '';
      var csrfToken = null;
      function apiGet(path) {
        return fetch(API + path, { credentials: 'include' }).then(function(r) {
          if (r.status === 401) throw new Error('Unauthorized');
          return r.json();
        });
      }
      function apiPost(path, body) {
        var headers = { 'Content-Type': 'application/json' };
        if (csrfToken) headers['X-CSRF-TOKEN'] = csrfToken;
        return fetch(API + path, {
          method: 'POST',
          credentials: 'include',
          headers: headers,
          body: JSON.stringify(body || {})
        }).then(function(r) {
          if (r.status === 401) throw new Error('Unauthorized');
          return r.json();
        });
      }
      function apiPatch(path, body) {
        var headers = { 'Content-Type': 'application/json' };
        if (csrfToken) headers['X-CSRF-TOKEN'] = csrfToken;
        return fetch(API + path, {
          method: 'PATCH',
          credentials: 'include',
          headers: headers,
          body: JSON.stringify(body || {})
        }).then(function(r) {
          if (r.status === 401) throw new Error('Unauthorized');
          return r.json();
        });
      }
      function apiDelete(path) {
        var headers = {};
        if (csrfToken) headers['X-CSRF-TOKEN'] = csrfToken;
        return fetch(API + path, { method: 'DELETE', credentials: 'include', headers: headers }).then(function(r) {
          if (r.status === 401) throw new Error('Unauthorized');
          return r.json();
        });
      }

      var currentView = 'overview';
      var lastUpdatedAt = null;
      var sseEventSource = null;

      function showView(name) {
        currentView = name;
        document.querySelectorAll('.view').forEach(function(v) { v.classList.remove('active'); });
        document.querySelectorAll('.top-bar a[data-view]').forEach(function(a) { a.classList.remove('nav-active'); });
        var el = document.getElementById(name + 'View');
        if (el) el.classList.add('active');
        if (name === 'overview') document.getElementById('navOverview').classList.add('nav-active');
        if (name === 'repos') document.getElementById('navRepos').classList.add('nav-active');
        if (name === 'settings') document.getElementById('navSettings').classList.add('nav-active');
        if (name === 'overview') loadOverview();
        if (name === 'repos') loadAllRepos();
        if (name === 'settings') loadKeys();
      }

      function refreshCurrentView() {
        lastUpdatedAt = Date.now();
        if (currentView === 'overview') {
          loadOverview();
          var grid = document.getElementById('machineGrid');
          if (grid) { grid.classList.add('pulse'); setTimeout(function() { grid.classList.remove('pulse'); }, 600); }
        } else if (currentView === 'machineDetail' && currentMachineDetailId) {
          openMachineDetail(currentMachineDetailId);
        } else if (currentView === 'repos') {
          loadAllRepos();
        }
      }

      function updateLastUpdatedText() {
        var el = document.getElementById('lastUpdated');
        if (!el) return;
        if (lastUpdatedAt == null) { el.textContent = ''; return; }
        var sec = Math.floor((Date.now() - lastUpdatedAt) / 1000);
        if (sec < 5) el.textContent = 'Updated just now';
        else if (sec < 60) el.textContent = 'Updated ' + sec + 's ago';
        else if (sec < 3600) el.textContent = 'Updated ' + Math.floor(sec / 60) + 'm ago';
        else el.textContent = 'Updated ' + Math.floor(sec / 3600) + 'h ago';
      }

      var lastUpdatedInterval = null;
      function checkAuth() {
        return apiGet('/api/auth/check').then(function(data) {
          if (data.ok) {
            return apiGet('/api/auth/me').then(function(me) {
              csrfToken = me.csrfToken || null;
              var emailEl = document.getElementById('userEmail');
              if (emailEl) emailEl.textContent = me.email || '';
              document.getElementById('loginView').style.display = 'none';
              document.getElementById('appView').style.display = 'block';
              showView('overview');
              lastUpdatedAt = Date.now();
              if (lastUpdatedInterval) clearInterval(lastUpdatedInterval);
              lastUpdatedInterval = setInterval(updateLastUpdatedText, 1000);
              updateLastUpdatedText();
              if (sseEventSource) try { sseEventSource.close(); } catch (e) {}
              sseEventSource = new EventSource(API + '/api/events');
              sseEventSource.addEventListener('snapshot_updated', function() { refreshCurrentView(); });
            });
          } else {
            csrfToken = null;
            if (sseEventSource) try { sseEventSource.close(); } catch (e) {}
            sseEventSource = null;
            if (lastUpdatedInterval) clearInterval(lastUpdatedInterval);
            lastUpdatedInterval = null;
            document.getElementById('loginView').style.display = 'flex';
            document.getElementById('appView').style.display = 'none';
          }
        }).catch(function() {
          csrfToken = null;
          document.getElementById('loginView').style.display = 'flex';
          document.getElementById('appView').style.display = 'none';
        });
      }

      document.querySelectorAll('.pw-toggle').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var wrap = btn.closest('.pw-wrap');
          var inp = wrap.querySelector('input');
          var isHidden = inp.type === 'password';
          inp.type = isHidden ? 'text' : 'password';
          btn.querySelector('.eye-show').style.display = isHidden ? 'none' : '';
          btn.querySelector('.eye-hide').style.display = isHidden ? '' : 'none';
        });
      });

      document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var email = document.getElementById('loginEmail').value.trim();
        var pw = document.getElementById('loginPassword').value;
        var errEl = document.getElementById('loginError');
        errEl.style.display = 'none';
        apiPost('/api/auth/login', { email: email, password: pw }).then(function(data) {
          if (data.success) checkAuth();
          else { errEl.textContent = data.error || 'Login failed'; errEl.style.display = 'block'; }
        }).catch(function(err) {
          errEl.textContent = err.message || 'Request failed';
          errEl.style.display = 'block';
        });
      });

      document.getElementById('showRegister').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('registerBox').style.display = 'block';
        document.getElementById('registerError').style.display = 'none';
      });
      document.getElementById('showLogin').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('registerBox').style.display = 'none';
        document.getElementById('loginBox').style.display = 'block';
        document.getElementById('loginError').style.display = 'none';
      });

      document.getElementById('registerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var email = document.getElementById('registerEmail').value.trim();
        var pw = document.getElementById('registerPassword').value;
        var confirmPw = document.getElementById('registerConfirm').value;
        var errEl = document.getElementById('registerError');
        errEl.style.display = 'none';
        if (pw !== confirmPw) {
          errEl.textContent = 'Passwords do not match';
          errEl.style.display = 'block';
          return;
        }
        apiPost('/api/auth/register', { email: email, password: pw }).then(function(data) {
          if (data.success) checkAuth();
          else { errEl.textContent = data.error || 'Registration failed'; errEl.style.display = 'block'; }
        }).catch(function(err) {
          errEl.textContent = err.message || 'Request failed';
          errEl.style.display = 'block';
        });
      });

      document.getElementById('logoutBtn').addEventListener('click', function() {
        apiPost('/api/auth/logout').then(function() { checkAuth(); });
      });

      document.querySelectorAll('[data-view]').forEach(function(a) {
        a.addEventListener('click', function(e) {
          e.preventDefault();
          var v = this.getAttribute('data-view');
          if (v) showView(v);
        });
      });
      document.getElementById('emptyStateCreateKeyBtn').addEventListener('click', function() { showView('settings'); });

      var STALE_MS = 60 * 60 * 1000;
      function loadOverview() {
        Promise.all([apiGet('/api/sync'), apiGet('/api/machines')]).then(function(results) {
          var issues = results[0].issues || [];
          var machines = results[1].machines || [];
          var totalRepos = machines.reduce(function(s, m) { return s + (m.repo_count || 0); }, 0);
          var totalAttention = machines.reduce(function(s, m) { return s + (m.issue_count || 0); }, 0);
          var totalClean = totalRepos - totalAttention;
          var now = Date.now();
          var onlineCount = machines.filter(function(m) {
            var t = m.last_seen ? new Date(m.last_seen).getTime() : 0;
            return (now - t) <= STALE_MS;
          }).length;
          var staleCount = machines.length - onlineCount;
          document.getElementById('statMachines').textContent = machines.length;
          document.getElementById('statMachinesMeta').textContent = machines.length ? (onlineCount + ' online' + (staleCount ? ', ' + staleCount + ' stale' : '')) : '—';
          document.getElementById('statRepos').textContent = totalRepos;
          document.getElementById('statClean').textContent = totalClean;
          document.getElementById('statAttention').textContent = totalAttention;
          var issuesEl = document.getElementById('issuesList');
          var noIssues = document.getElementById('noIssues');
          var issuesCountEl = document.getElementById('issuesCount');
          if (issuesCountEl) issuesCountEl.textContent = issues.length;
          issuesEl.innerHTML = '';
          if (issues.length === 0) {
            noIssues.style.display = 'block';
          } else {
            noIssues.style.display = 'none';
            issues.forEach(function(i) {
              var li = document.createElement('li');
              li.className = 'issue-item ' + (i.type || '');
              li.innerHTML = '<span class="issue-type">' + (i.type || '').replace(/_/g, ' ') + '</span><span class="issue-msg">' + (i.message || '') + '</span>';
              issuesEl.appendChild(li);
            });
          }
          var grid = document.getElementById('machineGrid');
          var noMachines = document.getElementById('noMachines');
          var emptyOnboarding = document.getElementById('emptyStateOnboarding');
          var machinesCountEl = document.getElementById('machinesCount');
          if (machinesCountEl) machinesCountEl.textContent = machines.length;
          grid.innerHTML = '';
          if (machines.length === 0) {
            noMachines.style.display = 'none';
            if (emptyOnboarding) emptyOnboarding.style.display = 'block';
            grid.style.display = 'none';
          } else {
            if (emptyOnboarding) emptyOnboarding.style.display = 'none';
            grid.style.display = '';
            noMachines.style.display = 'none';
            machines.forEach(function(m) {
              var card = document.createElement('div');
              card.className = 'machine-card';
              card.dataset.id = m.id;
              var lastSeen = m.last_seen ? new Date(m.last_seen).toLocaleString() : '—';
              card.innerHTML = '<h3>' + escapeHtml(m.name || m.id) + '</h3>' +
                '<div class="meta">' + escapeHtml(m.platform || '') + ' &middot; Last seen: ' + escapeHtml(lastSeen) + '</div>' +
                '<div class="stats"><span>' + (m.repo_count || 0) + ' repos</span><span class="issues ' + (m.issue_count > 0 ? '' : 'zero') + '">' + (m.issue_count || 0) + ' issues</span></div>';
              card.addEventListener('click', function() { openMachineDetail(m.id); });
              grid.appendChild(card);
            });
          }
        }).catch(function() { checkAuth(); });
      }

      var machineDetailRepos = [];
      var machineDetailFilter = 'all';
      var machineDetailViewMode = 'cards';
      var currentMachineDetailId = null;
      var allReposData = [];
      var allReposFilter = 'all';
      var allReposViewMode = 'cards';

      function buildRepoData(r) {
        var status = r.localStatus || 'clean';
        var ahead = r.ahead || 0;
        var behind = r.behind || 0;
        var lc = r.lastCommit || {};
        var msgFull = (lc.message || '').trim();
        var msg = msgFull.length > 60 ? msgFull.slice(0, 57) + '...' : msgFull;
        var timeAgo = lc.timeAgo || '';
        var author = lc.author || '';
        var absoluteDate = lc.date || '';
        var summary = r.summary || {};
        var staged = summary.stagedCount || 0;
        var unstaged = summary.unstagedCount || 0;
        var untracked = summary.untrackedCount || 0;
        var conflict = summary.conflictCount || 0;
        var dirtyParts = [];
        if (staged) dirtyParts.push(staged + ' staged');
        if (unstaged) dirtyParts.push(unstaged + ' unstaged');
        if (untracked) dirtyParts.push(untracked + ' untracked');
        if (conflict) dirtyParts.push(conflict + ' conflict(s)');
        var dirtyDetailsAlways = staged || unstaged || untracked || conflict ? dirtyParts.join(', ') : '0 staged, 0 unstaged, 0 untracked';
        var dirtyLine = dirtyParts.length ? '<div class="summary-dirty">' + escapeHtml(dirtyParts.join(', ')) + '</div>' : '<div class="summary-dirty summary-dirty--clean">' + escapeHtml(dirtyDetailsAlways) + '</div>';
        var dirtyText = dirtyParts.join(', ') || dirtyDetailsAlways;
        var aheadBehind = '';
        if (ahead > 0 || behind > 0) {
          aheadBehind = '<span class="ahead-behind">';
          if (ahead > 0) aheadBehind += '<span class="ahead-n">' + ahead + ' ahead</span> ';
          if (behind > 0) aheadBehind += '<span class="behind-n">' + behind + ' behind</span>';
          aheadBehind += '</span>';
        }
        var totalAb = ahead + behind;
        var aheadPct = totalAb > 0 ? Math.round((ahead / totalAb) * 100) : 0;
        var behindPct = totalAb > 0 ? Math.round((behind / totalAb) * 100) : 0;
        var aheadBehindBar = (ahead > 0 || behind > 0) ? '<div class="ahead-behind-bar" title="' + ahead + ' ahead, ' + behind + ' behind"><div class="ahead-behind-bar-seg ahead-seg" style="width:' + aheadPct + '%"></div><div class="ahead-behind-bar-seg behind-seg" style="width:' + behindPct + '%"></div></div>' : '';
        var needsAttention = status !== 'clean' || ahead > 0 || behind > 0;
        return { status, ahead, behind, msg, msgFull, timeAgo, author, absoluteDate, dirtyLine, dirtyText, dirtyDetailsAlways, aheadBehind, aheadBehindBar, needsAttention, staged, unstaged, untracked, conflict };
      }

      function buildStatHtml(label, abbr, value, cls) {
        var hot = value > 0 ? ' rc-stat--hot' : '';
        return '<span class="rc-stat rc-stat--' + cls + hot + '" title="' + label + '">' +
          '<span class="rc-stat-lbl">' + abbr + '</span>' +
          '<span class="rc-stat-val">' + value + '</span></span>';
      }

      function buildCardDetailHtml(r, d, showMachine) {
        var html = '<div class="rc-detail"><div class="rc-detail-inner">';
        if (d.msg || d.author) {
          html += '<div class="rc-detail-section"><div class="rc-detail-lbl">Last commit</div>' +
            (d.msg ? '<div class="rc-detail-msg"' + (d.msgFull !== d.msg ? ' data-tip="' + escapeHtml(d.msgFull) + '"' : '') + '>' + escapeHtml(d.msg) + '</div>' : '') +
            (d.author ? '<div class="rc-detail-meta">by ' + escapeHtml(d.author) + (d.absoluteDate ? ' \u00b7 ' + escapeHtml(d.absoluteDate) : '') + '</div>' : '') +
            '</div>';
        }
        if (d.ahead > 0 || d.behind > 0) {
          var total = d.ahead + d.behind;
          var aPct = Math.round((d.ahead / total) * 100);
          html += '<div class="rc-detail-section"><div class="rc-detail-lbl">Sync</div>' +
            '<div class="rc-detail-bar"><div class="rc-detail-bar-seg seg-ahead" style="width:' + aPct + '%"></div>' +
            '<div class="rc-detail-bar-seg seg-behind" style="width:' + (100 - aPct) + '%"></div></div></div>';
        }
        var pills = '<span class="rc-detail-pill">' + escapeHtml(r.account || '') + '</span>';
        if (showMachine) pills += '<span class="rc-detail-pill">\uD83D\uDCBB ' + escapeHtml(r.machineName || r.machineId || '') + '</span>';
        html += '<div class="rc-detail-section"><div class="rc-detail-pills">' + pills + '</div></div>';
        html += '</div></div>';
        return html;
      }

      function renderMachineDetailRepos() {
        var search = (document.getElementById('machineDetailSearch').value || '').trim().toLowerCase();
        var list = document.getElementById('machineDetailRepos');
        var emptyEl = document.getElementById('machineDetailReposEmpty');
        var countEl = document.getElementById('machineDetailRepoCount');
        var filtered = machineDetailRepos.filter(function(r) {
          var name = (r.name || '').toLowerCase();
          var account = (r.account || '').toLowerCase();
          var matchSearch = !search || name.indexOf(search) !== -1 || account.indexOf(search) !== -1;
          var matchFilter = true;
          if (machineDetailFilter === 'clean') matchFilter = r.localStatus === 'clean';
          else if (machineDetailFilter === 'dirty') matchFilter = r.localStatus === 'dirty';
          else if (machineDetailFilter === 'ahead') matchFilter = (r.ahead || 0) > 0;
          else if (machineDetailFilter === 'behind') matchFilter = (r.behind || 0) > 0;
          return matchSearch && matchFilter;
        });
        list.innerHTML = '';
        list.className = 'repo-list repo-list--' + machineDetailViewMode;
        if (countEl) countEl.textContent = filtered.length + ' of ' + machineDetailRepos.length + ' repos';
        if (filtered.length === 0) {
          emptyEl.style.display = 'block';
          emptyEl.textContent = machineDetailRepos.length === 0 ? 'No repositories reported for this machine.' : 'No repositories match the filter.';
          return;
        }
        emptyEl.style.display = 'none';
        filtered.forEach(function(r) {
          var d = buildRepoData(r);
          var status = d.status, ahead = d.ahead, behind = d.behind, msg = d.msg, timeAgo = d.timeAgo, author = d.author, absoluteDate = d.absoluteDate, dirtyLine = d.dirtyLine, dirtyText = d.dirtyText, aheadBehind = d.aheadBehind, aheadBehindBar = d.aheadBehindBar, needsAttention = d.needsAttention;
          var dateTitle = absoluteDate ? ' title="' + escapeHtml(absoluteDate) + '"' : '';
          if (machineDetailViewMode === 'cards') {
            var card = document.createElement('li');
            card.className = 'repo-card ' + (needsAttention ? 'rc--attention' : 'rc--clean');
            var counters = buildStatHtml('Staged', 'S', d.staged, 'staged') +
              buildStatHtml('Modified', 'M', d.unstaged, 'modified') +
              buildStatHtml('Untracked', '?', d.untracked, 'untracked') +
              buildStatHtml('Conflicts', '!', d.conflict, 'conflict');
            var syncHtml = '';
            if (ahead > 0 || behind > 0) {
              syncHtml = '<div class="rc-sync">';
              if (ahead > 0) syncHtml += '<span class="rc-sync-item rc-sync--ahead"><span class="arrow">\u2191</span><span class="num">' + ahead + '</span> ahead</span>';
              if (behind > 0) syncHtml += '<span class="rc-sync-item rc-sync--behind"><span class="arrow">\u2193</span><span class="num">' + behind + '</span> behind</span>';
              syncHtml += '</div>';
            }
            card.innerHTML =
              '<div class="rc-front">' +
                '<div class="rc-header">' +
                  '<span class="rc-dot rc-dot--' + status + '"></span>' +
                  '<span class="rc-name">' + escapeHtml(r.name) + '</span>' +
                  '<span class="rc-branch">' + escapeHtml(r.branch || '\u2014') + '</span>' +
                  '<span class="rc-chevron">\u25B8</span>' +
                '</div>' +
                '<div class="rc-subrow">' +
                  (timeAgo ? '<span class="rc-time"' + dateTitle + '>' + escapeHtml(timeAgo) + '</span>' : '') +
                '</div>' +
                '<div class="rc-stats">' +
                  '<div class="rc-counters">' + counters + '</div>' +
                  '<span class="rc-badge rc-badge--' + status + '">' + status + '</span>' +
                '</div>' +
                syncHtml +
              '</div>' +
              buildCardDetailHtml(r, d, false);
            card.addEventListener('click', function() { card.classList.toggle('rc-expanded'); });
            list.appendChild(card);
          } else {
            var row = document.createElement('li');
            row.className = 'repo-row' + (needsAttention ? ' repo-row-needs-attention' : '');
            row.innerHTML =
              '<div class="repo-row-top">' +
                '<span class="name">' + escapeHtml(r.name) + '</span>' +
                '<span class="account-pill">' + escapeHtml(r.account || '') + '</span>' +
                '<span class="branch">' + escapeHtml(r.branch || '—') + '</span>' +
                (aheadBehind || '<span class="ahead-behind"></span>') +
                '<span class="badge ' + status + '">' + status + '</span>' +
              '</div>' +
              (author ? '<div class="repo-row-meta"><span class="repo-row-author">' + escapeHtml(author) + '</span></div>' : '') +
              (msg || timeAgo || dirtyLine ? '<div class="repo-row-meta">' + (msg || timeAgo ? '<span class="last-commit">' + escapeHtml(msg) + (timeAgo ? ' <span' + dateTitle + '>\u2022 ' + escapeHtml(timeAgo) + '</span>' : '') + '</span>' : '') + (dirtyLine ? dirtyLine : '') + '</div>' : '');
            list.appendChild(row);
          }
        });
      }

      function repoKey(r) {
        return (r.path || r.name || '') + '|' + (r.account || '');
      }

      function loadAllRepos() {
        apiGet('/api/repos').then(function(data) {
          var raw = data.repos || [];
          var keyToMachines = {};
          raw.forEach(function(r) {
            var k = repoKey(r);
            if (!keyToMachines[k]) keyToMachines[k] = [];
            if (keyToMachines[k].indexOf(r.machineId) === -1) keyToMachines[k].push(r.machineId);
          });
          allReposData = raw.map(function(r) {
            var k = repoKey(r);
            var machines = keyToMachines[k] || [];
            return Object.assign({}, r, { multiMachineCount: machines.length });
          });
          renderAllRepos();
        }).catch(function() { checkAuth(); });
      }

      function renderAllRepos() {
        var search = (document.getElementById('allReposSearch').value || '').trim().toLowerCase();
        var list = document.getElementById('allReposList');
        var emptyEl = document.getElementById('allReposEmpty');
        var countEl = document.getElementById('allReposCount');
        var filtered = allReposData.filter(function(r) {
          var name = (r.name || '').toLowerCase();
          var account = (r.account || '').toLowerCase();
          var machineName = (r.machineName || '').toLowerCase();
          var matchSearch = !search || name.indexOf(search) !== -1 || account.indexOf(search) !== -1 || machineName.indexOf(search) !== -1;
          var matchFilter = true;
          if (allReposFilter === 'clean') matchFilter = r.localStatus === 'clean';
          else if (allReposFilter === 'dirty') matchFilter = r.localStatus === 'dirty';
          else if (allReposFilter === 'ahead') matchFilter = (r.ahead || 0) > 0;
          else if (allReposFilter === 'behind') matchFilter = (r.behind || 0) > 0;
          return matchSearch && matchFilter;
        });
        list.innerHTML = '';
        list.className = 'repo-list repo-list--' + allReposViewMode;
        if (countEl) countEl.textContent = filtered.length + ' of ' + allReposData.length + ' repos';
        if (filtered.length === 0) {
          emptyEl.style.display = 'block';
          emptyEl.textContent = allReposData.length === 0 ? 'No repositories reported from any machine.' : 'No repositories match the filter.';
          return;
        }
        emptyEl.style.display = 'none';
        var keyToRepos = {};
        allReposData.forEach(function(x) {
          var k = repoKey(x);
          if (!keyToRepos[k]) keyToRepos[k] = [];
          keyToRepos[k].push(x);
        });
        filtered.forEach(function(r) {
          var d = buildRepoData(r);
          var status = d.status, ahead = d.ahead, behind = d.behind, msg = d.msg, timeAgo = d.timeAgo, author = d.author, absoluteDate = d.absoluteDate, dirtyLine = d.dirtyLine, dirtyText = d.dirtyText, aheadBehind = d.aheadBehind, aheadBehindBar = d.aheadBehindBar, needsAttention = d.needsAttention;
          var dateTitle = absoluteDate ? ' title="' + escapeHtml(absoluteDate) + '"' : '';
          var sameKeyRepos = keyToRepos[repoKey(r)] || [];
          var statusPerMachine = (r.multiMachineCount > 1 && sameKeyRepos.length > 1) ? sameKeyRepos.map(function(x) { return escapeHtml(x.machineName || '') + ': ' + (x.localStatus || 'clean'); }).join(', ') : '';
          if (allReposViewMode === 'cards') {
            var card = document.createElement('li');
            card.className = 'repo-card ' + (needsAttention ? 'rc--attention' : 'rc--clean');
            var counters = buildStatHtml('Staged', 'S', d.staged, 'staged') +
              buildStatHtml('Modified', 'M', d.unstaged, 'modified') +
              buildStatHtml('Untracked', '?', d.untracked, 'untracked') +
              buildStatHtml('Conflicts', '!', d.conflict, 'conflict');
            var syncHtml = '';
            if (ahead > 0 || behind > 0) {
              syncHtml = '<div class="rc-sync">';
              if (ahead > 0) syncHtml += '<span class="rc-sync-item rc-sync--ahead"><span class="arrow">\u2191</span><span class="num">' + ahead + '</span> ahead</span>';
              if (behind > 0) syncHtml += '<span class="rc-sync-item rc-sync--behind"><span class="arrow">\u2193</span><span class="num">' + behind + '</span> behind</span>';
              syncHtml += '</div>';
            }
            card.innerHTML =
              '<div class="rc-front">' +
                '<div class="rc-header">' +
                  '<span class="rc-dot rc-dot--' + status + '"></span>' +
                  '<span class="rc-name">' + escapeHtml(r.name) + '</span>' +
                  '<span class="rc-branch">' + escapeHtml(r.branch || '\u2014') + '</span>' +
                  '<span class="rc-chevron">\u25B8</span>' +
                '</div>' +
                '<div class="rc-subrow">' +
                  (timeAgo ? '<span class="rc-time"' + dateTitle + '>' + escapeHtml(timeAgo) + '</span>' : '') +
                  '<span class="rc-machine-badge">' + escapeHtml(r.machineName || r.machineId || '') + '</span>' +
                  (r.multiMachineCount > 1 ? '<span class="rc-multimachine">on ' + r.multiMachineCount + ' machines</span>' : '') +
                '</div>' +
                '<div class="rc-stats">' +
                  '<div class="rc-counters">' + counters + '</div>' +
                  '<span class="rc-badge rc-badge--' + status + '">' + status + '</span>' +
                '</div>' +
                syncHtml +
              '</div>' +
              buildCardDetailHtml(r, d, true);
            card.addEventListener('click', function() { card.classList.toggle('rc-expanded'); });
            list.appendChild(card);
          } else {
            var row = document.createElement('li');
            row.className = 'repo-row' + (needsAttention ? ' repo-row-needs-attention' : '');
            row.innerHTML =
              '<div class="repo-row-top">' +
                '<span class="name">' + escapeHtml(r.name) + '</span>' +
                '<span class="account-pill">' + escapeHtml(r.account || '') + '</span>' +
                '<span class="branch">' + escapeHtml(r.branch || '—') + '</span>' +
                '<span class="machine-badge">' + escapeHtml(r.machineName || '') + '</span>' +
                (aheadBehind || '<span class="ahead-behind"></span>') +
                '<span class="badge ' + status + '">' + status + '</span>' +
              '</div>' +
              (author ? '<div class="repo-row-meta"><span class="repo-row-author">' + escapeHtml(author) + '</span></div>' : '') +
              (msg || timeAgo || dirtyLine ? '<div class="repo-row-meta">' + (msg || timeAgo ? '<span class="last-commit">' + escapeHtml(msg) + (timeAgo ? ' <span' + dateTitle + '>\u2022 ' + escapeHtml(timeAgo) + '</span>' : '') + '</span>' : '') + (dirtyLine ? dirtyLine : '') + '</div>' : '');
            list.appendChild(row);
          }
        });
      }

      function openMachineDetail(id) {
        currentMachineDetailId = id;
        document.getElementById('machineDetailRenameWrap').style.display = 'none';
        showView('machineDetail');
        document.getElementById('machineDetailSearch').value = '';
        document.querySelectorAll('.machine-detail-filters .fbtn').forEach(function(b) { b.classList.toggle('on', b.getAttribute('data-filter') === 'all'); });
        machineDetailFilter = 'all';
        apiGet('/api/machines/' + encodeURIComponent(id)).then(function(data) {
          var m = data.machine;
          var snap = data.snapshot;
          document.getElementById('machineDetailName').textContent = m.name || m.id;
          document.getElementById('machineDetailMeta').textContent = (m.platform || '') + ' \u2022 Last seen: ' + (data.received_at ? new Date(data.received_at).toLocaleString() : '—');
          machineDetailRepos = (snap && snap.repos) ? snap.repos : [];
          renderMachineDetailRepos();
        });
      }

      document.getElementById('machineDetailSearch').addEventListener('input', function() { renderMachineDetailRepos(); });
      document.querySelectorAll('.machine-detail-filters .fbtn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.machine-detail-filters .fbtn').forEach(function(b) { b.classList.toggle('on', b === btn); });
          machineDetailFilter = this.getAttribute('data-filter') || 'all';
          renderMachineDetailRepos();
        });
      });
      document.querySelectorAll('.repo-view-toggle .vbtn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var mode = this.getAttribute('data-view-mode') || 'cards';
          document.querySelectorAll('.repo-view-toggle .vbtn').forEach(function(b) { b.classList.toggle('on', b === btn); });
          machineDetailViewMode = mode;
          renderMachineDetailRepos();
        });
      });

      document.getElementById('machineDetailRenameBtn').addEventListener('click', function() {
        var nameEl = document.getElementById('machineDetailName');
        var wrap = document.getElementById('machineDetailRenameWrap');
        var input = document.getElementById('machineDetailRenameInput');
        input.value = nameEl.textContent.trim() || '';
        wrap.style.display = 'flex';
        input.focus();
      });
      document.getElementById('machineDetailRenameCancel').addEventListener('click', function() {
        document.getElementById('machineDetailRenameWrap').style.display = 'none';
      });
      document.getElementById('machineDetailRenameSave').addEventListener('click', function() {
        var name = document.getElementById('machineDetailRenameInput').value.trim();
        if (!name) return;
        if (!currentMachineDetailId) return;
        apiPatch('/api/machines/' + encodeURIComponent(currentMachineDetailId), { name: name }).then(function(res) {
          if (res.success && res.name) {
            document.getElementById('machineDetailName').textContent = res.name;
            document.getElementById('machineDetailRenameWrap').style.display = 'none';
            loadOverview();
          }
        }).catch(function() {});
      });
      document.getElementById('machineDetailDeleteBtn').addEventListener('click', function() {
        if (!currentMachineDetailId) return;
        if (!confirm('Are you sure? This removes the machine from Hub.')) return;
        apiDelete('/api/machines/' + encodeURIComponent(currentMachineDetailId)).then(function() {
          currentMachineDetailId = null;
          showView('overview');
          loadOverview();
        }).catch(function() {});
      });

      document.getElementById('allReposSearch').addEventListener('input', function() { renderAllRepos(); });
      document.querySelectorAll('[data-allfilter]').forEach(function(btn) {
        btn.addEventListener('click', function() {
          document.querySelectorAll('[data-allfilter]').forEach(function(b) { b.classList.toggle('on', b === btn); });
          allReposFilter = this.getAttribute('data-allfilter') || 'all';
          renderAllRepos();
        });
      });
      document.querySelectorAll('.repo-view-toggle--all .vbtn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var mode = this.getAttribute('data-allview-mode') || 'cards';
          document.querySelectorAll('.repo-view-toggle--all .vbtn').forEach(function(b) { b.classList.toggle('on', b === btn); });
          allReposViewMode = mode;
          renderAllRepos();
        });
      });

      function loadKeys() {
        apiGet('/api/keys').then(function(data) {
          var keys = data.keys || [];
          var list = document.getElementById('keysList');
          list.innerHTML = '';
          keys.forEach(function(k) {
            var li = document.createElement('li');
            li.className = 'key-row';
            li.innerHTML = '<div><span class="label">' + escapeHtml(k.label) + '</span><div class="meta">Created ' + (k.created_at || '') + (k.last_seen ? ' \u2022 Last seen: ' + k.last_seen : '') + '</div></div>' +
              '<button type="button" class="btn btn-sm btn-danger" data-id="' + escapeHtml(k.id) + '">Revoke</button>';
            li.querySelector('button').addEventListener('click', function() {
              if (confirm('Revoke this key? Agents using it will no longer be able to send snapshots.')) {
                apiDelete('/api/keys/' + encodeURIComponent(k.id)).then(function() { loadKeys(); });
              }
            });
            list.appendChild(li);
          });
        }).catch(function() { checkAuth(); });
      }

      document.getElementById('createKeyBtn').addEventListener('click', function() {
        var label = document.getElementById('newKeyLabel').value.trim() || 'Default';
        apiPost('/api/keys', { label: label }).then(function(data) {
          var result = document.getElementById('newKeyResult');
          result.style.display = 'block';
          result.innerHTML = 'New API key (copy now \u2014 it won\'t be shown again):<br><code>' + escapeHtml(data.key) + '</code><br><button type="button" class="copy-btn">Copy</button>';
          result.querySelector('.copy-btn').addEventListener('click', function() {
            navigator.clipboard.writeText(data.key);
            this.textContent = 'Copied';
          });
          document.getElementById('newKeyLabel').value = '';
        });
      });

      function escapeHtml(s) {
        if (s == null) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      checkAuth();
    })();
  </script>
</body>
</html>
