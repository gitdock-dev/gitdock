<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitDock</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
/* ============================================
   GitDock 2.0 — Premium Developer Dashboard
   ============================================ */

:root {
  --bg0: #08090a;
  --bg1: #111318;
  --bg2: #1a1d24;
  --bg3: #282c37;
  --border: rgba(255,255,255,0.06);
  --border-active: rgba(255,255,255,0.13);
  --t1: #e2e4e9;
  --t2: #8c90a0;
  --t3: #585c6d;
  --blue: #3b82f6;
  --green: #22c55e;
  --yellow: #eab308;
  --red: #ef4444;
  --purple: #a78bfa;
  --orange: #f97316;
  --cyan: #22d3ee;
  --r: 10px;
  --tr: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  --mono: 'JetBrains Mono', 'Cascadia Code', 'Fira Code', monospace;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
  --shadow-glow: 0 0 20px rgba(59,130,246,0.12), 0 0 60px rgba(59,130,246,0.04);
}

/* ---- Reset & Base ---- */
* { margin: 0; padding: 0; box-sizing: border-box }
html { height: 100% }
body {
  font-family: var(--font);
  background: var(--bg0);
  color: var(--t1);
  line-height: 1.6;
  height: 100%;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ---- Custom Scrollbars ---- */
::-webkit-scrollbar { width: 5px; height: 5px }
::-webkit-scrollbar-track { background: transparent }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 4px }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.14) }

/* ============================================
   TOP BAR
   ============================================ */
.app-top {
  flex-shrink: 0;
  background: rgba(17,19,24,0.8);
  backdrop-filter: blur(24px) saturate(180%);
  -webkit-backdrop-filter: blur(24px) saturate(180%);
  border-bottom: 1px solid var(--border);
  padding: 0 20px;
  height: 52px;
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  position: relative;
}
.app-top::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent 5%, rgba(59,130,246,0.35) 30%, rgba(167,139,250,0.3) 50%, rgba(34,211,238,0.25) 70%, transparent 95%);
}
.app-top-left { display: flex; align-items: center; gap: 12px }
.app-top-actions { display: flex; align-items: center; gap: 10px }
.logo {
  width: 36px; height: 36px; border-radius: 8px;
  overflow: hidden; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 0 16px rgba(59,130,246,0.2);
  transition: var(--tr);
}
.logo:hover { box-shadow: 0 0 24px rgba(59,130,246,0.35), 0 0 48px rgba(59,130,246,0.1) }
.logo img {
  width: 100%; height: 100%; object-fit: cover; display: block;
  transform: scale(1.25); transform-origin: center;
}
.app-title { font-size: 15px; font-weight: 700; letter-spacing: -0.02em }
.app-sub { font-size: 11px; color: var(--t3); margin-left: 8px; font-weight: 400 }

/* ---- Config Bar ---- */
.config-bar {
  background: rgba(17,19,24,0.65);
  border-bottom: 1px solid var(--border);
  padding: 5px 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  font-size: 11px;
}
.config-bar .config-trigger {
  padding: 4px 10px; border-radius: 6px;
  border: 1px solid var(--border); background: transparent;
  color: var(--t2); cursor: pointer;
  display: inline-flex; align-items: center; gap: 4px;
  font-size: 11px; font-family: var(--font);
  transition: var(--tr);
}
.config-bar .config-trigger:hover { border-color: var(--border-active); color: var(--t1) }
.config-bar .config-trigger::after { content: ''; border: 3px solid transparent; border-top-color: currentColor; margin-left: 4px }
.config-bar .config-drop-wrap { position: relative; display: inline-block }
.config-bar .config-drop {
  position: absolute; top: calc(100% + 6px); left: 50%; transform: translateX(-50%);
  min-width: 180px;
  background: rgba(26,29,36,0.95);
  border: 1px solid var(--border-active);
  border-radius: 12px;
  box-shadow: var(--shadow-lg), 0 0 0 1px rgba(255,255,255,0.03);
  z-index: 200; padding: 10px; display: none;
  backdrop-filter: blur(24px);
}
.config-bar .config-drop.open { display: block; animation: dropIn .15s ease }
@keyframes dropIn {
  from { opacity: 0; transform: translateX(-50%) translateY(-6px) }
  to { opacity: 1; transform: translateX(-50%) translateY(0) }
}
.config-bar .config-drop .config-drop-title {
  font-size: 9px; text-transform: uppercase; letter-spacing: .8px;
  color: var(--t3); margin-bottom: 6px; padding: 0 4px; font-weight: 600;
}
.config-bar .config-drop .config-row { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px }
.config-bar .config-drop .config-row:last-child { margin-bottom: 0 }
.config-bar .config-drop .config-btn {
  padding: 4px 10px; border-radius: 6px;
  border: 1px solid var(--border); background: transparent;
  color: var(--t2); font-size: 11px; font-family: var(--font);
  cursor: pointer; transition: var(--tr);
}
.config-bar .config-drop .config-btn:hover { border-color: rgba(59,130,246,0.4); color: var(--t1) }
.config-bar .config-drop .config-btn.on {
  background: rgba(59,130,246,0.15); border-color: rgba(59,130,246,0.35);
  color: var(--blue); font-weight: 600;
}
.config-bar .config-drop .config-check {
  display: flex; align-items: center; gap: 6px;
  padding: 4px 4px; cursor: pointer; color: var(--t2); font-size: 11px;
  border-radius: 4px; transition: var(--tr);
}
.config-bar .config-drop .config-check:hover { color: var(--t1) }
.config-bar .config-drop .config-check input { width: 14px; height: 14px; accent-color: var(--blue); border-radius: 3px }

/* ---- Status Dot ---- */
.status-dot-live { width: 7px; height: 7px; border-radius: 50%; display: inline-block; margin-right: 5px }
.dot-ok { background: var(--green); box-shadow: 0 0 8px var(--green), 0 0 16px rgba(34,197,94,0.2) }
.dot-off { background: var(--red); box-shadow: 0 0 8px rgba(239,68,68,0.4) }

/* ============================================
   APP BODY LAYOUT
   ============================================ */
.app-body { display: flex; flex: 1; min-height: 0; overflow: hidden }

/* ---- Sidebar ---- */
.sidebar {
  width: 264px; flex-shrink: 0;
  background: rgba(17,19,24,0.7);
  backdrop-filter: blur(12px);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column; overflow: hidden;
}
.sidebar-stats {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  background: rgba(255,255,255,0.01);
}
.sidebar-stats-line {
  font-size: 12px; color: var(--t2);
  display: flex; flex-wrap: wrap; gap: 8px 16px; align-items: center;
}
.sidebar-stats-line strong { color: var(--t1); font-weight: 700 }
.sidebar-stats-line .n-total { color: var(--blue) }
.sidebar-stats-line .n-cloned { color: var(--green) }
.sidebar-stats-line .n-dirty { color: var(--red) }

/* ---- Attention Panel ---- */
.sidebar-attention {
  padding: 10px 16px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  background: rgba(239,68,68,0.02);
}
.attention-title {
  font-size: 10px; text-transform: uppercase; letter-spacing: .5px;
  color: var(--red); font-weight: 700; margin-bottom: 6px;
  display: flex; align-items: center; gap: 6px;
}
.attention-list { list-style: none; padding: 0; margin: 0; max-height: 120px; overflow-y: auto }
.attention-item {
  display: flex; align-items: center; gap: 6px;
  padding: 4px 8px; font-size: 11px;
  cursor: pointer; color: var(--t2);
  transition: var(--tr); border-radius: 6px; margin-bottom: 1px;
}
.attention-item:hover { color: var(--t1); background: rgba(255,255,255,0.03) }
.attention-item .sdot { flex-shrink: 0 }
.attention-item .att-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap }
.attention-item .att-status { font-size: 10px; color: var(--t3); flex-shrink: 0 }

/* ---- Search ---- */
.sidebar-search { padding: 10px 16px; flex-shrink: 0 }
.sidebar-search .search { position: relative; width: 100%; min-width: 0 }
.sidebar-search .search input {
  width: 100%; padding: 8px 26px 8px 32px;
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 10px; color: var(--t1);
  font-size: 12px; font-family: var(--font);
  outline: none; transition: var(--tr);
}
.sidebar-search .search input:focus {
  border-color: rgba(59,130,246,0.5);
  box-shadow: 0 0 0 3px rgba(59,130,246,0.08), var(--shadow-glow);
}
.sidebar-search .search input::placeholder { color: var(--t3) }
.sidebar-search .search-icon {
  position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
  color: var(--t3); font-size: 12px; pointer-events: none;
}
.search-clear {
  position: absolute; right: 6px; top: 50%; transform: translateY(-50%);
  background: none; border: none; color: var(--t3); cursor: pointer;
  padding: 2px 5px; font-size: 13px; line-height: 1;
  border-radius: 4px; display: none; transition: var(--tr);
}
.search-clear:hover { color: var(--t1); background: var(--bg3) }
.search-clear.visible { display: block }

/* ---- Filters ---- */
.sidebar-filters {
  padding: 10px 16px 14px; flex-shrink: 0;
  border-bottom: 1px solid var(--border);
}
.sidebar-filters .filter-group { margin-bottom: 10px }
.sidebar-filters .filter-group:last-child { margin-bottom: 0 }
.sidebar-filters .filter-label {
  font-size: 9px; color: var(--t3); text-transform: uppercase;
  letter-spacing: .7px; margin-bottom: 5px; display: block;
  font-weight: 600;
}
.sidebar-filters .filter-btns { display: flex; flex-wrap: wrap; gap: 4px }
.sidebar-filters .fbtn {
  padding: 3px 10px; border-radius: 20px;
  border: 1px solid var(--border); background: transparent;
  color: var(--t2); font-size: 11px; font-family: var(--font);
  cursor: pointer; transition: var(--tr); white-space: nowrap;
}
.sidebar-filters .fbtn:hover { border-color: rgba(59,130,246,0.35); color: var(--t1) }
.sidebar-filters .fbtn.on {
  background: rgba(59,130,246,0.12);
  border-color: rgba(59,130,246,0.3);
  color: var(--blue); font-weight: 600;
}

/* ---- Sidebar Actions ---- */
.sidebar-actions { padding: 10px 16px; flex-shrink: 0 }
.sidebar-actions .btn { width: 100% }
.sidebar-actions .btn + .btn { margin-top: 6px }

/* ---- Sidebar Hub ---- */
.sidebar-hub { padding: 10px 16px; flex-shrink: 0; border-top: 1px solid var(--border); }
.sidebar-hub .section-title { font-size: 10px; text-transform: uppercase; letter-spacing: .5px; color: var(--t3); margin-bottom: 6px; font-weight: 600; }
.sidebar-hub .hub-status { font-size: 11px; color: var(--t2); margin-bottom: 8px; }
.sidebar-hub .hub-status.connected { color: var(--green); }
.sidebar-hub .hub-status-row { display: flex; align-items: center; justify-content: space-between; gap: 6px; margin-bottom: 8px; }
.sidebar-hub .hub-status-row .hub-status-text { font-size: 11px; color: var(--green); flex: 1; min-width: 0; }
.sidebar-hub .hub-disconnect-btn { flex-shrink: 0; width: 22px; height: 22px; padding: 0; border: 1px solid var(--border); border-radius: 6px; background: transparent; color: var(--t2); cursor: pointer; display: inline-flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1; transition: var(--tr); }
.sidebar-hub .hub-disconnect-btn:hover { color: var(--red); border-color: rgba(239,68,68,0.4); background: rgba(239,68,68,0.06); }
.sidebar-hub .btn { width: 100% }

/* ---- Main Scroll ---- */
.main-scroll {
  flex: 1; min-width: 0; min-height: 200px;
  overflow-y: auto; overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  background: radial-gradient(ellipse at 50% 0%, rgba(59,130,246,0.03) 0%, transparent 60%);
}
.main { max-width: 1440px; margin: 0 auto; padding: 20px 24px 32px }

/* ---- Search (generic) ---- */
.search { position: relative; min-width: 200px }
.search input {
  width: 100%; padding: 7px 12px 7px 34px;
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 10px; color: var(--t1);
  font-size: 13px; font-family: var(--font);
  outline: none; transition: var(--tr);
}
.search input:focus { border-color: rgba(59,130,246,0.5); box-shadow: 0 0 0 3px rgba(59,130,246,0.08) }
.search input::placeholder { color: var(--t3) }
.search-icon {
  position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
  color: var(--t3); font-size: 13px; pointer-events: none;
}

/* ============================================
   BUTTONS
   ============================================ */
.btn {
  padding: 6px 14px; border-radius: 8px;
  border: 1px solid var(--border); background: transparent;
  color: var(--t2); font-size: 12px; font-family: var(--font);
  cursor: pointer; transition: var(--tr);
  display: inline-flex; align-items: center; gap: 6px;
  white-space: nowrap; font-weight: 500;
}
.btn:hover { border-color: var(--border-active); color: var(--t1); background: rgba(255,255,255,0.03) }
.btn-primary {
  background: var(--blue); border-color: transparent; color: #fff;
  font-weight: 600;
}
.btn-primary:hover {
  background: #2563eb;
  box-shadow: 0 0 20px rgba(59,130,246,0.25), 0 0 40px rgba(59,130,246,0.08);
}
.btn-danger { border-color: var(--border); color: var(--t2); background: transparent }
.btn-danger:hover {
  border-color: rgba(239,68,68,0.35); color: var(--red);
  background: rgba(239,68,68,0.05);
}
.btn-sm { padding: 4px 10px; font-size: 11px; border-radius: 6px }
.btn:disabled, .btn-sm:disabled { opacity: 0.35; cursor: not-allowed; pointer-events: none }
.app-top .btn-hub {
  background: linear-gradient(135deg, rgba(59,130,246,0.2) 0%, rgba(167,139,250,0.15) 100%);
  border: 1px solid rgba(59,130,246,0.4);
  color: var(--t1);
  font-weight: 600;
  padding: 6px 12px;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.app-top .btn-hub:hover {
  background: linear-gradient(135deg, rgba(59,130,246,0.3) 0%, rgba(167,139,250,0.25) 100%);
  border-color: rgba(59,130,246,0.6);
  color: #fff;
  box-shadow: 0 0 16px rgba(59,130,246,0.2), 0 0 32px rgba(167,139,250,0.08);
}
.app-top .btn-hub .hub-icon {
  width: 14px; height: 14px;
  opacity: 0.95;
}
.btn-settings {
  background: transparent; border: 1px solid var(--border); color: var(--t2);
  display: flex; align-items: center; justify-content: center;
  width: 32px; height: 32px; padding: 0; border-radius: 8px;
  transition: all 0.2s;
}
.btn-settings:hover { color: var(--t1); border-color: var(--border-active); background: var(--bg2) }
.btn-settings svg { transition: transform 0.3s ease }
.btn-settings:hover svg { transform: rotate(45deg) }

/* Settings Panel */
.settings-panel { max-width: 560px; width: 92% }
.settings-section { margin-bottom: 20px }
.settings-section:last-child { margin-bottom: 0 }
.settings-section-title {
  font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em;
  color: var(--t3); margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid var(--border);
}
.settings-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 6px 0; font-size: 13px; gap: 12px;
}
.settings-row .settings-label { color: var(--t2); flex-shrink: 0 }
.settings-row .settings-value { color: var(--t1); text-align: right; word-break: break-all; font-weight: 500 }
.settings-row .settings-value.dim { color: var(--t3); font-weight: 400 }
.settings-danger {
  margin-top: 8px; padding-top: 16px; border-top: 1px solid rgba(248,81,73,0.2);
}
.settings-danger .settings-section-title { color: var(--red) }
.btn-cleanup {
  background: rgba(248,81,73,0.1); border: 1px solid var(--red); color: #fff;
  padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;
  transition: all 0.2s;
}
.btn-cleanup:hover { background: rgba(248,81,73,0.25) }
.cleanup-confirm-input {
  width: 100%; padding: 8px 12px; margin-top: 10px;
  background: var(--bg2); border: 1px solid var(--border); border-radius: 8px;
  color: var(--t1); font-size: 13px; font-family: 'SF Mono', 'Consolas', monospace;
}
.cleanup-confirm-input:focus { outline: none; border-color: var(--red) }
.settings-cleanup-steps {
  margin-top: 12px; padding: 10px 12px;
  background: var(--bg2); border-radius: 8px; font-size: 12px; color: var(--t2);
  max-height: 120px; overflow-y: auto;
}
.settings-cleanup-steps div { padding: 2px 0 }

.c-blue { color: var(--blue) }
.c-green { color: var(--green) }
.c-yellow { color: var(--yellow) }
.c-red { color: var(--red) }
.c-purple { color: var(--purple) }

/* ============================================
   SECTIONS & GRID
   ============================================ */
.sec-hdr {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 14px; padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
}
.sec-title {
  font-size: 14px; font-weight: 700;
  display: flex; align-items: center; gap: 8px;
  letter-spacing: -0.01em;
}
.sec-cnt {
  background: var(--bg3); color: var(--t2);
  padding: 2px 9px; border-radius: 10px;
  font-size: 11px; font-weight: 600;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: 10px; margin-bottom: 28px;
}

/* ---- View Density & Columns ---- */
.main.view-compact .grid { gap: 6px; margin-bottom: 18px }
.main.view-compact .card { padding: 10px 12px; gap: 4px }
.main.view-compact .card-desc, .main.view-compact .card-meta { font-size: 11px }
.main.view-compact .card-name { font-size: 13px }
.main.view-spacious .grid { gap: 16px; margin-bottom: 32px }
.main.view-spacious .card { padding: 20px 22px; gap: 12px }
.main.view-spacious .card-desc { font-size: 13px }
.main.view-spacious .card-meta { font-size: 12px }
.main.view-cols-2 .grid { grid-template-columns: repeat(2, 1fr) }
.main.view-cols-3 .grid { grid-template-columns: repeat(3, 1fr) }
.main.view-cols-4 .grid { grid-template-columns: repeat(4, 1fr) }

/* ---- Table View ---- */
.repos-table-wrap { overflow-x: auto; margin-bottom: 24px }
.repos-table { width: 100%; border-collapse: collapse; font-size: 12px }
.repos-table th, .repos-table td {
  padding: 10px 12px; text-align: left;
  border-bottom: 1px solid var(--border); vertical-align: middle;
}
.repos-table th {
  background: var(--bg2); color: var(--t3); font-weight: 700;
  font-size: 10px; text-transform: uppercase; letter-spacing: .6px; white-space: nowrap;
}
.repos-table th.sortable { cursor: pointer; transition: var(--tr) }
.repos-table th.sortable:hover { color: var(--t1) }
.repos-table tbody tr { transition: var(--tr) }
.repos-table tbody tr:hover { background: rgba(59,130,246,0.03) }
.repos-table .t-name a { color: var(--t1); font-weight: 600; text-decoration: none }
.repos-table .t-name a:hover { color: var(--blue); text-decoration: underline }
.repos-table .t-actions { display: flex; flex-wrap: wrap; gap: 4px }

/* ---- Focus View ---- */
.focus-view { max-width: 900px; padding: 0 0 24px }
.focus-header {
  display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
  margin-bottom: 20px; padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
}
.focus-title { font-size: 20px; font-weight: 700; margin: 0; letter-spacing: -0.02em }
.focus-status, .focus-actions, .focus-commits, .focus-readme, .focus-extras { margin-bottom: 20px }
.focus-section-title {
  font-size: 11px; text-transform: uppercase; letter-spacing: .5px;
  color: var(--t3); margin-bottom: 8px; font-weight: 600;
}
.focus-placeholder { color: var(--t3); font-size: 13px }
.focus-commit-list { list-style: none; padding: 0; margin: 0; font-size: 12px }
.focus-commit-list li { margin-bottom: 6px }
.focus-commit-list code {
  background: var(--bg2); padding: 2px 6px; border-radius: 4px;
  font-size: 11px; font-family: var(--mono);
}
.focus-actions-btns { display: flex; flex-wrap: wrap; gap: 8px }
.focus-readme-body {
  font-size: 13px; line-height: 1.7; max-height: 400px;
  overflow-y: auto; padding-right: 12px;
}
.focus-readme-body h1, .focus-readme-body h2, .focus-readme-body h3 { font-size: 1em; margin-top: 1em; margin-bottom: .5em }
.focus-readme-body pre { background: var(--bg2); padding: 10px; border-radius: 8px; overflow-x: auto }
.focus-readme-body code { background: var(--bg2); padding: 2px 4px; border-radius: 4px; font-size: 12px; font-family: var(--mono) }

/* ============================================
   CARDS
   ============================================ */
.card {
  background: var(--bg1);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 16px 18px;
  transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  display: grid;
  grid-template-rows: auto auto auto auto auto;
  gap: 8px;
  align-content: start;
  position: relative;
}
.card:hover {
  border-color: rgba(59,130,246,0.2);
  background: rgba(17,19,24,0.95);
  box-shadow: 0 4px 32px rgba(0,0,0,0.3), 0 0 0 1px rgba(59,130,246,0.08), var(--shadow-glow);
  transform: translateY(-1px);
}
.card:has(.card-menu.show) {
  z-index: 10;
}

/* ---- Card Top ---- */
.card-top {
  display: grid; grid-template-columns: auto 1fr auto;
  gap: 8px; align-items: start; min-height: 0;
}
.card-top .card-check { grid-column: 1; margin-top: 2px }
.card-name-grp { min-width: 0; grid-column: 2 }
.card-name {
  font-size: 14px; font-weight: 600; color: var(--t1);
  text-decoration: none; overflow: hidden; text-overflow: ellipsis;
  white-space: nowrap; display: block; letter-spacing: -0.01em;
}
.card-name:hover { color: var(--blue); text-decoration: underline }
.card-owner { font-size: 11px; color: var(--t3) }
.card-name-grp .btn { color: var(--t2); background: transparent; border-color: var(--border) }
.card-name-grp .btn:hover { color: var(--t1); border-color: var(--border-active) }

/* ---- Badges ---- */
.badges {
  display: flex; gap: 4px; flex-shrink: 0; flex-wrap: wrap;
  align-items: center; justify-content: flex-end; grid-column: 3;
}
.badge, .b-pub, .b-prv, .b-clone, .b-professional, .b-personal {
  padding: 2px 7px; border-radius: 5px;
  font-size: 10px; font-weight: 500; letter-spacing: .02em;
  background: rgba(255,255,255,0.03); border: 1px solid var(--border);
  color: var(--t2);
}
.badge.b-professional { color: var(--cyan); border-color: rgba(34,211,238,0.15); background: rgba(34,211,238,0.05) }
.badge.b-personal { color: var(--purple); border-color: rgba(167,139,250,0.15); background: rgba(167,139,250,0.05) }
.badge.b-idx-0 { color: var(--cyan); border-color: rgba(34,211,238,0.15); background: rgba(34,211,238,0.05) }
.badge.b-idx-1 { color: var(--purple); border-color: rgba(167,139,250,0.15); background: rgba(167,139,250,0.05) }
.badge.b-idx-2 { color: var(--blue); border-color: rgba(59,130,246,0.15); background: rgba(59,130,246,0.05) }
.badge.b-idx-3 { color: var(--orange); border-color: rgba(249,115,22,0.15); background: rgba(249,115,22,0.05) }
.badge.b-idx-4 { color: var(--green); border-color: rgba(34,197,94,0.15); background: rgba(34,197,94,0.05) }
.badge.b-idx-5 { color: var(--yellow); border-color: rgba(234,179,8,0.15); background: rgba(234,179,8,0.05) }
.badge.b-pub { color: var(--green); border-color: rgba(34,197,94,0.15); background: rgba(34,197,94,0.05) }
.badge.b-prv { color: var(--yellow); border-color: rgba(234,179,8,0.15); background: rgba(234,179,8,0.05) }
.badge.b-clone { color: var(--blue); border-color: rgba(59,130,246,0.15); background: rgba(59,130,246,0.05) }
.badge.b-stale {
  color: var(--orange); border-color: rgba(249,115,22,0.2);
  background: rgba(249,115,22,0.06); font-size: 9px; letter-spacing: .03em;
}

/* ---- Account Manager ---- */
.account-manager-actions { margin-bottom: 12px }
.account-manager-cards { display: flex; flex-direction: column; gap: 10px }
.account-manager-card {
  background: var(--bg2); border: 1px solid var(--border); border-radius: var(--r);
  padding: 12px 14px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px;
}
.account-manager-card-header { display: flex; align-items: center; gap: 8px }
.account-manager-user { font-size: 12px; color: var(--t2) }
.account-manager-card-actions { display: flex; gap: 6px }
.account-manager-empty { color: var(--t2); font-size: 13px; padding: 12px 0 }

/* ---- Setup Timeline ---- */
.setup-timeline { margin: 16px 0; display: flex; flex-direction: column; gap: 2px }
.setup-step {
  display: flex; align-items: flex-start; gap: 14px; padding: 12px 14px;
  background: var(--bg1); border: 1px solid var(--border); border-radius: 10px;
  font-size: 13px; color: var(--t1); transition: border-color 0.2s;
}
.setup-step-dot {
  width: 28px; height: 28px; min-width: 28px; border-radius: 50%; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700; margin-top: 1px;
}
.setup-step-dot.done { background: var(--green); color: var(--bg0) }
.setup-step-dot.pending { background: var(--bg2); border: 2px solid var(--t3); color: var(--t3) }
.setup-step-dot.fail { background: rgba(248,81,73,0.15); border: 2px solid var(--red); color: var(--red) }
.setup-step-body { flex: 1; min-width: 0 }
.setup-step-body a { color: var(--blue); text-decoration: underline }
.setup-step-body small { color: var(--t2); line-height: 1.6 }
.setup-action { display: inline-flex; align-items: center; gap: 6px; margin-top: 8px; padding: 7px 16px; background: var(--bg2); border: 1px solid var(--border-active); border-radius: 8px; color: var(--t1); font-size: 12px; font-weight: 600; cursor: pointer; transition: background 0.15s, border-color 0.15s, color 0.15s }
.setup-action:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.2); color: #fff }
.setup-action-primary { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.18); color: #fff }
.setup-action-primary:hover { background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.25) }
.setup-public-key { font-family: var(--mono); font-size: 11px; word-break: break-all; background: var(--bg0); border: 1px solid var(--border); padding: 10px 12px; border-radius: 8px; margin-top: 8px; user-select: all; color: var(--t2); line-height: 1.5 }
.setup-hint { margin-top: 6px; font-size: 12px; color: var(--t2); line-height: 1.6 }

/* ---- Empty Account Hint ---- */
.empty-account-hint { background: var(--bg1); border: 1px dashed var(--border); border-radius: 10px; padding: 24px; text-align: center; margin-bottom: 16px; color: var(--t1) }
.empty-account-hint a { color: var(--blue); text-decoration: underline; cursor: pointer }

/* ---- Card Sections ---- */
.card-desc {
  font-size: 12px; color: var(--t2); line-height: 1.5;
  display: -webkit-box; -webkit-line-clamp: 2;
  -webkit-box-orient: vertical; overflow: hidden;
}
.card-meta {
  display: flex; align-items: center; gap: 12px;
  font-size: 11px; color: var(--t3); flex-wrap: wrap;
}
.meta-item { display: flex; align-items: center; gap: 4px }
.lang-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; opacity: .85 }
.card-footer {
  margin-top: auto; padding-top: 8px;
  border-top: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  gap: 6px; font-size: 11px;
}

/* ---- Status Indicators ---- */
.status-ind {
  display: flex; align-items: center; gap: 5px;
  font-size: 11px; color: var(--t2); font-weight: 400;
}
.sdot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0 }
.s-clean { background: var(--green); box-shadow: 0 0 6px rgba(34,197,94,0.5) }
.s-dirty { background: var(--red); box-shadow: 0 0 6px rgba(239,68,68,0.5); animation: pulseDot 2s infinite }
.s-ahead, .s-behind { background: var(--yellow); opacity: .9; box-shadow: 0 0 4px rgba(234,179,8,0.3) }
.s-nc { background: var(--t3) }
@keyframes pulseDot {
  0%, 100% { box-shadow: 0 0 6px rgba(239,68,68,0.5) }
  50% { box-shadow: 0 0 10px rgba(239,68,68,0.8) }
}

/* ---- Branch Badge ---- */
.branch {
  color: var(--t2); background: var(--bg2);
  border: 1px solid var(--border);
  padding: 2px 7px; border-radius: 5px;
  font-family: var(--mono); font-size: 10px; font-weight: 400;
}
.card-footer .branch { font-size: 11px; padding: 3px 8px; font-weight: 500 }
.card-footer .branch.branch-not-primary {
  border-color: rgba(234,179,8,0.3); color: var(--yellow);
  background: rgba(234,179,8,0.07);
}

/* ---- Card Actions ---- */
.card-actions {
  display: flex; gap: 4px; margin-top: 6px;
  flex-wrap: wrap; align-items: center;
}

/* ---- Card Menu (⋮) ---- */
.card-menu-wrap { position: relative; display: inline-block }
.card-menu-wrap .btn-dots {
  padding: 2px 6px; font-size: 16px; line-height: 1;
  background: var(--bg2); border: none;
  color: var(--t1);
  cursor: pointer; border-radius: 6px; transition: var(--tr);
}
.card-menu-wrap .btn-dots:hover { color: #fff; background: var(--bg3) }
.card-menu {
  display: none; position: absolute; top: 100%; right: 0; left: auto;
  margin-top: 4px;
  background: rgba(26,29,36,0.97);
  border: 1px solid var(--border-active);
  border-radius: 12px;
  box-shadow: var(--shadow-lg);
  z-index: 100; min-width: 170px; padding: 4px;
  backdrop-filter: blur(24px);
}
.card-menu.show { display: block; animation: menuIn .15s ease }
@keyframes menuIn {
  from { opacity: 0; transform: translateY(-6px) }
  to { opacity: 1; transform: translateY(0) }
}
.card-menu a, .card-menu button {
  display: block; width: 100%; padding: 8px 12px;
  font-size: 12px; color: var(--t1); text-decoration: none;
  white-space: nowrap; text-align: left; background: none;
  border: none; cursor: pointer; font-family: var(--font);
  border-radius: 6px; transition: var(--tr);
}
.card-menu a:hover, .card-menu button:hover { background: rgba(255,255,255,0.06); color: #fff }
.card-menu button.card-menu-remove:hover { color: var(--red); background: rgba(239,68,68,0.06) }
.card-menu-sep { height: 1px; background: var(--border); margin: 4px 0 }

/* ---- Extras Pills ---- */
.extras-pills { display: flex; gap: 4px; align-items: center; margin-left: auto; margin-right: 8px }
.extras-pills:empty { display: none }
.extras-pill {
  padding: 1px 6px; border-radius: 4px;
  font-size: 9px; font-weight: 600; white-space: nowrap;
}
.pill-pr { color: var(--purple); background: rgba(167,139,250,0.08); border: 1px solid rgba(167,139,250,0.15) }
.pill-issues { color: var(--orange); background: rgba(249,115,22,0.08); border: 1px solid rgba(249,115,22,0.15) }
.meta-size { opacity: .7 }

/* ---- Alias ---- */
.card-alias {
  font-size: 12px; color: var(--t2); font-style: italic; cursor: pointer;
  max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  transition: var(--tr); flex-shrink: 0;
}
.card-alias:hover { color: var(--t1) }
.card-alias-empty {
  font-size: 11px; color: var(--t3); opacity: 0; cursor: pointer;
  transition: var(--tr); flex-shrink: 0;
}
.card:hover .card-alias-empty { opacity: .5 }
.card-alias-empty:hover { opacity: 1 !important; color: var(--t2) }

/* ---- Pin ---- */
.btn-pin {
  background: none; border: none; cursor: pointer; font-size: 15px;
  padding: 2px 4px; line-height: 1; color: var(--t3);
  transition: var(--tr); border-radius: 4px;
}
.btn-pin:hover { color: var(--yellow); text-shadow: 0 0 8px rgba(234,179,8,0.4) }
.btn-pin.pinned { color: var(--yellow); text-shadow: 0 0 8px rgba(234,179,8,0.3) }

/* ---- Pinned Section ---- */
.pinned-section { margin-bottom: 20px }
.pinned-label {
  font-size: 11px; color: var(--yellow); text-transform: uppercase;
  letter-spacing: .5px; font-weight: 700; margin-bottom: 8px;
  display: flex; align-items: center; gap: 6px;
}

/* ---- Checkbox ---- */
.card-check {
  width: 15px; height: 15px; accent-color: var(--blue);
  cursor: pointer; opacity: 0; transition: opacity .15s;
  flex-shrink: 0; margin-top: 2px;
}
.card:hover .card-check, .card-check:checked { opacity: 1 }

/* ---- Bulk Bar ---- */
.bulk-bar {
  display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
  background: rgba(17,19,24,0.92);
  border: 1px solid rgba(59,130,246,0.25);
  border-radius: 16px; padding: 10px 22px; z-index: 180;
  box-shadow: var(--shadow-lg), var(--shadow-glow);
  align-items: center; gap: 12px;
  font-size: 13px; color: var(--t1);
  animation: slideUp .25s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(24px);
}
.bulk-bar.show { display: flex }
.bulk-count { font-weight: 700; color: var(--blue) }
@keyframes slideUp {
  from { transform: translateX(-50%) translateY(20px); opacity: 0 }
  to { transform: translateX(-50%) translateY(0); opacity: 1 }
}

/* ============================================
   MODALS
   ============================================ */
.modal-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,0.65);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: 200;
  align-items: center; justify-content: center;
}
.modal-overlay.show { display: flex; animation: modalBgIn .2s ease }
@keyframes modalBgIn { from { opacity: 0 } to { opacity: 1 } }

.modal {
  background: var(--bg1);
  border: 1px solid var(--border-active);
  border-radius: 18px; padding: 24px;
  max-width: 520px; width: 90%; max-height: 80vh; overflow-y: auto;
  box-shadow: var(--shadow-lg), 0 0 80px rgba(59,130,246,0.06);
  animation: modalIn .25s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
}
.modal::before {
  content: '';
  position: absolute; top: 0; left: 32px; right: 32px; height: 1px;
  background: linear-gradient(90deg, transparent, rgba(59,130,246,0.4), rgba(167,139,250,0.3), transparent);
  border-radius: 1px;
}
@keyframes modalIn {
  from { opacity: 0; transform: translateY(16px) scale(0.96) }
  to { opacity: 1; transform: translateY(0) scale(1) }
}
.modal h3 { margin-bottom: 12px; font-size: 16px; font-weight: 700; letter-spacing: -0.01em }
.modal p { color: var(--t2); font-size: 13px; margin-bottom: 12px }
.modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px }
.hub-step { display: flex; gap: 12px; margin-bottom: 14px }
.hub-step-num {
  flex-shrink: 0; width: 22px; height: 22px; border-radius: 50%;
  background: var(--bg3); color: var(--t2); font-size: 11px; font-weight: 700;
  display: flex; align-items: center; justify-content: center; margin-top: 1px;
}
.hub-step-content { flex: 1; min-width: 0 }
.hub-step-content label { margin-bottom: 4px }
.hub-step-content input { margin-bottom: 0 }
.hub-get-key {
  display: inline-flex; align-items: center; gap: 5px; margin-top: 6px;
  font-size: 11px; color: var(--blue); text-decoration: none; font-weight: 500;
  opacity: 0.85; transition: opacity 0.15s;
}
.hub-get-key:hover { opacity: 1; text-decoration: underline }
.hub-get-key svg { flex-shrink: 0; opacity: 0.7 }
.remove-modal-progress { display: flex; align-items: center; gap: 12px; padding: 20px 0; margin-top: 8px }
.remove-modal-progress .spinner { width: 20px; height: 20px; border-width: 2px; flex-shrink: 0 }
.remove-modal-progress p { margin: 0; color: var(--t2); font-size: 13px }
.modal input[type=text],
.modal input[type=email],
.modal input[type=url],
.modal input[type=password],
.modal input[type=number] {
  width: 100%; padding: 9px 12px;
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 10px; color: var(--t1);
  font-size: 13px; font-family: var(--font);
  outline: none; margin-bottom: 8px; transition: var(--tr);
}
.modal input[type=number] { width: auto; }
.modal input[type=text]:focus,
.modal input[type=email]:focus,
.modal input[type=url]:focus,
.modal input[type=password]:focus,
.modal input[type=number]:focus {
  border-color: rgba(59,130,246,0.5);
  box-shadow: 0 0 0 3px rgba(59,130,246,0.08);
}
.modal label { font-size: 12px; color: var(--t2); display: block; margin-bottom: 4px; font-weight: 500 }
.modal a { color: var(--t1); text-decoration: underline; text-underline-offset: 2px }
.modal a:hover { color: #fff }
.modal .field-hint { font-size: 11px; color: var(--t3); margin-top: 2px; margin-bottom: 6px }
.modal select {
  width: 100%; padding: 9px 12px;
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 10px; color: var(--t1);
  font-size: 13px; font-family: var(--font);
  outline: none; margin-bottom: 8px;
}

/* ---- README Modal ---- */
.modal-readme { max-width: 680px; width: 95%; max-height: 85vh; display: flex; flex-direction: column }
.modal-readme .modal-body { flex: 1; overflow: auto; padding: 20px 24px }
.markdown-body { font-size: 14px; line-height: 1.7; color: var(--t1) }
.markdown-body h1, .markdown-body h2, .markdown-body h3 {
  font-weight: 700; margin-top: 24px; margin-bottom: 16px;
  border-bottom: 1px solid var(--border); padding-bottom: 6px;
}
.markdown-body h1 { font-size: 1.5em }
.markdown-body h2 { font-size: 1.25em }
.markdown-body h3 { font-size: 1.1em }
.markdown-body p { margin-bottom: 12px }
.markdown-body p:has(> img) { display: flex; flex-wrap: wrap; align-items: center; gap: 6px; margin-bottom: 10px }
.markdown-body p:has(> img) br { display: none }
.markdown-body p:has(> img) img { vertical-align: middle }
.markdown-body ul, .markdown-body ol { margin: 0 0 16px 24px }
.markdown-body li { margin: 4px 0 }
.markdown-body code {
  background: var(--bg2); padding: 2px 6px; border-radius: 4px;
  font-size: 13px; font-family: var(--mono);
}
.markdown-body pre {
  margin: 12px 0; padding: 14px;
  background: var(--bg0); border: 1px solid var(--border);
  border-radius: 10px; overflow: auto;
}
.markdown-body pre code { background: none; padding: 0 }
.markdown-body a { color: var(--blue); text-decoration: none }
.markdown-body a:hover { text-decoration: underline }
.markdown-body blockquote { border-left: 3px solid var(--blue); margin: 12px 0; padding: 0 16px; color: var(--t2) }
.markdown-body table { border-collapse: collapse; width: 100%; margin: 12px 0 }
.markdown-body th, .markdown-body td { border: 1px solid var(--border); padding: 6px 12px; text-align: left }
.markdown-body th { background: var(--bg2); font-weight: 600 }
.readme-loading { text-align: center; padding: 24px; color: var(--t2) }
.readme-badge { font-size: 10px; color: var(--t3); margin-left: 8px; font-weight: 400 }

/* ============================================
   GIT MODAL
   ============================================ */
.modal.modal-git {
  max-width: 540px; width: 95%; max-height: 88vh;
  display: flex; flex-direction: column; overflow: hidden; padding: 16px 20px;
}
.modal.modal-git h3 {
  margin-bottom: 12px; padding-bottom: 8px;
  border-bottom: 1px solid var(--border); font-size: 15px; flex-shrink: 0;
}
.modal.modal-git #gitModalLoading { flex-shrink: 0 }
.modal.modal-git #gitModalBody {
  flex: 1; min-height: 0; overflow-y: auto; overflow-x: hidden; padding-right: 12px;
}
.modal.modal-git #gitModalBody::-webkit-scrollbar { width: 4px }
.modal.modal-git #gitModalBody::-webkit-scrollbar-thumb { background: var(--bg3); border-radius: 3px }
.modal.modal-git #gitModalFeedback { flex-shrink: 0 }
.modal.modal-git .modal-actions {
  flex-shrink: 0; margin-top: 12px; padding-top: 12px;
  border-top: 1px solid var(--border);
}

/* ---- Git Sections ---- */
.git-section { margin-bottom: 12px; padding-top: 12px; border-top: 1px solid var(--border) }
.git-section:first-child { padding-top: 0; border-top: none }
.git-section-head {
  display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
  margin-bottom: 8px; font-size: 12px; color: var(--t2);
}
.git-section-head .git-label {
  font-weight: 700; color: var(--t1); font-size: 11px;
  text-transform: uppercase; letter-spacing: .4px;
}
.git-section-head .branch { font-size: 11px; padding: 2px 8px }
.git-section-head .branch.git-branch-current {
  border-color: rgba(59,130,246,0.35); color: var(--blue);
  background: rgba(59,130,246,0.08);
  box-shadow: 0 0 0 1px rgba(59,130,246,0.15);
}
.git-operation-banner {
  background: rgba(239,68,68,0.06); border: 1px solid rgba(239,68,68,0.2);
  border-radius: 10px; padding: 10px 14px; margin-bottom: 10px;
  font-size: 12px; color: var(--red); font-weight: 500;
}
.git-status-strip { display: flex; gap: 14px; margin-bottom: 10px; font-size: 11px; color: var(--t3) }
.git-status-strip span { white-space: nowrap }
.git-status-strip .git-staged { color: var(--green) }
.git-status-strip .git-unstaged { color: var(--yellow) }
.git-status-strip .git-untracked { color: var(--t2) }
.git-status-strip .git-conflicts { color: var(--red) }
.git-diff-btn { margin-left: auto; flex-shrink: 0 }

/* ---- Diff Panel ---- */
.git-diff-panel {
  margin-top: 10px; border: 1px solid var(--border);
  border-radius: 10px; overflow: hidden; background: var(--bg2);
}
.git-diff-head {
  display: flex; align-items: center; justify-content: space-between;
  padding: 8px 12px; border-bottom: 1px solid var(--border); font-size: 12px;
}
.git-diff-title { color: var(--t2); overflow: hidden; text-overflow: ellipsis; white-space: nowrap }
.git-diff-tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border) }
.git-diff-tab {
  padding: 6px 12px; font-size: 11px; font-family: var(--font);
  background: transparent; border: none; color: var(--t3);
  cursor: pointer; border-bottom: 2px solid transparent; transition: var(--tr);
}
.git-diff-tab:hover { color: var(--t1) }
.git-diff-tab.active { color: var(--blue); border-bottom-color: var(--blue) }
.git-diff-content {
  margin: 0; padding: 10px; font-size: 11px;
  font-family: var(--mono); white-space: pre-wrap; word-break: break-all;
  max-height: 280px; overflow: auto; color: var(--t2);
}

/* ---- Discard All ---- */
.git-discard-all-confirm {
  margin-top: 8px; padding: 12px;
  background: rgba(239,68,68,0.04); border: 1px solid rgba(239,68,68,0.15);
  border-radius: 10px; font-size: 12px;
}
.git-discard-all-msg { margin-bottom: 8px; color: var(--t2) }
.git-discard-all-input {
  width: 100%; max-width: 200px; padding: 6px 8px; margin-bottom: 8px;
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 6px; color: var(--t1);
  font-size: 12px; font-family: var(--font);
}
.git-discard-all-btns { display: flex; gap: 8px }
.git-discard-all-untracked { display: block; margin-bottom: 6px; font-size: 12px; color: var(--t2); cursor: pointer }

/* ---- Stash ---- */
.git-stash-list {
  max-height: 120px; overflow-y: auto;
  background: var(--bg2); border-radius: 10px; padding: 8px; font-size: 12px;
}
.git-stash-row {
  display: flex; align-items: center; gap: 8px; padding: 5px 0;
  border-bottom: 1px solid var(--border); flex-wrap: wrap;
}
.git-stash-row:last-child { border-bottom: none }
.git-stash-ref { font-family: var(--mono); font-size: 11px; color: var(--purple); flex-shrink: 0 }
.git-stash-msg { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--t2) }

/* ---- Branch ---- */
.git-branch-row { display: flex; flex-wrap: wrap; align-items: center; gap: 8px }
.git-branch-row select {
  min-width: 140px; padding: 6px 10px;
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 8px; color: var(--t1);
  font-size: 12px; font-family: var(--font);
}
.git-new-branch-row { display: flex; align-items: center; gap: 8px; margin-top: 8px }
.git-new-branch-row input {
  flex: 1; min-width: 0; padding: 6px 10px;
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 8px; color: var(--t1);
  font-size: 12px; font-family: var(--font);
}

/* ---- Files ---- */
.git-files-head {
  display: flex; align-items: center; gap: 8px;
  margin-bottom: 6px; font-size: 12px; color: var(--t2);
}
.git-files-head .git-label {
  font-weight: 700; color: var(--t1); font-size: 11px;
  text-transform: uppercase; letter-spacing: .4px;
}
.git-files-list {
  max-height: 160px; overflow-y: auto;
  background: var(--bg2); border-radius: 10px; padding: 8px; font-size: 12px;
}
.git-file-row { display: flex; align-items: center; gap: 8px; padding: 5px 4px; border-radius: 4px; transition: var(--tr) }
.git-file-row:hover { background: rgba(255,255,255,0.02) }
.git-file-row input[type=checkbox] { flex-shrink: 0; accent-color: var(--blue) }
.git-file-path { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--t2); font-family: var(--mono); font-size: 11px }
.git-file-status { font-size: 10px; color: var(--t3); text-transform: uppercase; flex-shrink: 0; font-weight: 600 }

/* ---- Commit Area ---- */
.git-commit-area textarea {
  width: 100%; padding: 10px 12px;
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 10px; color: var(--t1);
  font-size: 12px; font-family: var(--font);
  outline: none; resize: vertical; min-height: 64px;
  margin-top: 6px; margin-bottom: 10px; transition: var(--tr);
}
.git-commit-area textarea:focus {
  border-color: rgba(59,130,246,0.5);
  box-shadow: 0 0 0 3px rgba(59,130,246,0.08);
}
.git-actions-row { display: flex; gap: 8px; align-items: center }

/* ---- Commits List ---- */
.git-commits-list {
  max-height: 180px; overflow-y: auto; overflow-x: hidden;
  background: var(--bg2); border-radius: 10px; padding: 8px; font-size: 12px;
  scrollbar-width: thin; scrollbar-color: var(--bg3) transparent;
}
.git-commits-list::-webkit-scrollbar { width: 4px }
.git-commits-list::-webkit-scrollbar-track { background: transparent }
.git-commits-list::-webkit-scrollbar-thumb { background: var(--bg3); border-radius: 3px }
.git-commits-list::-webkit-scrollbar-thumb:hover { background: var(--t3) }
.git-commit-row {
  display: flex; align-items: center; gap: 8px; padding: 6px 4px;
  border-bottom: 1px solid var(--border); flex-wrap: wrap;
  border-radius: 4px; transition: var(--tr);
}
.git-commit-row:hover { background: rgba(255,255,255,0.02) }
.git-commit-row:last-child { border-bottom: none }
.git-commit-hash { font-family: var(--mono); font-size: 11px; color: var(--blue); flex-shrink: 0 }
.git-commit-subject { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--t1) }
.git-commit-meta { font-size: 10px; color: var(--t3); flex-shrink: 0 }
.git-commit-row .btn-sm { margin-left: auto }
.git-commit-unpushed {
  font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px;
  color: var(--yellow); background: rgba(234,179,8,0.1);
  padding: 1px 6px; border-radius: 4px; flex-shrink: 0;
}

/* ---- Git Feedback ---- */
.git-modal-feedback {
  margin-top: 12px; padding: 10px 14px; border-radius: 10px;
  font-size: 12px; display: none; align-items: center; gap: 8px;
}
.git-modal-feedback.processing {
  display: flex; background: rgba(59,130,246,0.05);
  border: 1px solid rgba(59,130,246,0.15); color: var(--blue);
}
.git-modal-feedback.success {
  display: flex; background: rgba(34,197,94,0.06);
  border: 1px solid rgba(34,197,94,0.15); color: var(--green);
}
.git-modal-feedback.error {
  display: flex; background: rgba(239,68,68,0.06);
  border: 1px solid rgba(239,68,68,0.15); color: var(--red);
}
.git-feedback-spinner { width: 14px; height: 14px; border-width: 2px; flex-shrink: 0 }

/* ============================================
   TOASTS
   ============================================ */
.toast-container {
  position: fixed; top: 60px; right: 20px; z-index: 300;
  display: flex; flex-direction: column; gap: 8px;
}

/* Clone overlay */
.clone-overlay {
  display: none;
  position: fixed; inset: 0; z-index: 500;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(4px);
  align-items: center; justify-content: center;
}
.clone-overlay.active { display: flex; }
.clone-overlay-box {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 16px; padding: 40px 48px; text-align: center;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  min-width: 280px;
}
.clone-spinner {
  width: 36px; height: 36px; margin: 0 auto 18px;
  border: 3px solid var(--border);
  border-top-color: var(--t1);
  border-radius: 50%;
  animation: cloneSpin 0.8s linear infinite;
}
@keyframes cloneSpin { to { transform: rotate(360deg); } }
.clone-overlay-title {
  font-size: 15px; font-weight: 600; color: var(--t1); margin-bottom: 6px;
}
.clone-overlay-sub {
  font-size: 12px; color: var(--t3); min-height: 16px;
}
.toast {
  padding: 12px 18px; border-radius: 12px; font-size: 13px;
  max-width: 380px;
  animation: toastIn .3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex; align-items: center; gap: 8px;
  box-shadow: var(--shadow-lg);
  backdrop-filter: blur(16px);
}
.toast-success { background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.15); color: var(--green) }
.toast-error { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.15); color: var(--red) }
.toast-info { background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.15); color: var(--blue) }
@keyframes toastIn {
  from { transform: translateX(100%); opacity: 0 }
  to { transform: translateX(0); opacity: 1 }
}

/* ============================================
   ACTIVITY LOG
   ============================================ */
.sidebar-log {
  flex: 1; min-height: 120px; display: flex;
  flex-direction: column; overflow: hidden; padding: 0 16px 16px;
}
.log-panel {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 12px; padding: 12px 12px;
  flex: 1; min-height: 0; overflow-y: auto; font-size: 11px;
}
.log-title {
  font-size: 12px; font-weight: 700; margin-bottom: 8px;
  display: flex; align-items: center; gap: 8px;
}
.log-entry {
  font-size: 11px; color: var(--t2); padding: 4px 0;
  border-bottom: 1px solid rgba(255,255,255,0.025);
  font-family: var(--mono);
}
.log-entry:last-child { border-bottom: none }
.log-time { color: var(--t3); margin-right: 8px }
.log-empty { color: var(--t3); font-size: 11px; padding: 8px 0 }
.log-ok { color: var(--green) }
.log-err { color: var(--red) }
.log-warn { color: var(--yellow) }

/* ============================================
   MISC
   ============================================ */
.empty { text-align: center; padding: 80px 20px; color: var(--t2); display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 320px }
.empty p { margin: 0 }
.empty .empty-title { font-size: 18px; font-weight: 600; color: var(--t1); margin-bottom: 8px }
.empty .empty-sub { font-size: 14px; color: var(--t2); margin-bottom: 24px; line-height: 1.5 }
.empty .empty-btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 24px; background: var(--bg2); border: 1px solid var(--border-active); color: var(--t1); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; text-decoration: none; transition: background 0.2s, border-color 0.2s }
.empty .empty-btn:hover { background: var(--blue); border-color: var(--blue); color: #fff }
.empty .empty-icon { margin-bottom: 20px; opacity: 0.35 }
.spinner {
  display: inline-block; width: 14px; height: 14px;
  border: 2px solid rgba(255,255,255,0.06);
  border-top-color: var(--blue);
  border-radius: 50%; animation: spin .6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg) } }

.loading-overlay {
  position: fixed; inset: 0;
  background: rgba(8,9,10,0.88);
  backdrop-filter: blur(12px);
  z-index: 150; display: flex; align-items: center; justify-content: center;
  flex-direction: column; gap: 12px; color: var(--t2); font-size: 14px;
}
.loading-overlay .spinner { width: 28px; height: 28px; border-width: 3px }

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 768px) {
  .app-body { flex-direction: column }
  .sidebar {
    width: 100%; max-height: 40vh;
    border-right: none; border-bottom: 1px solid var(--border);
  }
  .main { padding: 14px 16px 24px }
  .grid { grid-template-columns: 1fr }
  .main.view-cols-2 .grid,
  .main.view-cols-3 .grid,
  .main.view-cols-4 .grid { grid-template-columns: 1fr }
}

  </style>
</head>
<body>

<header class="app-top">
  <div class="app-top-left">
    <div class="logo"><img src="/gitdock-logo.png" alt="GitDock"></div>
    <div>
      <span class="app-title">GitDock</span>
      <span class="app-sub" id="lastUpdated">Connecting...</span>
    </div>
  </div>
  <div class="app-top-actions">
    <a id="hubLinkBtn" href="#" class="btn btn-sm btn-hub" title="Open Hub (multi-machine overview)" data-configured="false" onclick="if(this.getAttribute('data-configured')!=='true'){event.preventDefault();openHubModal();}">
      <svg class="hub-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      Hub
    </a>
    <button class="btn btn-sm btn-settings" title="Settings" onclick="openSettingsPanel()">
      <svg width="15" height="15" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0a8.1 8.1 0 0 0-.832.042c-.254.024-.39.148-.462.328L6.082 2.06a5.17 5.17 0 0 0-1.178.489l-1.57-.8c-.17-.088-.35-.076-.508.044a8 8 0 0 0-1.182 1.179c-.12.157-.132.338-.044.508l.8 1.572a5.2 5.2 0 0 0-.488 1.176L.222 6.853c-.18.072-.304.208-.328.462a8.2 8.2 0 0 0 0 1.37c.024.254.148.39.328.462l1.69.624c.117.41.282.804.488 1.176l-.8 1.572c-.088.17-.076.35.044.508a8 8 0 0 0 1.182 1.179c.157.12.338.132.508.044l1.57-.8c.374.207.768.372 1.178.489l.624 1.69c.072.18.208.304.462.328a8.2 8.2 0 0 0 1.664 0c.254-.024.39-.148.462-.328l.624-1.69a5.17 5.17 0 0 0 1.178-.489l1.57.8c.17.088.35.076.508-.044a8 8 0 0 0 1.182-1.179c.12-.157.132-.338.044-.508l-.8-1.572c.206-.372.371-.765.488-1.176l1.69-.624c.18-.072.304-.208.328-.462a8.2 8.2 0 0 0 0-1.37c-.024-.254-.148-.39-.328-.462l-1.69-.624a5.2 5.2 0 0 0-.488-1.176l.8-1.572c.088-.17.076-.35-.044-.508a8 8 0 0 0-1.182-1.179c-.157-.12-.338-.132-.508-.044l-1.57.8a5.17 5.17 0 0 0-1.178-.489L9.538.37c-.072-.18-.208-.304-.462-.328A8.1 8.1 0 0 0 8 0Zm0 5a3 3 0 1 1 0 6 3 3 0 0 1 0-6Z"/></svg>
    </button>
  </div>
</header>

<div class="config-bar" id="configBar"></div>

<div class="app-body">
  <aside class="sidebar">
    <div class="sidebar-stats" id="statsBar"></div>
    <div class="sidebar-attention" id="attentionPanel" style="display:none"></div>
    <div class="sidebar-search">
      <div class="search">
        <span class="search-icon"><svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor"><path d="M10.68 11.74a6 6 0 1 1 1.06-1.06l3.04 3.04a.75.75 0 1 1-1.06 1.06l-3.04-3.04ZM11.5 7a4.5 4.5 0 1 0-9 0 4.5 4.5 0 0 0 9 0Z"/></svg></span>
        <input type="text" id="searchInput" placeholder="Search repos... ( / )" autocomplete="off">
        <button type="button" class="search-clear" id="searchClear" onclick="clearSearch()" title="Clear search">&times;</button>
      </div>
    </div>
    <div class="sidebar-filters" id="filters"></div>
    <div class="sidebar-actions">
      <button class="btn btn-sm" onclick="openAccountManager()">Manage Accounts</button>
      <button class="btn btn-sm btn-primary" onclick="openCloneUrlModal()">Clone by URL</button>
      <button class="btn btn-sm" onclick="openModal('migrateModal')">Migrate Repo</button>
    </div>
    <div class="sidebar-hub" id="hubSection">
      <div class="section-title">Multi-machine (Hub)</div>
      <div id="hubStatusWrap">
        <div id="hubStatus" class="hub-status">—</div>
        <div id="hubStatusRow" class="hub-status-row" style="display:none">
          <span id="hubStatusText" class="hub-status-text"></span>
          <button type="button" class="hub-disconnect-btn" id="hubDisconnectBtn" onclick="openHubDisconnectModal()" title="Remove Hub connection">&times;</button>
        </div>
      </div>
      <button type="button" class="btn btn-sm" onclick="openHubModal()">Configure Hub</button>
    </div>
    <div class="sidebar-log" id="logSection">
      <div class="log-panel" id="logPanel">
        <div class="log-title">Activity Log <span class="sec-cnt" id="logCount">0</span></div>
        <div id="logEntries"></div>
      </div>
    </div>
  </aside>
  <div class="main-scroll">
    <div class="main" id="mainContent"><div class="empty"><div class="spinner" style="width:24px;height:24px;border-width:3px"></div><p style="margin-top:12px">Loading repos...</p></div></div>
  </div>
</div>

<div class="bulk-bar" id="bulkBar">
  <span class="bulk-count" id="bulkCount">0</span> selected <span id="bulkCountByAccount"></span>
  <button class="btn btn-sm btn-primary" onclick="bulkClone()">Clone</button>
  <button class="btn btn-sm" onclick="bulkPull()">Pull</button>
  <button class="btn btn-sm" onclick="bulkFetch()">Fetch</button>
  <button class="btn btn-sm" onclick="bulkClearSelection()">Clear</button>
</div>
<div class="toast-container" id="toasts"></div>

<!-- Clone Overlay -->
<div class="clone-overlay" id="cloneOverlay">
  <div class="clone-overlay-box">
    <div class="clone-spinner"></div>
    <div class="clone-overlay-title" id="cloneOverlayTitle">Cloning repository...</div>
    <div class="clone-overlay-sub" id="cloneOverlaySub"></div>
  </div>
</div>

<!-- Alias Modal -->
<div class="modal-overlay" id="aliasModal">
  <div class="modal" style="max-width:380px">
    <h3 id="aliasModalTitle">Set Alias</h3>
    <p style="color:var(--t2);font-size:12px;margin-bottom:12px">A custom label to help you remember this project.</p>
    <input type="text" id="aliasInput" placeholder="e.g. ML Image Processing" maxlength="60" autocomplete="off">
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('aliasModal')">Cancel</button>
      <button class="btn" style="color:var(--t3)" onclick="confirmAlias(true)">Clear</button>
      <button class="btn btn-primary" onclick="confirmAlias(false)">Save</button>
    </div>
  </div>
</div>

<!-- Hub Config Modal -->
<div class="modal-overlay" id="hubModal">
  <div class="modal" style="max-width:440px">
    <h3>Connect to Hub</h3>
    <p style="color:var(--t2);font-size:12px;margin-bottom:16px">Sync this machine's git status to a central Hub. See all your machines in one place.</p>

    <div class="hub-step">
      <span class="hub-step-num">1</span>
      <div class="hub-step-content">
        <label>Hub URL</label>
        <input type="url" id="hubUrlInput" placeholder="https://hub.gitdock.dev" value="https://hub.gitdock.dev" autocomplete="off">
      </div>
    </div>

    <div class="hub-step">
      <span class="hub-step-num">2</span>
      <div class="hub-step-content">
        <label>API Key</label>
        <input type="password" id="hubApiKeyInput" placeholder="gdk_..." autocomplete="off">
        <a href="#" id="hubGetKeyLink" class="hub-get-key" onclick="openHubForKey(event)" title="Register and generate an API key on the Hub">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          Don't have a key? Open Hub to register &amp; get one
        </a>
      </div>
    </div>

    <div class="hub-step">
      <span class="hub-step-num">3</span>
      <div class="hub-step-content">
        <label>Machine name</label>
        <input type="text" id="hubMachineNameInput" placeholder="e.g. My Laptop" maxlength="128" autocomplete="off">
      </div>
    </div>

    <div class="hub-step">
      <span class="hub-step-num">4</span>
      <div class="hub-step-content">
        <label>Snapshot interval</label>
        <div style="display:flex;align-items:center;gap:8px">
          <input type="number" id="hubIntervalInput" min="1" max="60" value="3" style="width:72px">
          <span style="color:var(--t2);font-size:12px">minutes</span>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn" onclick="closeModal('hubModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveHubConfig()">Connect</button>
    </div>
  </div>
</div>

<!-- Hub Disconnect Confirm Modal -->
<div class="modal-overlay" id="hubDisconnectModal">
  <div class="modal" style="max-width:360px">
    <h3>Remove Hub connection?</h3>
    <p style="color:var(--t2);font-size:13px;margin-bottom:16px">This machine will stop sending snapshots to the Hub. You can configure again later.</p>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('hubDisconnectModal')">Cancel</button>
      <button class="btn btn-danger" onclick="confirmHubDisconnect()">Remove</button>
    </div>
  </div>
</div>

<!-- Remove Confirm Modal -->
<div class="modal-overlay" id="removeModal">
  <div class="modal">
    <h3>Remove Local Clone</h3>
    <div id="removeModalConfirm">
      <p id="removeMsg"></p>
      <div id="removeWarning" style="display:none;background:rgba(248,81,73,.08);border:1px solid rgba(248,81,73,.2);border-radius:6px;padding:10px;margin:8px 0;font-size:12px;color:var(--red)"></div>
      <div class="modal-actions">
        <button class="btn" onclick="closeModal('removeModal')">Cancel</button>
        <button class="btn btn-danger" id="removeConfirmBtn" onclick="confirmRemove()">Remove</button>
      </div>
    </div>
    <div id="removeModalProgress" class="remove-modal-progress" style="display:none" role="status" aria-live="polite">
      <span class="spinner"></span>
      <p id="removeProgressText">Removing...</p>
    </div>
  </div>
</div>

<!-- Migrate Modal -->
<div class="modal-overlay" id="migrateModal">
  <div class="modal">
    <h3>Migrate Existing Repo</h3>
    <p>Move a repo from another location into the organized structure.</p>
    <label>Full path of the existing repo folder:</label>
    <input type="text" id="migratePath" placeholder="">
    <label>Repo name (for the folder):</label>
    <input type="text" id="migrateName" placeholder="my-project">
    <label>Destination account:</label>
    <select id="migrateAccount">
      <option value="">Loading...</option>
    </select>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('migrateModal')">Cancel</button>
      <button class="btn btn-primary" onclick="doMigrate()">Migrate</button>
    </div>
  </div>
</div>

<!-- Clone by URL Modal -->
<div class="modal-overlay" id="cloneUrlModal">
  <div class="modal" style="max-width:520px">
    <h3>Clone by URL</h3>
    <p>Paste a GitHub repository URL and choose which account key to use for cloning.</p>
    <label>GitHub repository URL:</label>
    <input type="text" id="cloneUrlInput" placeholder="https://github.com/owner/repo" autocomplete="off">
    <label>Local folder name (optional):</label>
    <input type="text" id="cloneUrlFolderName" placeholder="Leave empty to auto-name (handles collisions)" autocomplete="off">
    <label>Destination account:</label>
    <select id="cloneUrlAccount">
      <option value="">Loading...</option>
    </select>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('cloneUrlModal')">Cancel</button>
      <button class="btn btn-primary" onclick="doCloneUrl()">Clone</button>
    </div>
  </div>
</div>

<!-- Transfer Modal -->
<div class="modal-overlay" id="transferModal">
  <div class="modal">
    <h3 style="color:var(--orange)">Transfer Repo Between Accounts</h3>
    <p>This permanently changes the repo owner on GitHub. The URL will change.</p>
    <div id="transferInfo" style="background:var(--bg2);border-radius:6px;padding:10px;margin:8px 0;font-size:12px"></div>
    <label>Transfer to account:</label>
    <select id="transferToAccount"></select>
    <label>Type the repo name to confirm:</label>
    <input type="text" id="transferConfirm" placeholder="">
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('transferModal')">Cancel</button>
      <button class="btn btn-danger" id="transferBtn" onclick="doTransfer()">Transfer</button>
    </div>
  </div>
</div>

<!-- Account Manager Modal -->
<div class="modal-overlay" id="accountManagerModal">
  <div class="modal" style="max-width:640px">
    <h3>Account Manager</h3>
    <div id="accountManagerList">
      <div class="account-manager-actions"><button class="btn btn-primary" onclick="showAddAccountForm()">Add Account</button></div>
      <div id="accountManagerCards" class="account-manager-cards"></div>
    </div>
    <div id="accountManagerForm" style="display:none">
      <p id="accountManagerFormTitle" class="account-form-title">Add account</p>
      <input type="hidden" id="accountManagerEditName" value="">
      <label>Account name</label>
      <p class="field-hint">One word, no spaces (e.g. work, freelance). Used for the folder and SSH key name.</p>
      <input type="text" id="accountManagerName" placeholder="work" autocomplete="off">
      <label>Display label</label>
      <p class="field-hint">Name shown in the app (e.g. Work, Freelance).</p>
      <input type="text" id="accountManagerLabel" placeholder="Work">
      <label>GitHub username</label>
      <p class="field-hint">Your GitHub login for this account.</p>
      <input type="text" id="accountManagerGitHubUser" placeholder="myuser">
      <label>Email</label>
      <p class="field-hint">Used for git commits when you use this account.</p>
      <input type="email" id="accountManagerEmail" placeholder="you@example.com">
      <label>SSH host (optional)</label>
      <p class="field-hint">Leave empty for default: github.com-{account name}. Change only if you use a custom SSH config.</p>
      <input type="text" id="accountManagerSshHost" placeholder="github.com-work" autocomplete="off">
      <div class="modal-actions">
        <button class="btn" onclick="hideAccountForm()">Cancel</button>
        <button class="btn btn-primary" id="accountManagerSaveBtn" onclick="saveAccountForm()">Save</button>
      </div>
    </div>
    <div id="accountManagerSetup" style="display:none">
      <h4 id="accountManagerSetupTitle" style="margin-bottom:4px">Setup: <span></span></h4>
      <p style="color:var(--t2);font-size:12px;margin-bottom:12px">Complete each step to connect this account.</p>
      <div id="accountManagerSetupTimeline" class="setup-timeline"></div>
      <div id="accountManagerSetupActions" class="modal-actions" style="margin-top:16px;gap:8px">
        <button class="btn" onclick="closeSetupView()">&#8592; Back</button>
        <button class="setup-action" onclick="recheckSetup()" style="margin-top:0">Re-check</button>
        <button class="setup-action-primary setup-action" id="setupLoadReposBtn" style="display:none;margin-top:0" onclick="setupDoneLoadRepos()">Load Repos &amp; Close</button>
      </div>
    </div>
  </div>
</div>

<!-- GitHub Token Modal -->
<div class="modal-overlay" id="tokenModal">
  <div class="modal" style="max-width:560px">
    <h3>Connect GitHub Account</h3>
    <p>Paste a GitHub fine-grained personal access token. Stored securely in your OS keychain — never written to <code>config.json</code>.</p>
    <input type="hidden" id="tokenModalAccount" value="">
    <div id="tokenModalFor" style="background:var(--bg2);border-radius:8px;padding:10px;margin:10px 0;font-size:12px;color:var(--t2)"></div>
    <label>Personal access token</label>
    <input type="password" id="tokenModalToken" placeholder="github_pat_..." autocomplete="off">
    <label style="display:flex;gap:8px;align-items:center;margin-top:10px">
      <input type="checkbox" id="tokenModalRemember" checked>
      <span>Remember on this machine</span>
    </label>
    <div style="background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-top:14px;font-size:12px;color:var(--t2);line-height:1.7">
      <div style="font-weight:600;color:var(--t1);margin-bottom:6px">How to create a token</div>
      <div>1. Open <a href="https://github.com/settings/personal-access-tokens/new" target="_blank">GitHub &rarr; New fine-grained token</a></div>
      <div>2. Set <strong>Repository access</strong> to <strong>All repositories</strong></div>
      <div>3. Under <strong>Permissions &rarr; Repository permissions</strong>, enable:</div>
      <div style="padding-left:16px">
        <strong>Contents</strong> &mdash; Read-only <span style="color:var(--t3)">(required &mdash; lists all repos including private)</span><br>
        <strong>Metadata</strong> &mdash; Read-only <span style="color:var(--t3)">(auto-selected)</span><br>
        <strong>Administration</strong> &mdash; Read &amp; write <span style="color:var(--t3)">(optional &mdash; allows uploading SSH keys)</span>
      </div>
      <div>4. Click <strong>Generate token</strong> and paste it above</div>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('tokenModal')">Cancel</button>
      <button class="btn btn-danger" id="tokenModalDisconnectBtn" style="display:none" onclick="disconnectToken()">Disconnect</button>
      <button class="btn btn-primary" id="tokenModalConnectBtn" onclick="saveToken()">Connect</button>
    </div>
  </div>
</div>

<!-- Confirm Action Modal (Pull, Fetch, etc.) -->
<div class="modal-overlay" id="confirmActionModal">
  <div class="modal">
    <h3 id="confirmActionTitle">Confirm action</h3>
    <p><strong id="confirmActionRepo"></strong></p>
    <p id="confirmActionMsg" style="color:var(--t2);font-size:13px"></p>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('confirmActionModal')">Cancel</button>
      <button class="btn btn-primary" id="confirmActionBtn" onclick="confirmActionExecute()">Confirm</button>
    </div>
  </div>
</div>

<!-- README Modal -->
<div class="modal-overlay" id="readmeModal">
  <div class="modal modal-readme">
    <h3>README <span class="readme-badge" id="readmeRepoName"></span></h3>
    <div class="modal-body">
      <div id="readmeContent" class="markdown-body"></div>
      <div id="readmeLoading" class="readme-loading" style="display:none"><span class="spinner"></span> Loading...</div>
      <div id="readmeError" style="display:none;color:var(--red);padding:12px 0"></div>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('readmeModal')">Close</button>
    </div>
  </div>
</div>

<!-- Git Modal -->
<div class="modal-overlay" id="gitModal">
  <div class="modal modal-git">
    <h3>Git — <span id="gitModalRepoName"></span></h3>
    <div id="gitModalLoading" class="readme-loading" style="display:none"><span class="spinner"></span> Loading...</div>
    <div id="gitModalBody" style="display:none">
      <div class="git-section">
        <div id="gitModalOperationBanner" class="git-operation-banner" style="display:none"></div>
        <div class="git-section-head">
          <span class="git-label">Branch</span>
          <span class="branch git-branch-current" id="gitCurrentBranch"></span>
          <select id="gitBranchSelect">
            <option value="">Switch branch...</option>
          </select>
          <button type="button" class="btn btn-sm" onclick="doGitCheckout()">Switch</button>
        </div>
        <div id="gitStatusStrip" class="git-status-strip" style="display:none"></div>
        <div class="git-new-branch-row">
          <input type="text" id="gitNewBranchName" placeholder="New branch name">
          <button type="button" class="btn btn-sm btn-primary" onclick="doGitCreateBranch()">New branch</button>
        </div>
      </div>
      <div class="git-section">
        <div class="git-files-head">
          <span class="git-label">Changed files</span>
          <button type="button" class="btn btn-sm" onclick="gitStageAll()">Stage all</button>
          <button type="button" class="btn btn-sm btn-danger" onclick="doGitDiscardSelected()" title="Discard changes in selected files">Discard selected</button>
          <button type="button" class="btn btn-sm btn-danger" onclick="showDiscardAllConfirm()" title="Discard all changes">Discard all</button>
        </div>
        <div id="gitDiscardAllConfirm" class="git-discard-all-confirm" style="display:none">
          <p class="git-discard-all-msg">This will discard all changes. Type <strong>DISCARD</strong> to confirm.</p>
          <label class="git-discard-all-untracked"><input type="checkbox" id="gitDiscardAllIncludeUntracked"> Include untracked files</label>
          <input type="text" id="gitDiscardAllInput" placeholder="DISCARD" class="git-discard-all-input">
          <div class="git-discard-all-btns">
            <button type="button" class="btn btn-sm" onclick="hideDiscardAllConfirm()">Cancel</button>
            <button type="button" class="btn btn-sm btn-danger" id="gitDiscardAllBtn" onclick="doGitDiscardAll()">Confirm</button>
          </div>
        </div>
        <div id="gitFilesList" class="git-files-list"></div>
        <div id="gitDiffPanel" class="git-diff-panel" style="display:none">
          <div class="git-diff-head"><span id="gitDiffTitle" class="git-diff-title"></span><button type="button" class="btn btn-sm" onclick="closeGitDiff()">Close</button></div>
          <div class="git-diff-tabs"><button type="button" class="git-diff-tab active" data-mode="worktree" onclick="switchGitDiffTab(this)">Worktree</button><button type="button" class="git-diff-tab" data-mode="staged" onclick="switchGitDiffTab(this)">Staged</button></div>
          <pre id="gitDiffContent" class="git-diff-content"></pre>
        </div>
      </div>
      <div class="git-section git-stash-section">
        <div class="git-files-head"><span class="git-label">Stash</span><button type="button" class="btn btn-sm" onclick="doGitStashPush()">Stash changes</button></div>
        <div id="gitStashList" class="git-stash-list"></div>
      </div>
      <div class="git-section">
        <div class="git-files-head"><span class="git-label">Commit message</span></div>
        <div class="git-commit-area">
          <textarea id="gitCommitMessage" rows="3" placeholder="Describe your changes..."></textarea>
          <div class="git-actions-row">
            <button type="button" id="gitCommitBtn" class="btn btn-sm btn-primary" onclick="doGitCommit()">Commit</button>
            <button type="button" id="gitPushBtn" class="btn btn-sm" onclick="doGitPush()">Push</button>
            <button type="button" class="btn btn-sm" onclick="doGitPull(false)">Pull</button>
            <button type="button" class="btn btn-sm" onclick="doGitPull(true)">Pull (rebase)</button>
          </div>
        </div>
      </div>
      <div class="git-section">
        <div class="git-files-head"><span class="git-label">Recent commits</span></div>
        <div id="gitRecentCommitsList" class="git-commits-list"></div>
      </div>
    </div>
    <div id="gitModalFeedback" class="git-modal-feedback" role="status"></div>
    <div class="modal-actions" style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border)">
      <button class="btn" onclick="closeModal('gitModal')">Close</button>
    </div>
  </div>
</div>

<!-- Settings Panel -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal settings-panel">
    <h3>Settings</h3>

    <div class="settings-section" id="settingsWorkspace">
      <div class="settings-section-title">Workspace</div>
      <div id="settingsWorkspaceContent"><span style="color:var(--t3);font-size:13px">Loading...</span></div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">About</div>
      <div class="settings-row">
        <span class="settings-label">Version</span>
        <span class="settings-value" id="settingsVersion">-</span>
      </div>
      <div class="settings-row">
        <span class="settings-label">Platform</span>
        <span class="settings-value" id="settingsPlatform">-</span>
      </div>
    </div>

    <div class="settings-section settings-danger">
      <div class="settings-section-title">Danger Zone</div>
      <p style="font-size:12px;color:var(--t3);margin-bottom:10px">
        Remove all GitDock data from this machine (accounts, SSH keys, stored tokens, settings). Cloned repositories will NOT be deleted.
      </p>
      <div id="cleanupArea">
        <button class="btn-cleanup" onclick="startCleanup()">Reset &amp; Clean Up</button>
      </div>
      <div id="cleanupConfirm" style="display:none">
        <p style="font-size:12px;color:var(--red);margin-bottom:6px">This will remove SSH keys, stored tokens, and all settings. Cloned repositories will NOT be deleted.</p>
        <p style="font-size:12px;color:var(--t2);margin-bottom:4px">Type <strong style="color:var(--t1)">DELETE</strong> to confirm:</p>
        <input type="text" class="cleanup-confirm-input" id="cleanupConfirmInput" placeholder="Type DELETE" autocomplete="off">
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn" onclick="cancelCleanup()">Cancel</button>
          <button class="btn-cleanup" id="cleanupExecuteBtn" disabled onclick="executeCleanup()">Confirm Cleanup</button>
        </div>
      </div>
      <div id="cleanupResult" style="display:none">
        <div class="settings-cleanup-steps" id="cleanupSteps"></div>
      </div>
    </div>

    <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
      <a href="mailto:support@gitdock.dev" style="font-size:11px;color:var(--t3);text-decoration:none;transition:color 0.2s" onmouseover="this.style.color='var(--t1)'" onmouseout="this.style.color='var(--t3)'">Need help? Contact support</a>
      <button class="btn" onclick="closeModal('settingsModal')">Close</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked@15.0.7/marked.min.js" integrity="sha384-H+hy9ULve6xfxRkWIh/YOtvDdpXgV2fmAGQkIDTxIgZwNoaoBal14Di2YTMR6MzR" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.4/dist/purify.min.js" integrity="sha384-eEu5CTj3qGvu9PdJuS+YlkNi7d2XxQROAFYOr59zgObtlcux1ae1Il3u7jvdCSWu" crossorigin="anonymous"></script>
<script>
const API = (function() {
  try { return window.location.origin + '/api'; } catch (e) { return '/api'; }
})();
const LANG_COLORS = {'Python':'#3572A5','JavaScript':'#f1e05a','TypeScript':'#3178c6','HTML':'#e34c26','CSS':'#563d7c','Java':'#b07219','C#':'#239120','Go':'#00ADD8','Rust':'#dea584','Ruby':'#701516','PHP':'#4F5D95','Shell':'#89e051','C':'#555555','C++':'#f34b7d','RMarkdown':'#198CE7','Julia':'#a270ba'};
(function(){
  var el = document.getElementById('migratePath');
  if (!el) return;
  var ua = navigator.userAgent || '';
  el.placeholder = /Win/i.test(ua) ? 'C:\\Users\\YourName\\Desktop\\my-project' : (/Mac/i.test(ua) ? '/Users/yourname/Desktop/my-project' : '/home/user/Desktop/my-project');
})();

// Sanitize strings for safe HTML insertion
function esc(str) {
  if (!str) return '';
  var d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}
// Sanitize strings for safe use in JS onclick attributes
function escAttr(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/'/g,'&#39;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

let allRepos = [];
let allAccounts = {};
let accountErrors = {};
let filters = {account:'all',visibility:'all',status:'all',sort:'updated',branch:'all'};
var primaryBranchName = localStorage.getItem('primaryBranchName') || 'main';
var viewDensity = localStorage.getItem('gitdock_viewDensity') || 'comfortable';
var viewColumns = localStorage.getItem('gitdock_viewColumns') || 'auto';
if (!['compact','comfortable','spacious'].includes(viewDensity)) viewDensity = 'comfortable';
if (!['auto','2','3','4'].includes(viewColumns)) viewColumns = 'auto';
function applyViewClasses() {
  var main = document.getElementById('mainContent');
  if (!main) return;
  main.classList.remove('view-compact','view-comfortable','view-spacious','view-cols-auto','view-cols-2','view-cols-3','view-cols-4');
  main.classList.add('view-' + viewDensity);
  if (viewColumns === 'auto') main.classList.add('view-cols-auto');
  else main.classList.add('view-cols-' + viewColumns);
}
function setViewDensity(v) { viewDensity = v; localStorage.setItem('gitdock_viewDensity', v); applyViewClasses(); renderConfigBar(); }
function setViewColumns(v) { viewColumns = v; localStorage.setItem('gitdock_viewColumns', v); applyViewClasses(); renderConfigBar(); }
var viewMode = localStorage.getItem('gitdock_viewMode') || 'grid';
if (viewMode !== 'grid' && viewMode !== 'table') viewMode = 'grid';
function setViewMode(m) { viewMode = m; localStorage.setItem('gitdock_viewMode', m); renderConfigBar(); renderRepos(); }
var focusRepo = null;
let search = '';
let pendingRemove = null;
let pendingTransfer = null;
let pinnedRepos = JSON.parse(localStorage.getItem('pinnedRepos') || '[]');

function getCardPrefs() {
  var raw = localStorage.getItem('gitdock_cardPrefs');
  if (!raw) return { showStars: true, showDisk: true, showLanguage: true, showExtras: true, showLastCommit: true, cardMinimal: false };
  try {
    var p = JSON.parse(raw);
    return {
      showStars: p.showStars !== false,
      showDisk: p.showDisk !== false,
      showLanguage: p.showLanguage !== false,
      showExtras: p.showExtras !== false,
      showLastCommit: p.showLastCommit !== false,
      cardMinimal: p.cardMinimal === true
    };
  } catch (e) { return { showStars: true, showDisk: true, showLanguage: true, showExtras: true, showLastCommit: true, cardMinimal: false }; }
}
function setCardPref(key, value) {
  var p = getCardPrefs();
  p[key] = value;
  localStorage.setItem('gitdock_cardPrefs', JSON.stringify(p));
  renderConfigBar();
  renderRepos();
}

function isPinned(account, name) { return pinnedRepos.some(function(p){ return p.account === account && p.name === name; }); }
function togglePin(account, name) {
  if (isPinned(account, name)) { pinnedRepos = pinnedRepos.filter(function(p){ return !(p.account === account && p.name === name); }); }
  else { pinnedRepos.push({account: account, name: name}); }
  localStorage.setItem('pinnedRepos', JSON.stringify(pinnedRepos));
  renderRepos();
}
let pendingConfirmAction = null; // { action: 'pull'|'fetch', account, name }
let gitModalRepo = null; // { account, name }
let gitModalPushState = null; // { currentBranch, hasUpstream, unpushedCount } for Push button and set-upstream
let logEntries = [];
let repoExtras = {}; // { "account/name": { prs: N, issues: N } }

var repoAliases = JSON.parse(localStorage.getItem('repoAliases') || '{}');

function getAlias(account, name) {
  return repoAliases[account + '/' + name] || '';
}

var pendingAlias = null; // { account, name }

function setAlias(account, name) {
  pendingAlias = { account: account, name: name };
  var key = account + '/' + name;
  var current = repoAliases[key] || '';
  document.getElementById('aliasModalTitle').textContent = 'Alias — ' + name;
  var input = document.getElementById('aliasInput');
  input.value = current;
  openModal('aliasModal');
  setTimeout(function(){ input.focus(); input.select(); }, 100);
}

function confirmAlias(clear) {
  if (!pendingAlias) return;
  var key = pendingAlias.account + '/' + pendingAlias.name;
  if (clear) {
    delete repoAliases[key];
  } else {
    var val = document.getElementById('aliasInput').value.trim();
    if (val === '') { delete repoAliases[key]; }
    else { repoAliases[key] = val; }
  }
  localStorage.setItem('repoAliases', JSON.stringify(repoAliases));
  pendingAlias = null;
  closeModal('aliasModal');
  renderRepos();
}

function setAliasFromMenu(btn) {
  setAlias(btn.dataset.account, btn.dataset.name);
}
var staleDays = parseInt(localStorage.getItem('staleDays') || '90');

function isStale(r) {
  var refDate = (r.isCloned && r.lastCommit && r.lastCommit.date) ? r.lastCommit.date : r.updatedAt;
  if (!refDate) return false;
  var days = Math.floor((new Date() - new Date(refDate)) / 86400000);
  return days > staleDays;
}

function formatSize(kb) {
  if (!kb || kb <= 0) return '';
  if (kb < 1024) return kb + ' KB';
  if (kb < 1048576) return (kb / 1024).toFixed(1).replace(/\.0$/, '') + ' MB';
  return (kb / 1048576).toFixed(1) + ' GB';
}

// --- Toast ---
function toast(msg, type) {
  var c = document.getElementById('toasts');
  var t = document.createElement('div');
  t.className = 'toast toast-' + type;
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(function(){ t.remove(); }, 5000);
}

// --- Copy path (organize / point: dev pastes in terminal or Explorer) ---
function copyRepoPath(btn) {
  var path = btn && btn.getAttribute && btn.getAttribute('data-path');
  if (!path) return;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(path).then(function() { toast('Path copied to clipboard', 'success'); }).catch(function() { fallbackCopy(path); });
  } else { fallbackCopy(path); }
}
function fallbackCopy(text) {
  var ta = document.createElement('textarea'); ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0'; document.body.appendChild(ta); ta.select();
  try { document.execCommand('copy'); toast('Path copied to clipboard', 'success'); } catch (e) { toast('Copy failed', 'error'); }
  document.body.removeChild(ta);
}

function pathToEditorUri(path, editor) {
  if (!path) return '#';
  var normalized = String(path).replace(/\\/g, '/').replace(/ /g, '%20');
  var prefix = (editor === 'vscode') ? 'vscode://file/' : 'cursor://file/';
  return prefix + normalized;
}

function toggleEditorMenu(btn) {
  var wrap = btn.closest('.open-editor-wrap');
  if (!wrap) return;
  var menu = wrap.querySelector('.editor-menu');
  if (!menu) return;
  document.querySelectorAll('.editor-menu.show').forEach(function(m) { if (m !== menu) m.classList.remove('show'); });
  menu.classList.toggle('show');
}

function toggleCardMenu(btn) {
  var wrap = btn.closest('.card-menu-wrap');
  if (!wrap) return;
  var menu = wrap.querySelector('.card-menu');
  if (!menu) return;
  document.querySelectorAll('.card-menu.show').forEach(function(m) { if (m !== menu) m.classList.remove('show'); });
  menu.classList.toggle('show');
}

function copyRepoPathFromMenu(btn) {
  var path = btn && btn.getAttribute && btn.getAttribute('data-path');
  if (!path) return;
  var wrap = btn.closest('.card-menu-wrap');
  if (wrap) { var m = wrap.querySelector('.card-menu'); if (m) m.classList.remove('show'); }
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(path).then(function() { toast('Path copied to clipboard', 'success'); }).catch(function() { fallbackCopy(path); });
  } else { fallbackCopy(path); }
}

function askRemoveFromMenu(btn) {
  var account = btn && btn.dataset && btn.dataset.account;
  var name = btn && btn.dataset && btn.dataset.name;
  if (!account || !name) return;
  var wrap = btn.closest('.card-menu-wrap');
  if (wrap) { var m = wrap.querySelector('.card-menu'); if (m) m.classList.remove('show'); }
  askRemove(account, name);
}

function openEditorNewWindow(btn) {
  var p = btn && btn.getAttribute && btn.getAttribute('data-path');
  var editor = btn && btn.getAttribute && btn.getAttribute('data-editor');
  if (!p || !editor) return;
  var wrap = btn.closest('.card-menu-wrap');
  if (wrap) { var m = wrap.querySelector('.card-menu'); if (m) m.classList.remove('show'); }
  apiPost('/open-editor', { path: p, editor: editor }).then(function(data) {
    if (data.success) toast(editor + ' opened in new window', 'success');
    else toast('Failed to open ' + editor + ': ' + (data.error || ''), 'error');
  }).catch(function() { toast('Failed to open ' + editor, 'error'); });
}

function openTerminal(btn) {
  var p = btn && btn.getAttribute && btn.getAttribute('data-path');
  if (!p) return;
  var wrap = btn.closest('.card-menu-wrap');
  if (wrap) { var m = wrap.querySelector('.card-menu'); if (m) m.classList.remove('show'); }
  apiPost('/open-terminal', { path: p }).then(function(data) {
    if (data.success) toast('Terminal opened', 'success');
    else toast('Failed to open terminal', 'error');
  }).catch(function() { toast('Failed to open terminal', 'error'); });
}

(function closeEditorMenusOnClickOutside() {
  document.addEventListener('click', function() {
    document.querySelectorAll('.editor-menu.show').forEach(function(m) { m.classList.remove('show'); });
    document.querySelectorAll('.card-menu.show').forEach(function(m) { m.classList.remove('show'); });
  });
})();

// --- Activity Log ---
function addLog(msg, type) {
  var now = new Date().toLocaleTimeString();
  logEntries.unshift({time: now, msg: msg, type: type || 'info'});
  if (logEntries.length > 50) logEntries.pop();
  renderLog();
}

function renderLog() {
  var el = document.getElementById('logEntries');
  var section = document.getElementById('logSection');
  var countEl = document.getElementById('logCount');
  if (countEl) countEl.textContent = logEntries.length;
  if (logEntries.length === 0) {
    el.innerHTML = '<div class="log-empty">No activity yet</div>';
  } else {
    el.innerHTML = logEntries.map(function(e) {
      var cls = e.type === 'ok' ? 'log-ok' : e.type === 'err' ? 'log-err' : e.type === 'warn' ? 'log-warn' : '';
      return '<div class="log-entry"><span class="log-time">' + esc(e.time) + '</span><span class="' + cls + '">' + esc(e.msg) + '</span></div>';
    }).join('');
  }
  section.style.display = 'flex';
}

// --- Modal ---
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) {
  document.getElementById(id).classList.remove('show');
  if (id === 'accountManagerModal') { currentSetupAccount = null; }
  if (id === 'settingsModal') { cancelCleanup(); }
}

// --- Settings Panel ---
function openSettingsPanel() {
  openModal('settingsModal');
  loadSettingsData();
}

async function loadSettingsData() {
  // Load workspace info
  try {
    var ws = await apiGet('/workspace/status');
    var wh = '';
    if (ws.configured && ws.path) {
      wh += '<div class="settings-row"><span class="settings-label">Path</span><span class="settings-value" style="font-size:12px">' + esc(ws.path) + '</span></div>';
    } else {
      wh += '<div class="settings-row"><span class="settings-label">Path</span><span class="settings-value dim">Not configured</span></div>';
    }
    document.getElementById('settingsWorkspaceContent').innerHTML = wh;
  } catch (e) {
    document.getElementById('settingsWorkspaceContent').innerHTML = '<span style="color:var(--t3);font-size:12px">Could not load workspace info</span>';
  }

  // Load version
  try {
    var ver = await apiGet('/version');
    document.getElementById('settingsVersion').textContent = 'v' + (ver.version || '1.0.0');
  } catch (e) {
    document.getElementById('settingsVersion').textContent = 'v1.0.0';
  }

  // Platform
  var ua = navigator.userAgent || '';
  var platform = ua.includes('Win') ? 'Windows' : ua.includes('Mac') ? 'macOS' : ua.includes('Linux') ? 'Linux' : 'Unknown';
  document.getElementById('settingsPlatform').textContent = platform;
}

function startCleanup() {
  document.getElementById('cleanupArea').style.display = 'none';
  document.getElementById('cleanupConfirm').style.display = 'block';
  document.getElementById('cleanupConfirmInput').value = '';
  document.getElementById('cleanupExecuteBtn').disabled = true;
  document.getElementById('cleanupConfirmInput').focus();
  document.getElementById('cleanupConfirmInput').addEventListener('input', function() {
    document.getElementById('cleanupExecuteBtn').disabled = this.value.trim() !== 'DELETE';
  });
}

function cancelCleanup() {
  document.getElementById('cleanupArea').style.display = '';
  document.getElementById('cleanupConfirm').style.display = 'none';
  document.getElementById('cleanupResult').style.display = 'none';
}

async function executeCleanup() {
  if (document.getElementById('cleanupConfirmInput').value.trim() !== 'DELETE') return;
  document.getElementById('cleanupExecuteBtn').disabled = true;
  document.getElementById('cleanupExecuteBtn').textContent = 'Cleaning up...';
  try {
    var data = await apiPost('/cleanup', {});
    document.getElementById('cleanupConfirm').style.display = 'none';
    document.getElementById('cleanupResult').style.display = 'block';
    var stepsHtml = '';
    if (data.steps && data.steps.length) {
      for (var i = 0; i < data.steps.length; i++) {
        stepsHtml += '<div>' + esc(data.steps[i]) + '</div>';
      }
    }
    document.getElementById('cleanupSteps').innerHTML = stepsHtml || '<div>Cleanup complete</div>';
    if (data.success) {
      toast('Cleanup complete. Redirecting...', 'success');
      setTimeout(function() { window.location.href = '/'; }, 2500);
    }
  } catch (e) {
    toast('Cleanup failed. Check your connection.', 'error');
    document.getElementById('cleanupExecuteBtn').textContent = 'Confirm Cleanup';
    document.getElementById('cleanupExecuteBtn').disabled = false;
  }
}

// --- API Calls ---
async function apiGet(path) {
  var r = await fetch(API + path);
  if (!r.ok && r.status >= 500) console.warn('[api] GET ' + path + ' returned ' + r.status);
  return r.json();
}

async function apiPost(path, body) {
  var r = await fetch(API + path, {method:'POST',headers:{'Content-Type':'application/json','X-GitDock':'1'},body:JSON.stringify(body)});
  if (!r.ok && r.status >= 500) console.warn('[api] POST ' + path + ' returned ' + r.status);
  return r.json();
}

async function apiPut(path, body) {
  var r = await fetch(API + path, {method:'PUT',headers:{'Content-Type':'application/json','X-GitDock':'1'},body:JSON.stringify(body)});
  if (!r.ok && r.status >= 500) console.warn('[api] PUT ' + path + ' returned ' + r.status);
  return r.json();
}

async function apiDelete(path) {
  var r = await fetch(API + path, {method:'DELETE',headers:{'X-GitDock':'1'}});
  if (!r.ok && r.status >= 500) console.warn('[api] DELETE ' + path + ' returned ' + r.status);
  return r.json();
}

// --- Load Accounts (dynamic from server) ---
async function loadAccounts() {
  try {
    var data = await apiGet('/accounts');
    if (data && data.accounts && Array.isArray(data.accounts)) {
      allAccounts = {};
      data.accounts.forEach(function(acc) {
        allAccounts[acc.name] = { name: acc.name, githubUser: acc.githubUser, sshHost: acc.sshHost, label: acc.label || acc.name, email: acc.email || '' };
      });
      populateAccountSelects();
      return true;
    }
    if (typeof addLog === 'function') addLog('Accounts API returned no list', 'warn');
  } catch (e) {
    if (typeof addLog === 'function') addLog('Accounts list could not be loaded: ' + (e.message || 'network error'), 'warn');
  }
  return false;
}

function populateAccountSelects() {
  var opts = Object.keys(allAccounts).map(function(name) {
    var acc = allAccounts[name];
    return '<option value="'+escAttr(name)+'">' + esc(acc.label) + ' (' + esc(acc.githubUser) + ')</option>';
  }).join('');
  var migrateSel = document.getElementById('migrateAccount');
  var cloneUrlSel = document.getElementById('cloneUrlAccount');
  if (migrateSel) migrateSel.innerHTML = opts || '<option value="">No accounts</option>';
  if (cloneUrlSel) cloneUrlSel.innerHTML = opts || '<option value="">No accounts</option>';
}

function getAccountLabel(accountName) {
  return (allAccounts[accountName] && allAccounts[accountName].label) ? allAccounts[accountName].label : accountName;
}

function getAccountBadgeClass(accountName) {
  var keys = getAccountOrder();
  var i = keys.indexOf(accountName);
  if (i < 0) return 'b-idx-0';
  if (accountName === 'professional') return 'b-professional';
  if (accountName === 'personal') return 'b-personal';
  return 'b-idx-' + (i % 6);
}

// Single source for section order and filter list. Prefer server config (allAccounts);
// fall back to accounts present in repo list when config has not loaded yet (resilience).
function getAccountOrder() {
  var keys = Object.keys(allAccounts);
  if (keys.length > 0) return keys;
  var set = {};
  allRepos.forEach(function(r) { if (r && r.account) set[r.account] = true; });
  return Object.keys(set);
}

// --- Account Manager ---
async function openAccountManager() {
  document.getElementById('accountManagerList').style.display = 'block';
  document.getElementById('accountManagerForm').style.display = 'none';
  document.getElementById('accountManagerSetup').style.display = 'none';
  openModal('accountManagerModal');
  // Open immediately for UX; load accounts in background (server can be busy on first load).
  var cards = document.getElementById('accountManagerCards');
  if (cards) cards.innerHTML = '<p class="account-manager-empty">Loading accounts...</p>';
  await loadAccounts();
  renderAccountList();
}

function renderAccountList() {
  var el = document.getElementById('accountManagerCards');
  if (!el) return;
  var keys = Object.keys(allAccounts);
  var h = keys.length === 0 ? '<p class="account-manager-empty">No accounts. Add one to get started.</p>' : '';
  keys.forEach(function(name) {
    var acc = allAccounts[name];
    var label = (acc && acc.label) ? acc.label : name;
    var user = (acc && acc.githubUser) ? acc.githubUser : '';
    h += '<div class="account-manager-card">' +
      '<div class="account-manager-card-header">' +
        '<span class="badge ' + getAccountBadgeClass(name) + '">' + esc(label) + '</span>' +
        '<span class="account-manager-user">' + esc(user) + '</span>' +
      '</div>' +
      '<div class="account-manager-card-actions">' +
        '<button class="btn btn-sm" onclick="showEditAccountForm(\'' + escAttr(name) + '\')">Edit</button>' +
        '<button class="btn btn-sm" onclick="openSetupView(\'' + escAttr(name) + '\')">Setup Status</button>' +
        '<button class="btn btn-sm btn-danger" onclick="deleteAccount(\'' + escAttr(name) + '\')">Delete</button>' +
      '</div>' +
    '</div>';
  });
  el.innerHTML = h;
}

async function loadHubStatus() {
  var el = document.getElementById('hubStatus');
  var row = document.getElementById('hubStatusRow');
  var textEl = document.getElementById('hubStatusText');
  var hubLink = document.getElementById('hubLinkBtn');
  if (!el) return;
  try {
    var data = await apiGet('/hub/status');
    if (data.configured && data.url) {
      var label = (data.machineName || 'This machine') + ' \u2192 Hub';
      el.textContent = label;
      el.classList.add('connected');
      el.style.display = 'none';
      if (row) {
        row.style.display = 'flex';
        if (textEl) textEl.textContent = label;
      }
      if (hubLink) {
        hubLink.href = data.url;
        hubLink.setAttribute('target', '_blank');
        hubLink.setAttribute('rel', 'noopener');
        hubLink.setAttribute('data-configured', 'true');
        hubLink.title = 'Open Hub (multi-machine overview)';
      }
    } else {
      el.style.display = '';
      el.textContent = 'Not configured';
      el.classList.remove('connected');
      if (row) row.style.display = 'none';
      if (hubLink) {
        hubLink.href = '#';
        hubLink.removeAttribute('target');
        hubLink.removeAttribute('rel');
        hubLink.setAttribute('data-configured', 'false');
        hubLink.title = 'Configure Hub to see multi-machine overview';
      }
    }
  } catch (e) {
    el.style.display = '';
    el.textContent = '—';
    el.classList.remove('connected');
    if (row) row.style.display = 'none';
    if (hubLink) {
      hubLink.href = '#';
      hubLink.removeAttribute('target');
      hubLink.setAttribute('data-configured', 'false');
      hubLink.title = 'Configure Hub';
    }
  }
}

function openHubDisconnectModal() {
  openModal('hubDisconnectModal');
}

async function confirmHubDisconnect() {
  try {
    var data = await apiPost('/hub/config', { url: '', apiKey: '' });
    if (data.success) {
      closeModal('hubDisconnectModal');
      toast('Hub connection removed', 'success');
      loadHubStatus();
    } else {
      toast(data.error || 'Failed to remove', 'error');
    }
  } catch (e) {
    toast(e.message || 'Request failed', 'error');
  }
}

function openHubModal() {
  // Open immediately with defaults — never make the user wait
  document.getElementById('hubUrlInput').value = 'https://hub.gitdock.dev';
  document.getElementById('hubApiKeyInput').value = '';
  document.getElementById('hubMachineNameInput').value = '';
  document.getElementById('hubIntervalInput').value = 3;
  updateHubGetKeyLink();
  openModal('hubModal');
  // Then fill with saved values in background (if any)
  apiGet('/hub/status').then(function(data) {
    if (data.url) document.getElementById('hubUrlInput').value = data.url;
    if (data.machineName) document.getElementById('hubMachineNameInput').value = data.machineName;
    if (data.intervalMinutes) document.getElementById('hubIntervalInput').value = data.intervalMinutes;
    updateHubGetKeyLink();
  }).catch(function() {});
}

function updateHubGetKeyLink() {
  var urlInput = document.getElementById('hubUrlInput');
  var link = document.getElementById('hubGetKeyLink');
  if (!link) return;
  var url = (urlInput.value || '').trim().replace(/\/+$/, '');
  link.href = url || '#';
  link.style.opacity = url ? '' : '0.4';
  link.style.pointerEvents = url ? '' : 'none';
}

function openHubForKey(e) {
  e.preventDefault();
  var urlInput = document.getElementById('hubUrlInput');
  var url = (urlInput.value || '').trim().replace(/\/+$/, '');
  if (!url) {
    toast('Enter the Hub URL first', 'warning');
    urlInput.focus();
    return;
  }
  window.open(url, '_blank', 'noopener');
}
// Keep the "Get API Key" link in sync with the Hub URL field
document.getElementById('hubUrlInput').addEventListener('input', updateHubGetKeyLink);

async function saveHubConfig() {
  var url = document.getElementById('hubUrlInput').value.trim();
  var apiKey = document.getElementById('hubApiKeyInput').value.trim();
  var machineName = document.getElementById('hubMachineNameInput').value.trim();
  var interval = parseInt(document.getElementById('hubIntervalInput').value, 10) || 3;
  var payload = { url: url || undefined, intervalMinutes: interval, machineName: machineName || undefined };
  if (apiKey) payload.apiKey = apiKey;
  try {
    var data = await apiPost('/hub/config', payload);
    if (data.success) {
      toast('Hub configuration saved', 'success');
      closeModal('hubModal');
      loadHubStatus();
    } else {
      toast(data.error || 'Save failed', 'error');
    }
  } catch (e) {
    toast(e.message || 'Request failed', 'error');
  }
}

function syncAccountNameSuggestions() {
  var editName = document.getElementById('accountManagerEditName').value;
  if (editName) return;
  var raw = (document.getElementById('accountManagerName').value || '').trim();
  var slug = raw.toLowerCase().replace(/[^a-z0-9\-]/g, '');
  if (slug.length > 0) {
    var label = slug.charAt(0).toUpperCase() + slug.slice(1);
    document.getElementById('accountManagerLabel').value = label;
    document.getElementById('accountManagerSshHost').value = 'github.com-' + slug;
  }
}

function showAddAccountForm() {
  document.getElementById('accountManagerEditName').value = '';
  document.getElementById('accountManagerName').value = '';
  document.getElementById('accountManagerName').disabled = false;
  document.getElementById('accountManagerLabel').value = '';
  document.getElementById('accountManagerGitHubUser').value = '';
  document.getElementById('accountManagerEmail').value = '';
  document.getElementById('accountManagerSshHost').value = '';
  document.getElementById('accountManagerFormTitle').textContent = 'Add account';
  document.getElementById('accountManagerSaveBtn').textContent = 'Add';
  document.getElementById('accountManagerList').style.display = 'none';
  document.getElementById('accountManagerForm').style.display = 'block';
  var nameEl = document.getElementById('accountManagerName');
  nameEl.removeEventListener('input', syncAccountNameSuggestions);
  nameEl.addEventListener('input', syncAccountNameSuggestions);
}

function showEditAccountForm(name) {
  var acc = allAccounts[name];
  if (!acc) return;
  document.getElementById('accountManagerEditName').value = name;
  document.getElementById('accountManagerName').value = name;
  document.getElementById('accountManagerName').disabled = true;
  document.getElementById('accountManagerLabel').value = acc.label || name;
  document.getElementById('accountManagerGitHubUser').value = acc.githubUser || '';
  document.getElementById('accountManagerEmail').value = acc.email || '';
  document.getElementById('accountManagerSshHost').value = acc.sshHost || ('github.com-' + name);
  document.getElementById('accountManagerFormTitle').textContent = 'Edit account';
  document.getElementById('accountManagerSaveBtn').textContent = 'Save';
  document.getElementById('accountManagerList').style.display = 'none';
  document.getElementById('accountManagerForm').style.display = 'block';
}

function hideAccountForm() {
  document.getElementById('accountManagerForm').style.display = 'none';
  document.getElementById('accountManagerList').style.display = 'block';
  renderAccountList();
}

async function saveAccountForm() {
  var editName = document.getElementById('accountManagerEditName').value.trim();
  var name = document.getElementById('accountManagerName').value.trim().toLowerCase().replace(/[^a-z0-9\-]/g, '');
  var label = document.getElementById('accountManagerLabel').value.trim();
  var githubUser = document.getElementById('accountManagerGitHubUser').value.trim();
  var email = document.getElementById('accountManagerEmail').value.trim();
  var sshHost = document.getElementById('accountManagerSshHost').value.trim();
  if (!name) { toast('Account name is required', 'error'); return; }
  if (!githubUser) { toast('GitHub username is required', 'error'); return; }
  try {
    if (editName) {
      var r = await fetch(API + '/accounts/' + encodeURIComponent(editName), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'X-GitDock': '1' },
        body: JSON.stringify({ label: label || name, githubUser: githubUser, email: email, sshHost: sshHost || ('github.com-' + name) })
      });
      var data = await r.json();
      if (data.ok) {
        toast('Account updated', 'success');
        await loadAccounts();
        hideAccountForm();
        renderAccountList();
        refreshRepos();
      }
      else { toast(data.error || 'Update failed', 'error'); }
    } else {
      var r2 = await fetch(API + '/accounts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-GitDock': '1' },
        body: JSON.stringify({ name: name, label: label || name, githubUser: githubUser, email: email, sshHost: sshHost || ('github.com-' + name) })
      });
      var data2 = await r2.json();
      if (data2.ok) {
        toast('Account added — complete the setup below', 'success');
        await loadAccounts();
        hideAccountForm();
        renderAccountList();
        openSetupView(name);
      }
      else { toast(data2.error || 'Add failed', 'error'); }
    }
  } catch (e) { toast('Error: ' + e.message, 'error'); }
}

async function deleteAccount(name) {
  if (!confirm('Remove account "' + name + '"? You must remove any cloned repos first, or use force.')) return;
  try {
    var r = await fetch(API + '/accounts/' + encodeURIComponent(name), { method: 'DELETE', headers: { 'X-GitDock': '1' } });
    var data = await r.json();
    if (data.ok) {
      toast('Account removed', 'success');
      await loadAccounts();
      renderAccountList();
      refreshRepos();
    }
    else { toast(data.error || 'Delete failed', 'error'); }
  } catch (e) { toast('Error: ' + e.message, 'error'); }
}

var currentSetupAccount = null;

function openSetupView(name) {
  currentSetupAccount = name;
  lastPublicKey = null;
  var acc = allAccounts[name];
  document.getElementById('accountManagerSetupTitle').querySelector('span').textContent = (acc && acc.label) ? acc.label + ' (' + (acc.githubUser || '') + ')' : name;
  document.getElementById('accountManagerList').style.display = 'none';
  document.getElementById('accountManagerForm').style.display = 'none';
  document.getElementById('accountManagerSetup').style.display = 'block';
  var loadBtn = document.getElementById('setupLoadReposBtn');
  if (loadBtn) loadBtn.style.display = 'none';
  checkAccountStatus(name);
}

function closeSetupView() {
  document.getElementById('accountManagerSetup').style.display = 'none';
  document.getElementById('accountManagerList').style.display = 'block';
  currentSetupAccount = null;
}

var lastPublicKey = null;

async function checkAccountStatus(name, publicKeyToShow) {
  var el = document.getElementById('accountManagerSetupTimeline');
  if (!el) return;
  el.innerHTML = '<p style="color:var(--t2)">Checking status...</p>';
  var requestedFor = name;
  if (publicKeyToShow) lastPublicKey = publicKeyToShow;
  try {
    var url = API + '/accounts/' + encodeURIComponent(name) + '/status?_=' + Date.now();
    var r = await fetch(url);
    var s = await r.json();
    if (currentSetupAccount !== requestedFor) return;
    if (s.accountName && s.accountName !== requestedFor) return;
    var acc = allAccounts[requestedFor];
    var ghUser = (acc ? acc.githubUser : '');

    // If SSH key exists but we don't have the public key cached, fetch it so the user can copy/paste.
    if (s.sshKeyExists && !publicKeyToShow && !lastPublicKey) {
      try {
        var pk = await apiGet('/accounts/' + encodeURIComponent(requestedFor) + '/ssh/public-key?_=' + Date.now());
        if (currentSetupAccount !== requestedFor) return;
        if (pk && pk.ok && pk.publicKey) lastPublicKey = pk.publicKey;
      } catch (e) { /* ignore */ }
    }

    var h = '';
    var step = function(num, title, done, extra) {
      var dotClass = done ? 'done' : (extra ? 'pending' : 'pending');
      var dotText = done ? '\u2713' : num;
      h += '<div class="setup-step"><div class="setup-step-dot ' + dotClass + '">' + dotText + '</div><div class="setup-step-body"><strong>' + title + '</strong>' + (extra || '') + '</div></div>';
    };

    // Step 1: Account registered
    step(1, 'Account registered', true);

    // Step 2: SSH key
    var step2Extra = '';
    if (s.sshKeyExists && (publicKeyToShow || lastPublicKey)) {
      var key = publicKeyToShow || lastPublicKey;
      step2Extra = '<div class="setup-public-key">' + esc(key) + '</div>' +
        '<div style="margin-top:8px"><button class="setup-action" onclick="copyPublicKey()">Copy Key</button></div>' +
        '<div class="setup-hint">Copy the key, then <a href="https://github.com/settings/ssh/new" target="_blank" style="color:var(--green);text-decoration:underline">add it on GitHub</a> in the next step.</div>';
    } else if (!s.sshKeyExists) {
      step2Extra = '<div style="margin-top:8px"><button class="setup-action setup-action-primary" onclick="runSetupSSH(\'' + escAttr(requestedFor) + '\')">Generate SSH Key</button></div>';
    } else if (s.sshKeyExists && !lastPublicKey) {
      step2Extra = '<div style="margin-top:8px"><button class="setup-action" onclick="recheckSetup()">Load Key</button></div>';
    }
    step(2, 'SSH key generated', s.sshKeyExists, step2Extra);

    // Step 3: SSH key on GitHub
    var step3Extra = '';
    if (s.sshKeyExists && !s.sshConnects) {
      step3Extra = '<div class="setup-hint">Required for cloning and pushing repos.</div>' +
        '<div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">' +
        (s.tokenAuthenticated ? ('<button class="setup-action setup-action-primary" onclick="uploadSshKey(\'' + escAttr(requestedFor) + '\')">Upload Key to GitHub</button>') : '') +
        '<a href="https://github.com/settings/keys" target="_blank" class="setup-action" style="text-decoration:none">Add Manually on GitHub &rarr;</a>' +
        '</div>';
    }
    step(3, 'SSH key added to GitHub', s.sshConnects, step3Extra);

    // Step 4: GitHub API auth (private repos)
    var authDone = !!(s.tokenAuthenticated || s.ghAuthenticated);
    var authExtra = '';
    if (s.tokenAuthenticated) {
      authExtra = '<div style="display:flex;gap:8px;align-items:center;margin-top:6px">' +
        '<span style="color:var(--green);font-size:12px">&#10003; Connected as <strong>' + esc(s.tokenLogin || ghUser) + '</strong></span>' +
        '<button class="setup-action" onclick="openTokenModal(\'' + escAttr(requestedFor) + '\')">Manage</button></div>';
    } else if (!s.ghAuthenticated) {
      authExtra = '<div class="setup-hint">Connect a personal access token to load all repos (including private).</div>' +
        '<div style="margin-top:8px"><button class="setup-action setup-action-primary" onclick="openTokenModal(\'' + escAttr(requestedFor) + '\')">Connect Token</button></div>' +
        '<details style="margin-top:8px"><summary style="cursor:pointer;color:var(--t3);font-size:12px">Advanced: use gh CLI instead</summary>' +
        '<div class="setup-public-key" style="margin-top:6px">gh auth login</div>' +
        '<div class="setup-hint">If multiple accounts, switch with: <code>gh auth switch --user ' + esc(ghUser) + '</code></div></details>';
    } else if (s.ghAuthenticated && s.ghActive === false) {
      authExtra = '<div class="setup-hint" style="color:var(--t3)">Using gh CLI, but not active. Run: <code>gh auth switch --user ' + esc(ghUser) + '</code></div>';
    } else {
      authExtra = '<div style="margin-top:4px;font-size:12px;color:var(--green)">&#10003; Using gh CLI</div>';
    }
    step(4, 'GitHub access (private repos)', authDone, authExtra);

    // Step 5: Git config
    step(5, 'Git config created', s.gitconfigExists, '');

    // Step 6: Ready
    var readyExtra = '';
    if (s.ready) {
      readyExtra = '<div style="margin-top:6px;color:var(--green);font-size:13px;font-weight:500">&#10003; All set! Click <strong>Load Repos &amp; Close</strong> below.</div>';
    } else {
      readyExtra = '<div class="setup-hint">Complete the steps above, then click <strong>Re-check</strong>.</div>';
    }
    step(6, 'Ready', s.ready, readyExtra);

    el.innerHTML = h;

    // Show/hide "Load Repos & Close" button
    var loadBtn = document.getElementById('setupLoadReposBtn');
    if (loadBtn) loadBtn.style.display = s.ready ? 'inline-flex' : 'none';
  } catch (e) {
    if (currentSetupAccount !== requestedFor) return;
    el.innerHTML = '<p class="log-err">Failed to load status: ' + esc(e.message) + '</p>';
  }
}

function recheckSetup() {
  if (!currentSetupAccount) return;
  lastPublicKey = lastPublicKey || null;
  checkAccountStatus(currentSetupAccount, null);
}


function setupDoneLoadRepos() {
  closeSetupView();
  closeModal('accountManagerModal');
  toast('Loading repos...', 'info');
  refreshRepos();
}

async function runSetupSSH(name) {
  try {
    var r = await fetch(API + '/accounts/' + encodeURIComponent(name) + '/setup-ssh', { method: 'POST', headers: { 'X-GitDock': '1' } });
    var data = await r.json();
    if (data.ok && data.publicKey) {
      toast('SSH key generated. Now add it to GitHub.', 'success');
      lastPublicKey = data.publicKey;
      checkAccountStatus(name, data.publicKey);
    } else { toast(data.error || 'Setup failed', 'error'); }
  } catch (e) { toast('Error: ' + e.message, 'error'); }
}

function openTokenModal(accountName) {
  var acc = allAccounts[accountName];
  document.getElementById('tokenModalAccount').value = accountName;
  document.getElementById('tokenModalToken').value = '';
  document.getElementById('tokenModalRemember').checked = true;
  document.getElementById('tokenModalFor').innerHTML =
    'Account: <strong>' + esc(acc && acc.label ? acc.label : accountName) + '</strong>' +
    (acc && acc.githubUser ? ('<div style="margin-top:4px">GitHub user: <code>' + esc(acc.githubUser) + '</code></div>') : '');
  // Toggle disconnect button based on current status (best-effort).
  var disconnectBtn = document.getElementById('tokenModalDisconnectBtn');
  if (disconnectBtn) disconnectBtn.style.display = 'none';
  openModal('tokenModal');
  // Ask server for connection status
  apiGet('/accounts/' + encodeURIComponent(accountName) + '/auth/status').then(function(s) {
    if (document.getElementById('tokenModalAccount').value !== accountName) return;
    if (disconnectBtn) disconnectBtn.style.display = (s && s.connected) ? 'inline-flex' : 'none';
  }).catch(function(){});
}

async function saveToken() {
  var name = document.getElementById('tokenModalAccount').value;
  var token = (document.getElementById('tokenModalToken').value || '').trim();
  var remember = !!document.getElementById('tokenModalRemember').checked;
  if (!name) return;
  if (!token) { toast('Token is required', 'error'); return; }
  try {
    var data = await apiPost('/accounts/' + encodeURIComponent(name) + '/auth/token', { token: token, remember: remember });
    if (data && data.ok) {
      closeModal('tokenModal');
      toast('Account connected: ' + (data.login || name), 'success');
      checkAccountStatus(name);
      refreshRepos();
    } else {
      toast((data && data.error) ? data.error : 'Failed to connect token', 'error');
    }
  } catch (e) {
    toast('Error: ' + e.message, 'error');
  }
}

async function disconnectToken() {
  var name = document.getElementById('tokenModalAccount').value;
  if (!name) return;
  try {
    var r = await fetch(API + '/accounts/' + encodeURIComponent(name) + '/auth/token', { method: 'DELETE', headers: { 'X-GitDock': '1' } });
    var data = await r.json();
    if (data && data.ok) {
      closeModal('tokenModal');
      toast('Disconnected', 'success');
      checkAccountStatus(name);
      refreshRepos();
    } else {
      toast((data && data.error) ? data.error : 'Failed to disconnect', 'error');
    }
  } catch (e) { toast('Error: ' + e.message, 'error'); }
}

async function uploadSshKey(name) {
  try {
    var data = await apiPost('/accounts/' + encodeURIComponent(name) + '/github/ssh-key', {});
    if (data && data.ok) {
      toast(data.alreadyExists ? 'SSH key already exists on GitHub.' : 'SSH key uploaded to GitHub.', 'success');
      checkAccountStatus(name);
    } else {
      toast((data && data.error) ? data.error : 'Upload failed', 'error');
    }
  } catch (e) { toast('Error: ' + e.message, 'error'); }
}

function copyPublicKey() {
  if (!lastPublicKey) { toast('Public key not loaded yet', 'error'); return; }
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(lastPublicKey).then(function() {
      toast('SSH public key copied', 'success');
    }).catch(function() {
      fallbackCopy(lastPublicKey);
    });
  } else {
    fallbackCopy(lastPublicKey);
  }
}

// --- Load Repos ---
async function refreshRepos() {
  var spinner = document.getElementById('refreshSpinner');
  if (spinner) spinner.style.display = 'inline-block';
  await loadAccounts();
  addLog('Refreshing repos from GitHub...', 'info');
  try {
    var data = await apiGet('/repos');
    if (data.success) {
      allRepos = data.repos || [];
      accountErrors = data.accountErrors || {};
      document.getElementById('lastUpdated').textContent = 'Updated: ' + new Date(data.timestamp).toLocaleTimeString();
      renderAll();
      addLog('Loaded ' + allRepos.length + ' repos', 'ok');
      if (Object.keys(allAccounts).length === 0 && allRepos.length > 0) {
        var retry = await loadAccounts();
        if (retry) renderAll();
      }
      loadExtras();
    } else {
      toast('Failed to load repos: ' + data.error, 'error');
      addLog('Failed to load repos: ' + data.error, 'err');
    }
  } catch(e) {
    toast('Server not running. Start with: node server.js', 'error');
    document.getElementById('lastUpdated').innerHTML = '<span class="status-dot-live dot-off"></span> Server offline';
    addLog('Server connection failed', 'err');
  }
  if (spinner) spinner.style.display = 'none';
}

// --- Render ---
function renderAll() {
  applyViewClasses();
  renderConfigBar();
  renderStats();
  renderAttention();
  renderFilters();
  renderRepos();
  loadHubStatus();
}

// --- Background: Load PR/Issue counts ---
async function loadExtras() {
  if (allRepos.length === 0) return;
  try {
    var repoList = allRepos.map(function(r) { return { account: r.account, name: r.name }; });
    var data = await apiPost('/repos/extras', { repos: repoList });
    if (data.success && data.extras) {
      repoExtras = data.extras;
      applyExtras();
    }
  } catch(e) {
    // Extras are non-critical; silently ignore
  }
}

function applyExtras() {
  document.querySelectorAll('.extras-pills').forEach(function(el) {
    var key = el.dataset.extrasKey;
    if (!repoExtras[key]) return;
    var h = '';
    if (repoExtras[key].prs > 0) h += '<span class="extras-pill pill-pr">\u21D7 ' + repoExtras[key].prs + ' PR</span>';
    if (repoExtras[key].issues > 0) h += '<span class="extras-pill pill-issues">\u25CF ' + repoExtras[key].issues + ' issue' + (repoExtras[key].issues > 1 ? 's' : '') + '</span>';
    el.innerHTML = h;
  });
}

function renderAttention() {
  var panel = document.getElementById('attentionPanel');
  var needs = allRepos.filter(function(r) {
    return r.isCloned && (r.localStatus === 'dirty' || r.localStatus === 'ahead' || r.localStatus === 'behind');
  });
  if (needs.length === 0) { panel.style.display = 'none'; return; }
  panel.style.display = 'block';
  var h = '<div class="attention-title">&#9888; Needs attention <span class="sec-cnt">' + needs.length + '</span></div><ul class="attention-list">';
  needs.forEach(function(r) {
    var sc = r.localStatus === 'dirty' ? 's-dirty' : r.localStatus === 'ahead' ? 's-ahead' : 's-behind';
    var st = r.localStatus === 'dirty' ? 'uncommitted' : r.localStatus === 'ahead' ? 'ahead +' + (r.ahead||0) : 'behind -' + (r.behind||0);
    h += '<li class="attention-item" onclick="scrollToCard(\'' + escAttr(r.name) + '\')"><span class="sdot ' + sc + '"></span><span class="att-name">' + esc(r.name) + '</span><span class="att-status">' + st + '</span></li>';
  });
  h += '</ul>';
  panel.innerHTML = h;
}

function scrollToCard(name) {
  var card = document.getElementById('card-' + name);
  if (card) { card.scrollIntoView({ behavior: 'smooth', block: 'center' }); card.style.boxShadow = '0 0 0 2px var(--blue)'; setTimeout(function(){ card.style.boxShadow = ''; }, 2000); }
}

// --- Bulk selection ---
function getSelectedRepos() {
  var checks = document.querySelectorAll('.card-check:checked');
  var selected = [];
  checks.forEach(function(c) { selected.push({ account: c.dataset.account, name: c.dataset.name }); });
  return selected;
}

function updateBulkBar() {
  var sel = getSelectedRepos();
  var bar = document.getElementById('bulkBar');
  var cnt = document.getElementById('bulkCount');
  var byAccEl = document.getElementById('bulkCountByAccount');
  if (sel.length > 0) {
    bar.classList.add('show');
    cnt.textContent = sel.length;
    var byAccount = {};
    sel.forEach(function(s) { byAccount[s.account] = (byAccount[s.account] || 0) + 1; });
    var parts = [];
    Object.keys(byAccount).forEach(function(acc) {
      parts.push(byAccount[acc] + ' ' + getAccountLabel(acc));
    });
    var suffix = '';
    if (parts.length === 1) suffix = '— ' + getAccountLabel(Object.keys(byAccount)[0]) + ' only';
    else if (parts.length > 1) suffix = '(' + parts.join(', ') + ')';
    if (byAccEl) byAccEl.textContent = suffix ? ' ' + suffix : '';
  } else {
    bar.classList.remove('show');
    if (byAccEl) byAccEl.textContent = '';
  }
}

function bulkClearSelection() {
  document.querySelectorAll('.card-check:checked').forEach(function(c) { c.checked = false; });
  updateBulkBar();
}

async function bulkClone() {
  var sel = getSelectedRepos();
  var notCloned = sel.filter(function(s) { return allRepos.some(function(r){ return r.account===s.account && r.name===s.name && !r.isCloned; }); });
  if (notCloned.length === 0) { toast('All selected repos are already cloned', 'info'); return; }
  toast('Cloning ' + notCloned.length + ' repos...', 'info');
  addLog('Bulk clone: ' + notCloned.length + ' repos', 'warn');
  bulkClearSelection();
  for (var i = 0; i < notCloned.length; i++) {
    try { await apiPost('/repos/clone', { account: notCloned[i].account, repoName: notCloned[i].name }); }
    catch(e) { addLog('Clone failed: ' + notCloned[i].name, 'err'); }
  }
  refreshRepos();
}

async function bulkPull() {
  var sel = getSelectedRepos();
  var cloned = sel.filter(function(s) { return allRepos.some(function(r){ return r.account===s.account && r.name===s.name && r.isCloned; }); });
  if (cloned.length === 0) { toast('No cloned repos selected', 'info'); return; }
  toast('Pulling ' + cloned.length + ' repos...', 'info');
  addLog('Bulk pull: ' + cloned.length + ' repos', 'warn');
  bulkClearSelection();
  var ok = 0, fail = 0;
  for (var i = 0; i < cloned.length; i++) {
    try {
      var data = await apiPost('/repos/pull', { account: cloned[i].account, repoName: cloned[i].name });
      if (data.success) ok++; else fail++;
    } catch(e) { fail++; }
  }
  toast('Pulled ' + ok + ' repos' + (fail > 0 ? ', ' + fail + ' failed' : ''), ok > 0 ? 'success' : 'error');
  addLog('Bulk pull: ' + ok + ' ok, ' + fail + ' failed', 'ok');
  refreshRepos();
}

async function bulkFetch() {
  var sel = getSelectedRepos();
  var cloned = sel.filter(function(s) { return allRepos.some(function(r){ return r.account===s.account && r.name===s.name && r.isCloned; }); });
  if (cloned.length === 0) { toast('No cloned repos selected', 'info'); return; }
  toast('Fetching ' + cloned.length + ' repos...', 'info');
  addLog('Bulk fetch: ' + cloned.length + ' repos', 'warn');
  bulkClearSelection();
  var ok = 0, fail = 0;
  for (var i = 0; i < cloned.length; i++) {
    try {
      var data = await apiPost('/repos/fetch', { account: cloned[i].account, repoName: cloned[i].name });
      if (data.success) ok++; else fail++;
    } catch(e) { fail++; }
  }
  toast('Fetched ' + ok + ' repos' + (fail > 0 ? ', ' + fail + ' failed' : ''), ok > 0 ? 'success' : 'error');
  addLog('Bulk fetch: ' + ok + ' ok, ' + fail + ' failed', 'ok');
  refreshRepos();
}

function renderStats() {
  var total = allRepos.length;
  var cloned = allRepos.filter(function(r){return r.isCloned}).length;
  var dirty = allRepos.filter(function(r){return r.localStatus==='dirty'}).length;
  var stale = allRepos.filter(function(r){return isStale(r)}).length;
  document.getElementById('statsBar').innerHTML =
    '<div class="sidebar-stats-line">'+
      '<span><strong class="n-total">'+total+'</strong> repos</span>'+
      '<span><strong class="n-cloned">'+cloned+'</strong> cloned</span>'+
      '<span><strong class="n-dirty">'+dirty+'</strong> uncommitted</span>'+
      (stale > 0 ? '<span><strong style="color:var(--orange)">'+stale+'</strong> stale</span>' : '')+
    '</div>';
}

function toggleConfigDrop(btn) {
  var wrap = btn && btn.closest && btn.closest('.config-drop-wrap');
  if (!wrap) return;
  var drop = wrap.querySelector('.config-drop');
  var wasOpen = drop && drop.classList.contains('open');
  document.querySelectorAll('.config-bar .config-drop.open').forEach(function(d) { d.classList.remove('open'); });
  if (drop && !wasOpen) drop.classList.add('open');
}
function closeConfigDrops() {
  document.querySelectorAll('.config-bar .config-drop.open').forEach(function(d) { d.classList.remove('open'); });
}
function renderConfigBar() {
  var el = document.getElementById('configBar');
  if (!el) return;
  var h = '<div class="config-drop-wrap">';
  h += '<button type="button" class="config-trigger" onclick="toggleConfigDrop(this); event.stopPropagation();">View</button>';
  h += '<div class="config-drop" id="configDropView">';
  h += '<div class="config-drop-title">Mode</div><div class="config-row">';
  h += '<button type="button" class="config-btn'+(viewMode==='grid'?' on':'')+'" onclick="setViewMode(\'grid\'); closeConfigDrops()">Cards</button>';
  h += '<button type="button" class="config-btn'+(viewMode==='table'?' on':'')+'" onclick="setViewMode(\'table\'); closeConfigDrops()">Table</button>';
  h += '</div><div class="config-drop-title">Density</div><div class="config-row">';
  [['compact','Compact'],['comfortable','Comfortable'],['spacious','Spacious']].forEach(function(d){
    h += '<button type="button" class="config-btn'+(viewDensity===d[0]?' on':'')+'" onclick="setViewDensity(\''+d[0]+'\'); closeConfigDrops()">'+d[1]+'</button>';
  });
  h += '</div><div class="config-drop-title">Cols</div><div class="config-row">';
  [['auto','Auto'],['2','2'],['3','3'],['4','4']].forEach(function(c){
    h += '<button type="button" class="config-btn'+(viewColumns===c[0]?' on':'')+'" onclick="setViewColumns(\''+c[0]+'\'); closeConfigDrops()">'+c[1]+'</button>';
  });
  h += '</div></div></div>';
  h += '<div class="config-drop-wrap">';
  h += '<button type="button" class="config-trigger" onclick="toggleConfigDrop(this); event.stopPropagation();">Card</button>';
  h += '<div class="config-drop" id="configDropCard">';
  var cp = getCardPrefs();
  h += '<div class="config-drop-title">Show on cards</div>';
  h += '<label class="config-check"><input type="checkbox" '+(cp.showStars?'checked':'')+' onchange="setCardPref(\'showStars\',this.checked)"> Stars</label>';
  h += '<label class="config-check"><input type="checkbox" '+(cp.showDisk?'checked':'')+' onchange="setCardPref(\'showDisk\',this.checked)"> Disk</label>';
  h += '<label class="config-check"><input type="checkbox" '+(cp.showLanguage?'checked':'')+' onchange="setCardPref(\'showLanguage\',this.checked)"> Language</label>';
  h += '<label class="config-check"><input type="checkbox" '+(cp.showExtras?'checked':'')+' onchange="setCardPref(\'showExtras\',this.checked)"> PRs/Issues</label>';
  h += '<label class="config-check"><input type="checkbox" '+(cp.showLastCommit?'checked':'')+' onchange="setCardPref(\'showLastCommit\',this.checked)"> Last commit</label>';
  h += '<label class="config-check"><input type="checkbox" '+(cp.cardMinimal?'checked':'')+' onchange="setCardPref(\'cardMinimal\',this.checked)"> Minimal</label>';
  h += '</div></div></div>';
  el.innerHTML = h;
  if (!window._configBarClickBound) {
    window._configBarClickBound = true;
    document.addEventListener('click', function(e) { if (!e.target.closest('.config-bar')) closeConfigDrops(); });
  }
}

function renderFilters() {
  var el = document.getElementById('filters');
  var h = '';
  h+='<div class="filter-group"><span class="filter-label">Account</span><div class="filter-btns">';
  h+='<button class="fbtn'+(filters.account==='all'?' on':'')+'" onclick="setF(\'account\',\'all\')">All</button>';
  getAccountOrder().forEach(function(name){
    var label = getAccountLabel(name);
    h+='<button class="fbtn'+(filters.account===name?' on':'')+'" onclick="setF(\'account\',\''+escAttr(name)+'\')">'+esc(label)+'</button>';
  });
  h+='</div></div><div class="filter-group"><span class="filter-label">Visibility</span><div class="filter-btns">';
  [['all','All'],['public','Public'],['private','Private']].forEach(function(v){
    h+='<button class="fbtn'+(filters.visibility===v[0]?' on':'')+'" onclick="setF(\'visibility\',\''+v[0]+'\')">'+v[1]+'</button>';
  });
  h+='</div></div><div class="filter-group"><span class="filter-label">Status</span><div class="filter-btns">';
  [['all','All'],['cloned','Cloned'],['not_cloned','Not cloned'],['stale','Stale']].forEach(function(s){
    h+='<button class="fbtn'+(filters.status===s[0]?' on':'')+'" onclick="setF(\'status\',\''+s[0]+'\')">'+s[1]+'</button>';
  });
  h+='</div></div><div class="filter-group"><span class="filter-label">Sort</span><div class="filter-btns">';
  [['updated','Updated'],['name_az','A–Z'],['name_za','Z–A'],['size_desc','Size ↓']].forEach(function(s){
    h+='<button class="fbtn'+(filters.sort===s[0]?' on':'')+'" onclick="setF(\'sort\',\''+s[0]+'\')">'+s[1]+'</button>';
  });
  h+='</div></div><div class="filter-group"><span class="filter-label">Branch</span><div class="filter-btns">';
  [['all','All'],['primary','On primary'],['not_primary','Not on primary']].forEach(function(b){
    h+='<button class="fbtn'+(filters.branch===b[0]?' on':'')+'" onclick="setF(\'branch\',\''+b[0]+'\')">'+b[1]+'</button>';
  });
  h+='</div></div><div class="filter-group"><span class="filter-label" title="Repos on another branch are highlighted in yellow">My primary branch</span><div class="filter-btns">';
  [['main','main'],['master','master']].forEach(function(b){
    h+='<button class="fbtn'+(primaryBranchName===b[0]?' on':'')+'" onclick="setPrimaryBranch(\''+b[0]+'\')">'+b[1]+'</button>';
  });
  h+='</div></div><div class="filter-group"><span class="filter-label">Stale after</span><div class="filter-btns">';
  [['30','1 mo'],['90','3 mo'],['180','6 mo'],['365','1 yr']].forEach(function(s){
    h+='<button class="fbtn'+(String(staleDays)===s[0]?' on':'')+'" onclick="setStaleDays('+s[0]+')">'+s[1]+'</button>';
  });
  h+='</div></div>';
  el.innerHTML = h;
}

function setF(t,v){ filters[t]=v; renderFilters(); renderRepos(); }
function setPrimaryBranch(name){ primaryBranchName=name; localStorage.setItem('primaryBranchName',name); renderFilters(); renderRepos(); }
function setStaleDays(d){ staleDays=d; localStorage.setItem('staleDays',String(d)); renderFilters(); renderRepos(); renderStats(); renderAttention(); }

function getFiltered() {
  var list = allRepos.filter(function(r){
    if(filters.account!=='all'&&r.account!==filters.account) return false;
    if(filters.visibility!=='all'&&r.visibility!==filters.visibility) return false;
    if(filters.status==='cloned'&&!r.isCloned) return false;
    if(filters.status==='not_cloned'&&r.isCloned) return false;
    if(filters.status==='stale'&&!isStale(r)) return false;
    if(filters.branch==='primary'&&(!r.isCloned||(r.branch||'').trim()!==primaryBranchName)) return false;
    if(filters.branch==='not_primary'&&(!r.isCloned||!(r.branch||'').trim()||(r.branch||'').trim()===primaryBranchName)) return false;
    if(search){var q=search.toLowerCase();return r.name.toLowerCase().indexOf(q)>=0||r.description.toLowerCase().indexOf(q)>=0||r.language.toLowerCase().indexOf(q)>=0||(r.githubUser||'').toLowerCase().indexOf(q)>=0;}
    return true;
  });
  var sort = filters.sort || 'updated';
  if(sort==='updated') list.sort(function(a,b){ return new Date(b.updatedAt||0) - new Date(a.updatedAt||0); });
  else if(sort==='name_az') list.sort(function(a,b){ return (a.name||'').localeCompare(b.name||''); });
  else if(sort==='name_za') list.sort(function(a,b){ return (b.name||'').localeCompare(a.name||''); });
  else if(sort==='size_desc') list.sort(function(a,b){ return (b.diskUsage||0) - (a.diskUsage||0); });
  return list;
}

function timeAgo(d){if(!d)return'';var days=Math.floor((new Date()-new Date(d))/864e5);if(days===0)return'today';if(days===1)return'yesterday';if(days<30)return days+'d ago';if(days<365)return Math.floor(days/30)+'mo ago';return Math.floor(days/365)+'y ago';}

function repoStatusText(r) {
  if (!r.isCloned) return 'Not cloned';
  if (r.localStatus === 'clean') return 'Clean';
  if (r.localStatus === 'dirty') return 'Uncommitted';
  if (r.localStatus === 'ahead') return 'Ahead +' + r.ahead;
  if (r.localStatus === 'behind') return 'Behind -' + r.behind;
  return '—';
}

function tableRowHTML(r) {
  var n = escAttr(r.name), a = escAttr(r.account), u = escAttr(r.githubUser || '');
  var upd = r.isCloned && r.lastCommit && r.lastCommit.timeAgo ? r.lastCommit.timeAgo : timeAgo(r.updatedAt);
  var actions = '';
  if (r.isCloned) {
    actions = '<button class="btn btn-sm" onclick="openFocusView(\''+a+'\',\''+n+'\')">Details</button>'+
      '<button class="btn btn-sm" onclick="openGitModal(\''+a+'\',\''+n+'\')">Git</button>'+
      '<button class="btn btn-sm" onclick="askConfirmAction(\'pull\',\''+a+'\',\''+n+'\')">Pull</button>'+
      '<button class="btn btn-sm" onclick="askConfirmAction(\'fetch\',\''+a+'\',\''+n+'\')">Fetch</button>'+
      '<button class="btn btn-sm" onclick="askTransfer(\''+a+'\',\''+n+'\',\''+u+'\')">Transfer</button>';
  } else {
    actions = '<button class="btn btn-sm" onclick="openFocusView(\''+a+'\',\''+n+'\')">Details</button>'+
      '<button class="btn btn-sm btn-primary" onclick="doClone(\''+a+'\',\''+n+'\')">Clone</button>'+
      '<button class="btn btn-sm" onclick="askTransfer(\''+a+'\',\''+n+'\',\''+u+'\')">Transfer</button>';
  }
  return '<tr><td><input type="checkbox" class="card-check" data-account="'+a+'" data-name="'+n+'" onchange="updateBulkBar()" title="Select"></td>'+
    '<td class="t-name"><a href="'+esc(r.url)+'" target="_blank">'+esc(r.name)+'</a></td>'+
    '<td><span class="badge '+getAccountBadgeClass(r.account)+'">'+esc(getAccountLabel(r.account))+'</span></td>'+
    '<td>'+(r.branch ? esc(r.branch) : '—')+'</td>'+
    '<td>'+esc(repoStatusText(r))+'</td>'+
    '<td>'+(r.stars>0 ? r.stars : '—')+'</td>'+
    '<td>'+(r.diskUsage>0 ? formatSize(r.diskUsage) : '—')+'</td>'+
    '<td>'+(upd ? esc(upd) : '—')+'</td>'+
    '<td><span class="extras-pills" data-extras-key="'+a+'/'+n+'"></span></td>'+
    '<td class="t-actions">'+actions+'</td></tr>';
}

function cardHTML(r) {
  var prefs = getCardPrefs();
  var minimal = prefs.cardMinimal;
  var lc = LANG_COLORS[r.language]||'#8b949e';
  var sc='s-nc',st='Not cloned';
  if(r.isCloned){
    if(r.localStatus==='clean'){sc='s-clean';st='Clean';}
    else if(r.localStatus==='dirty'){sc='s-dirty';st='Uncommitted changes';}
    else if(r.localStatus==='ahead'){sc='s-ahead';st='Ahead +'+r.ahead;}
    else if(r.localStatus==='behind'){sc='s-behind';st='Behind -'+r.behind;}
  }
  var n=escAttr(r.name), a=escAttr(r.account), u=escAttr(r.githubUser||'');
  var upd=timeAgo(r.updatedAt);
  var acts='';
  if(r.isCloned){
    var cursorUri = r.localPath ? escAttr(pathToEditorUri(r.localPath,'cursor')) : '';
    var vscodeUri = r.localPath ? escAttr(pathToEditorUri(r.localPath,'vscode')) : '';
    var pathAttr = r.localPath ? escAttr(r.localPath) : '';
    var cardMenu = r.localPath ? '<div class="card-menu-wrap"><button type="button" class="btn-dots" onclick="toggleCardMenu(this); event.stopPropagation();" title="More actions">&#8942;</button><div class="card-menu"><a href="'+cursorUri+'">Cursor</a><button type="button" data-path="'+pathAttr+'" data-editor="cursor" onclick="openEditorNewWindow(this); event.stopPropagation();">Cursor (new window)</button><a href="'+vscodeUri+'">VS Code</a><button type="button" data-path="'+pathAttr+'" data-editor="code" onclick="openEditorNewWindow(this); event.stopPropagation();">VS Code (new window)</button><button type="button" data-path="'+pathAttr+'" onclick="openTerminal(this); event.stopPropagation();">Terminal</button><div class="card-menu-sep"></div><button type="button" data-path="'+pathAttr+'" onclick="copyRepoPathFromMenu(this); event.stopPropagation();">Copy path</button><button type="button" data-account="'+a+'" data-name="'+n+'" onclick="setAliasFromMenu(this); event.stopPropagation();">Set alias</button><div class="card-menu-sep"></div><button type="button" class="card-menu-remove" data-account="'+a+'" data-name="'+n+'" onclick="askRemoveFromMenu(this); event.stopPropagation();">Remove</button></div></div>' : '';
    acts='<div class="card-actions">'+
      '<button class="btn btn-sm" onclick="openFocusView(\''+a+'\',\''+n+'\')">Details</button>'+
      '<button class="btn btn-sm" onclick="openGitModal(\''+a+'\',\''+n+'\')">Git</button>'+
      '<button class="btn btn-sm" onclick="askConfirmAction(\'pull\',\''+a+'\',\''+n+'\')">Pull</button>'+
      '<button class="btn btn-sm" onclick="askConfirmAction(\'fetch\',\''+a+'\',\''+n+'\')">Fetch</button>'+
      '<button class="btn btn-sm" onclick="askTransfer(\''+a+'\',\''+n+'\',\''+u+'\')">Transfer</button>'+
    '</div>';
  } else {
    acts='<div class="card-actions">'+
      '<button class="btn btn-sm" onclick="openFocusView(\''+a+'\',\''+n+'\')">Details</button>'+
      '<button class="btn btn-sm btn-primary" onclick="doClone(\''+a+'\',\''+n+'\')">Clone</button>'+
      '<button class="btn btn-sm" onclick="askTransfer(\''+a+'\',\''+n+'\',\''+u+'\')">Transfer</button>'+
    '</div>';
  }
  var pinned = isPinned(r.account, r.name);
  var pinBtn = '<button type="button" class="btn-pin'+(pinned?' pinned':'')+'" onclick="togglePin(\''+a+'\',\''+n+'\'); event.stopPropagation();" title="'+(pinned?'Unpin':'Pin')+'">'+(pinned?'&#9733;':'&#9734;')+'</button>';
  var showReadmeBtn = !minimal;
  var cardTopDesc = (minimal || !r.description) ? '' : '<div class="card-desc">'+esc(r.description)+'</div>';
  var metaParts = [];
  if (!minimal) {
    if (prefs.showLanguage && r.language) metaParts.push('<span class="meta-item"><span class="lang-dot" style="background:'+lc+'"></span> '+esc(r.language)+'</span>');
    if (prefs.showStars && r.stars>0) metaParts.push('<span class="meta-item">&#9733; '+r.stars+'</span>');
    if (prefs.showLastCommit) {
      if (r.isCloned && r.lastCommit && r.lastCommit.timeAgo) metaParts.push('<span class="meta-item" title="Last local commit">Commit '+esc(r.lastCommit.timeAgo)+'</span>');
      else if (upd) metaParts.push('<span class="meta-item">Updated '+esc(upd)+'</span>');
    }
    if (prefs.showDisk && r.diskUsage > 0) metaParts.push('<span class="meta-item meta-size" title="Repository size">'+formatSize(r.diskUsage)+'</span>');
  }
  var cardMeta = metaParts.length ? '<div class="card-meta">'+metaParts.join('')+'</div>' : '';
  var extrasPills = (minimal || !prefs.showExtras) ? '' : '<span class="extras-pills" data-extras-key="'+a+'/'+n+'"></span>';
  return '<div class="card'+(pinned?' card-pinned':'')+'" id="card-'+esc(r.name)+'">'+
    '<div class="card-top">'+
      '<input type="checkbox" class="card-check" data-account="'+a+'" data-name="'+n+'" onchange="updateBulkBar()" title="Select for bulk action">'+
      '<div class="card-name-grp">'+
        '<a href="'+esc(r.url)+'" target="_blank" class="card-name" title="'+esc(r.name)+'">'+esc(r.name)+'</a>'+
        (minimal ? '' : '<span class="card-owner">'+esc(r.githubUser||'')+'</span>')+
        (showReadmeBtn ? '<button type="button" class="btn btn-sm" style="margin-top:6px;padding:2px 8px;font-size:11px" onclick="openReadme(\''+a+'\',\''+n+'\'); event.stopPropagation();" title="View README">README</button>' : '')+
      '</div>'+
      '<div class="badges">'+
        pinBtn+
        '<span class="badge '+getAccountBadgeClass(r.account)+'">'+esc(getAccountLabel(r.account))+'</span>'+
        (minimal ? '' : '<span class="badge b-'+(r.visibility==='private'?'prv':'pub')+'">'+esc(r.visibility)+'</span>'+
        (r.isCloned?'<span class="badge b-clone">cloned</span>':'')+
        (isStale(r)?'<span class="badge b-stale">stale</span>':''))+
        (r.isCloned && r.localPath ? cardMenu : '')+
      '</div>'+
    '</div>'+
    cardTopDesc+
    cardMeta+
    '<div class="card-footer">'+
      '<div class="status-ind"><span class="sdot '+sc+'"></span><span>'+esc(st)+'</span></div>'+
      extrasPills+
      (getAlias(r.account, r.name) ?
        '<span class="card-alias" onclick="setAlias(\''+a+'\',\''+n+'\'); event.stopPropagation();" title="Edit alias">'+esc(getAlias(r.account, r.name))+'</span>' :
        '<span class="card-alias-empty" onclick="setAlias(\''+a+'\',\''+n+'\'); event.stopPropagation();" title="Set alias">+ alias</span>')+
      (r.branch?'<span class="branch'+(r.branch.trim()!==primaryBranchName?' branch-not-primary':'')+'" title="Current branch">'+esc(r.branch)+'</span>':'')+
    '</div>'+
    acts+
  '</div>';
}

function renderRepos() {
  var el = document.getElementById('mainContent');
  if (focusRepo) { renderFocusView(); return; }
  var list = getFiltered();
  if(list.length===0){
    // If filtering by a specific account that has 0 repos, show setup hint
    if (filters.account !== 'all') {
      var accName = filters.account;
      var totalForAccount = allRepos.filter(function(r){ return r.account === accName; }).length;
      if (totalForAccount === 0) {
        var acc = allAccounts[accName];
        var label = (acc && acc.label) ? acc.label : accName;
        var errType = accountErrors[accName];
        var reason = '';
        if (errType === 'auth_required' || errType === 'gh_not_authenticated') {
          reason = '<p style="color:var(--t2);font-size:13px">Private repos cannot be loaded until this account is connected. ' +
            'Open the Setup Wizard and click <strong>Connect</strong> in step 4.</p>';
        } else if (errType === 'token_invalid' || errType === 'token_failed' || errType === 'token_mismatch') {
          reason = '<p style="color:var(--t2);font-size:13px">The saved token for this account is not valid. ' +
            'Open the Setup Wizard and reconnect the token.</p>';
        } else {
          reason = '<p style="color:var(--t2);font-size:13px">This account may have no public repos, or the setup is incomplete.</p>';
        }
        el.innerHTML = '<div class="empty-account-hint">' +
          '<p style="font-size:15px;margin-bottom:8px">No repos found for <strong>' + esc(label) + '</strong></p>' +
          reason +
          '<p style="margin-top:12px"><a href="javascript:void(0)" onclick="openAccountManager(); setTimeout(function(){ openSetupView(\'' + escAttr(accName) + '\'); }, 400);" style="color:var(--blue)">Open Setup Wizard</a> to complete the configuration.</p>' +
          '</div>';
        return;
      }
    }
    // All repos loaded but filters narrow to 0
    if (allRepos.length === 0) {
      el.innerHTML = '<div class="empty">' +
        '<div class="empty-icon"><svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg></div>' +
        '<p class="empty-title">No repositories yet</p>' +
        '<p class="empty-sub">Add a GitHub account to get started.<br>Your repos will appear here automatically.</p>' +
        '<button class="empty-btn" onclick="openAccountManager()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add Account</button>' +
        '</div>';
      return;
    }
    el.innerHTML='<div class="empty"><p class="empty-title">No repos match your filters</p><p class="empty-sub">Try adjusting or clearing the filters above.</p></div>';
    return;
  }

  if (viewMode === 'table') {
    var sort = filters.sort || 'updated';
    var h = '<div class="repos-table-wrap"><table class="repos-table"><thead><tr>'+
      '<th></th>'+
      '<th class="sortable" onclick="setF(\'sort\',\''+(sort==='name_az'?'name_za':'name_az')+'\')" title="Sort by name">Name</th>'+
      '<th>Account</th>'+
      '<th>Branch</th>'+
      '<th>Status</th>'+
      '<th>Stars</th>'+
      '<th class="sortable" onclick="setF(\'sort\',\'size_desc\')" title="Sort by size">Size</th>'+
      '<th class="sortable" onclick="setF(\'sort\',\'updated\')" title="Sort by updated">Last commit</th>'+
      '<th>PRs/Issues</th>'+
      '<th>Actions</th></tr></thead><tbody>';
    list.forEach(function(r){ h += tableRowHTML(r); });
    h += '</tbody></table></div>';
    el.innerHTML = h;
    applyExtras();
    return;
  }

  var pinList = list.filter(function(r){ return isPinned(r.account, r.name); });
  var unpinned = list.filter(function(r){ return !isPinned(r.account, r.name); });
  var h = '';

  if(pinList.length>0){
    h+='<div class="pinned-section"><div class="pinned-label">&#9733; Pinned <span class="sec-cnt">'+pinList.length+'</span></div>'+
      '<div class="grid">'+pinList.map(cardHTML).join('')+'</div></div>';
  }

  getAccountOrder().forEach(function(accName){
    var accRepos = unpinned.filter(function(r){ return r.account===accName; });
    var acc = allAccounts[accName];
    var label = (acc && acc.label) ? acc.label : accName;
    var sub = (acc && acc.githubUser) ? ' <span style="color:var(--t3);font-weight:400">('+esc(acc.githubUser)+')</span>' : '';
    if(accRepos.length===0) {
      // Show empty section hint (only for "all" filter; specific account filter is handled above)
      if (filters.account === 'all') {
        var errType = accountErrors[accName];
        var reason = '';
        if (errType === 'auth_required' || errType === 'gh_not_authenticated') {
          reason = 'Account not connected (private repos require authentication).';
        } else if (errType === 'token_invalid' || errType === 'token_failed' || errType === 'token_mismatch') {
          reason = 'Saved token is invalid. Reconnect in Setup Wizard.';
        } else {
          reason = 'No repos found. Setup may be incomplete.';
        }
        h+='<div class="sec-hdr"><div class="sec-title">'+esc(label)+sub+' <span class="sec-cnt">0</span></div></div>'+
          '<div class="empty-account-hint">'+
            '<p>' + reason + '</p>'+
            '<p style="margin-top:8px"><a href="javascript:void(0)" onclick="openAccountManager(); setTimeout(function(){ openSetupView(\'' + escAttr(accName) + '\'); }, 400);" style="color:var(--blue)">Open Setup Wizard</a></p>'+
          '</div>';
      }
      return;
    }
    h+='<div class="sec-hdr"><div class="sec-title">'+esc(label)+sub+' <span class="sec-cnt">'+accRepos.length+'</span></div>'+
      '<button class="btn btn-sm" onclick="doPullAll()">Pull All Local</button></div>'+
      '<div class="grid">'+accRepos.map(cardHTML).join('')+'</div>';
  });
  el.innerHTML = h;
}

function openFocusView(account, name) {
  focusRepo = { account: account, name: name };
  renderRepos();
}

function renderFocusView() {
  var el = document.getElementById('mainContent');
  if (!focusRepo) { renderRepos(); return; }
  var r = allRepos.find(function(x){ return x.account === focusRepo.account && x.name === focusRepo.name; });
  var name = focusRepo.name;
  var account = focusRepo.account;
  var url = r ? r.url : 'https://github.com/' + (r && r.githubUser ? r.githubUser : '') + '/' + name;
  el.innerHTML = '<div class="focus-view">'+
    '<div class="focus-header">'+
      '<button class="btn btn-sm" onclick="focusRepo=null;renderRepos()">Back</button>'+
      '<h1 class="focus-title">'+esc(name)+'</h1>'+
      '<span class="badge '+getAccountBadgeClass(account)+'">'+esc(getAccountLabel(account))+'</span>'+
      '<a href="'+esc(url)+'" target="_blank" class="btn btn-sm">GitHub</a>'+
    '</div>'+
    '<div class="focus-status" id="focusStatus">Loading...</div>'+
    '<div class="focus-actions" id="focusActions"></div>'+
    '<div class="focus-commits" id="focusCommits"></div>'+
    '<div class="focus-readme" id="focusReadme"></div>'+
    '<div class="focus-extras" id="focusExtras"></div>'+
  '</div>';
  loadFocusViewData();
}

async function loadFocusViewData() {
  var account = focusRepo.account, name = focusRepo.name;
  var r = allRepos.find(function(x){ return x.account === account && x.name === name; });
  var statusEl = document.getElementById('focusStatus');
  var actionsEl = document.getElementById('focusActions');
  var commitsEl = document.getElementById('focusCommits');
  var readmeEl = document.getElementById('focusReadme');
  var extrasEl = document.getElementById('focusExtras');
  var a = escAttr(account), n = escAttr(name), u = escAttr(r && r.githubUser ? r.githubUser : '');

  if (!r || !r.isCloned) {
    if (statusEl) statusEl.innerHTML = '<strong>Status</strong>: Not cloned.';
    if (actionsEl) actionsEl.innerHTML = '<p class="focus-section-title">Actions</p><div class="focus-actions-btns">'+
      '<button class="btn btn-sm btn-primary" onclick="doClone(\''+a+'\',\''+n+'\')">Clone</button>'+
      '<button class="btn btn-sm" onclick="askTransfer(\''+a+'\',\''+n+'\',\''+u+'\')">Transfer</button></div>';
    if (commitsEl) commitsEl.innerHTML = '<p class="focus-section-title">Recent commits</p><p class="focus-placeholder">Loading...</p>';
    if (r && r.description && statusEl) statusEl.innerHTML += '<br><span class="focus-placeholder">'+esc(r.description)+'</span>';
    if (readmeEl) readmeEl.innerHTML = '<p class="focus-section-title">README</p><p class="focus-placeholder">Loading...</p>';
    try {
      var commitsData = await apiGet('/repos/' + encodeURIComponent(account) + '/' + encodeURIComponent(name) + '/commits?per_page=5');
      if (commitsEl) {
        if (commitsData.success && commitsData.recentCommits && commitsData.recentCommits.length) {
          var list = commitsData.recentCommits;
          commitsEl.innerHTML = '<p class="focus-section-title">Recent commits</p><ul class="focus-commit-list">' +
            list.map(function(c){ return '<li><code>'+esc(c.hash)+'</code> '+esc(c.subject)+' — '+esc(c.author)+' '+(c.date ? esc(c.date) : '')+'</li>'; }).join('') + '</ul>';
        } else commitsEl.innerHTML = '<p class="focus-section-title">Recent commits</p><p class="focus-placeholder">—</p>';
      }
    } catch (e) {
      if (commitsEl) commitsEl.innerHTML = '<p class="focus-section-title">Recent commits</p><p class="focus-placeholder">—</p>';
    }
  } else {
    if (statusEl) statusEl.innerHTML = '<strong>Status</strong>: Loading...';
    try {
      var statusData = await apiGet('/repos/' + encodeURIComponent(account) + '/' + encodeURIComponent(name) + '/git-status');
      if (statusData.success) {
        var s = statusData;
        var st = 'Branch: ' + (s.currentBranch || '—');
        if (s.upstream && s.upstream.hasUpstream) {
          if (s.upstream.ahead) st += ' · Ahead ' + s.upstream.ahead;
          if (s.upstream.behind) st += ' · Behind ' + s.upstream.behind;
        }
        if (s.summary) {
          if (s.summary.staged) st += ' · Staged: ' + s.summary.staged;
          if (s.summary.unstaged) st += ' · Unstaged: ' + s.summary.unstaged;
          if (s.summary.untracked) st += ' · Untracked: ' + s.summary.untracked;
          if (s.summary.conflict) st += ' · Conflict';
        }
        if (statusEl) statusEl.innerHTML = '<strong>Status</strong>: ' + esc(st);
        if (commitsEl && s.recentCommits && s.recentCommits.length) {
          var list = s.recentCommits.slice(0, 5);
          commitsEl.innerHTML = '<p class="focus-section-title">Recent commits</p><ul class="focus-commit-list">' +
            list.map(function(c){ return '<li><code>'+esc(c.hash)+'</code> '+esc(c.subject)+' — '+esc(c.author)+' '+esc(c.date)+'</li>'; }).join('') + '</ul>';
        } else if (commitsEl) commitsEl.innerHTML = '<p class="focus-section-title">Recent commits</p><p class="focus-placeholder">None</p>';
      } else if (statusEl) statusEl.innerHTML = '<strong>Status</strong>: ' + (statusData.error || 'Failed to load');
    } catch (e) {
      if (statusEl) statusEl.innerHTML = '<strong>Status</strong>: Error — ' + esc(e.message || 'Failed');
    }
    if (actionsEl) actionsEl.innerHTML = '<p class="focus-section-title">Actions</p><div class="focus-actions-btns">'+
      '<button class="btn btn-sm" onclick="openGitModal(\''+a+'\',\''+n+'\')">Git</button>'+
      '<button class="btn btn-sm" onclick="askConfirmAction(\'pull\',\''+a+'\',\''+n+'\')">Pull</button>'+
      '<button class="btn btn-sm" onclick="askConfirmAction(\'fetch\',\''+a+'\',\''+n+'\')">Fetch</button>'+
      '<button class="btn btn-sm" onclick="askTransfer(\''+a+'\',\''+n+'\',\''+u+'\')">Transfer</button>'+
    '</div>';
  }

  var key = account + '/' + name;
  if (extrasEl && repoExtras[key]) {
    var ex = repoExtras[key];
    var exText = [];
    if (ex.prs > 0) exText.push(ex.prs + ' PR' + (ex.prs !== 1 ? 's' : ''));
    if (ex.issues > 0) exText.push(ex.issues + ' issue' + (ex.issues !== 1 ? 's' : ''));
    extrasEl.innerHTML = '<p class="focus-section-title">PRs / Issues</p><p>' + (exText.length ? esc(exText.join(' · ')) : '—') + '</p>';
  } else if (extrasEl) extrasEl.innerHTML = '<p class="focus-section-title">PRs / Issues</p><p class="focus-placeholder">—</p>';

  if (readmeEl) {
    if (!r || !r.isCloned) readmeEl.innerHTML = '<p class="focus-section-title">README</p><p class="focus-placeholder">Loading...</p>';
    try {
      var readmeData = await apiGet('/repos/' + encodeURIComponent(account) + '/' + encodeURIComponent(name) + '/readme');
      if (readmeData.success && readmeData.content) {
        var raw = typeof marked !== 'undefined' ? marked.parse(readmeData.content) : '';
        if (typeof DOMPurify !== 'undefined') {
          var html = DOMPurify.sanitize(raw);
          readmeEl.innerHTML = '<p class="focus-section-title">README</p><div class="focus-readme-body">'+html+'</div>';
        } else {
          readmeEl.innerHTML = '<p class="focus-section-title">README</p>';
          var pre = document.createElement('pre'); pre.className = 'focus-readme-body'; pre.textContent = readmeData.content;
          readmeEl.appendChild(pre);
        }
      } else readmeEl.innerHTML = '<p class="focus-section-title">README</p><p class="focus-placeholder">No README found.</p>';
    } catch (e) {
      readmeEl.innerHTML = '<p class="focus-section-title">README</p><p class="focus-placeholder">Failed to load.</p>';
    }
  }
}

// --- Git modal ---
function openGitModal(account, name) {
  gitModalRepo = { account: account, name: name };
  document.getElementById('gitModalRepoName').textContent = name;
  document.getElementById('gitModalBody').style.display = 'none';
  gitModalFeedback('');
  document.getElementById('gitCommitMessage').value = '';
  document.getElementById('gitNewBranchName').value = '';
  openModal('gitModal');
  loadGitStatus(true);
}

function gitModalFeedback(msg, type) {
  var el = document.getElementById('gitModalFeedback');
  if (!el) return;
  if (type === 'processing' && msg) {
    el.innerHTML = '<span class="spinner git-feedback-spinner"></span><span>' + esc(msg) + '</span>';
    el.className = 'git-modal-feedback processing';
    el.style.display = 'flex';
    return;
  }
  el.textContent = msg || '';
  el.className = 'git-modal-feedback' + (type === 'success' ? ' success' : type === 'error' ? ' error' : '');
  el.style.display = msg ? 'flex' : 'none';
}

async function loadGitStatus(clearFeedback, silent) {
  if (!gitModalRepo) return;
  var loading = document.getElementById('gitModalLoading');
  var body = document.getElementById('gitModalBody');
  if (!silent) {
    loading.style.display = 'block';
    body.style.display = 'none';
  }
  if (clearFeedback) gitModalFeedback('');
  var path = '/repos/' + encodeURIComponent(gitModalRepo.account) + '/' + encodeURIComponent(gitModalRepo.name) + '/git-status';
  try {
    var data = await apiGet(path);
    if (!silent) loading.style.display = 'none';
    if (!data.success) {
      gitModalFeedback(data.error || 'Failed to load status', 'error');
      if (!silent) body.style.display = 'block';
      return;
    }
    if (!silent) body.style.display = 'block';
    var commitBtn = document.getElementById('gitCommitBtn');
    if (commitBtn) commitBtn.disabled = false;
    var currentBranch = data.currentBranch || '—';
    document.getElementById('gitCurrentBranch').textContent = currentBranch;
    var op = data.operation || {};
    var opBanner = document.getElementById('gitModalOperationBanner');
    if (opBanner) {
      if (op.isMerging || op.isRebasing) {
        opBanner.textContent = op.isMerging ? 'Merge in progress — resolve conflicts before committing.' : 'Rebase in progress — resolve before continuing.';
        opBanner.style.display = 'block';
      } else {
        opBanner.style.display = 'none';
      }
    }
    var summary = data.summary || { stagedCount: 0, unstagedCount: 0, untrackedCount: 0, conflictCount: 0 };
    var strip = document.getElementById('gitStatusStrip');
    if (strip) {
      var parts = [];
      if (summary.stagedCount) parts.push('<span class="git-staged">Staged: ' + summary.stagedCount + '</span>');
      if (summary.unstagedCount) parts.push('<span class="git-unstaged">Unstaged: ' + summary.unstagedCount + '</span>');
      if (summary.untrackedCount) parts.push('<span class="git-untracked">Untracked: ' + summary.untrackedCount + '</span>');
      if (summary.conflictCount) parts.push('<span class="git-conflicts">Conflicts: ' + summary.conflictCount + '</span>');
      strip.innerHTML = parts.length ? parts.join('') : '';
      strip.style.display = parts.length ? 'flex' : 'none';
    }
    var upstream = data.upstream || {};
    var hasUpstream = !!upstream.hasUpstream;
    var unpushedCount = typeof data.unpushedCount !== 'undefined' ? data.unpushedCount : (upstream.ahead || 0);
    gitModalPushState = { currentBranch: currentBranch, hasUpstream: hasUpstream, unpushedCount: unpushedCount };
    var pushBtn = document.getElementById('gitPushBtn');
    if (pushBtn) {
      if (currentBranch === 'HEAD' || currentBranch === 'unknown') {
        pushBtn.textContent = 'Push';
        pushBtn.disabled = true;
      } else if (!hasUpstream) {
        pushBtn.textContent = 'Push (set upstream)';
        pushBtn.disabled = false;
      } else if (unpushedCount === 0) {
        pushBtn.textContent = 'Up to date';
        pushBtn.disabled = true;
      } else {
        pushBtn.textContent = 'Push (' + unpushedCount + ')';
        pushBtn.disabled = false;
      }
    }
    var sel = document.getElementById('gitBranchSelect');
    sel.innerHTML = '<option value="">Switch branch...</option>';
    (data.branches || []).forEach(function(b) {
      if (b.name === data.currentBranch) return;
      var opt = document.createElement('option');
      opt.value = b.name;
      opt.textContent = b.name + (b.remote ? ' (remote)' : '');
      sel.appendChild(opt);
    });
    var filesHtml = '';
    (data.files || []).forEach(function(f) {
      filesHtml += '<div class="git-file-row"><input type="checkbox" class="git-file-cb" data-path="' + escAttr(f.path) + '" data-status="' + escAttr(f.status) + '"><span class="git-file-path" title="' + escAttr(f.path) + '">' + esc(f.path) + '</span><span class="git-file-status">' + esc(f.status) + '</span><button type="button" class="btn btn-sm git-diff-btn" data-path="' + escAttr(f.path) + '" onclick="openGitDiff(this)" title="View diff">Diff</button></div>';
    });
    document.getElementById('gitFilesList').innerHTML = filesHtml || '<div class="git-file-row" style="color:var(--t3)">No changes</div>';
    var diffPanel = document.getElementById('gitDiffPanel');
    if (diffPanel) diffPanel.style.display = 'none';
    var diffContent = document.getElementById('gitDiffContent');
    if (diffContent) diffContent.textContent = '';
    var commits = data.recentCommits || [];
    var unpushedSet = {};
    (data.unpushedHashes || []).forEach(function(h) { unpushedSet[h] = true; });
    var commitsHtml = '';
    commits.forEach(function(c) {
      var unpushedBadge = unpushedSet[c.hash] ? '<span class="git-commit-unpushed" title="Not pushed to remote">Not pushed</span>' : '';
      commitsHtml += '<div class="git-commit-row"><span class="git-commit-hash" title="' + escAttr(c.hash) + '">' + esc(c.hash) + '</span>' + unpushedBadge + '<span class="git-commit-subject" title="' + escAttr(c.subject) + '">' + esc(c.subject) + '</span><span class="git-commit-meta">' + esc(c.author) + ' · ' + esc(c.date) + '</span><button type="button" class="btn btn-sm btn-danger" onclick="doGitRevert(\'' + escAttr(c.hash) + '\')">Revert</button></div>';
    });
    document.getElementById('gitRecentCommitsList').innerHTML = commitsHtml || '<div class="git-commit-row" style="color:var(--t3)">No commits yet</div>';
    var stashList = data.stashList || [];
    var stashEl = document.getElementById('gitStashList');
    if (stashEl) {
      if (stashList.length === 0) stashEl.innerHTML = '<div class="git-stash-empty" style="color:var(--t3);font-size:12px">No stashes</div>';
      else {
        stashEl.innerHTML = stashList.map(function(s) {
          return '<div class="git-stash-row"><span class="git-stash-ref">' + esc(s.ref) + '</span><span class="git-stash-msg" title="' + escAttr(s.message) + '">' + esc(s.message) + '</span><button type="button" class="btn btn-sm" data-stash-ref="' + escAttr(s.ref) + '" onclick="doGitStashApply(this)">Apply</button><button type="button" class="btn btn-sm" data-stash-ref="' + escAttr(s.ref) + '" onclick="doGitStashPop(this)">Pop</button></div>';
        }).join('');
      }
    }
  } catch (e) {
    if (!silent) loading.style.display = 'none';
    if (!silent) body.style.display = 'block';
    gitModalFeedback(e.message || 'Request failed', 'error');
  }
}

var gitDiffCurrent = null; // { path, mode: 'worktree'|'staged' }

function closeGitDiff() {
  var panel = document.getElementById('gitDiffPanel');
  if (panel) panel.style.display = 'none';
  gitDiffCurrent = null;
}

function switchGitDiffTab(btn) {
  if (!gitDiffCurrent || !btn || !btn.dataset.mode) return;
  document.querySelectorAll('.git-diff-tab').forEach(function(t) { t.classList.remove('active'); });
  btn.classList.add('active');
  gitDiffCurrent.mode = btn.dataset.mode;
  loadGitDiffContent(gitDiffCurrent.path, gitDiffCurrent.mode);
}

async function loadGitDiffContent(filePath, mode) {
  if (!gitModalRepo || !filePath) return;
  var content = document.getElementById('gitDiffContent');
  var title = document.getElementById('gitDiffTitle');
  if (title) title.textContent = filePath + ' (' + (mode === 'staged' ? 'staged' : 'worktree') + ')';
  if (content) content.textContent = 'Loading...';
  try {
    var url = '/repos/' + encodeURIComponent(gitModalRepo.account) + '/' + encodeURIComponent(gitModalRepo.name) + '/git/diff?path=' + encodeURIComponent(filePath) + '&mode=' + encodeURIComponent(mode);
    var data = await apiGet(url);
    if (content) {
      if (data.binary) content.textContent = '(Binary file — diff not shown)';
      else if (data.diff) content.textContent = data.diff + (data.truncated ? '\n\n[Output truncated]' : '');
      else content.textContent = data.output || '(No diff)';
    }
  } catch (e) {
    if (content) content.textContent = 'Error: ' + (e.message || 'Request failed');
  }
}

async function openGitDiff(btn) {
  if (!gitModalRepo || !btn) return;
  var filePath = btn.getAttribute('data-path');
  if (!filePath) return;
  gitDiffCurrent = { path: filePath, mode: 'worktree' };
  document.querySelectorAll('.git-diff-tab').forEach(function(t) { t.classList.toggle('active', t.dataset.mode === 'worktree'); });
  var panel = document.getElementById('gitDiffPanel');
  if (panel) panel.style.display = 'block';
  await loadGitDiffContent(filePath, 'worktree');
}

function showDiscardAllConfirm() {
  document.getElementById('gitDiscardAllConfirm').style.display = 'block';
  document.getElementById('gitDiscardAllInput').value = '';
  setTimeout(function() { document.getElementById('gitDiscardAllInput').focus(); }, 50);
}

function hideDiscardAllConfirm() {
  document.getElementById('gitDiscardAllConfirm').style.display = 'none';
}

async function doGitDiscardAll() {
  if (!gitModalRepo) return;
  var input = document.getElementById('gitDiscardAllInput');
  var confirmPhrase = input && input.value ? input.value.trim() : '';
  if (confirmPhrase !== 'DISCARD') {
    gitModalFeedback('Type DISCARD to confirm.', 'error');
    return;
  }
  hideDiscardAllConfirm();
  var includeUntracked = document.getElementById('gitDiscardAllIncludeUntracked') && document.getElementById('gitDiscardAllIncludeUntracked').checked;
  gitModalFeedback('Discarding...', 'processing');
  try {
    var data = await apiPost('/repos/' + encodeURIComponent(gitModalRepo.account) + '/' + encodeURIComponent(gitModalRepo.name) + '/git/discard-all', { includeUntracked: !!includeUntracked, confirm: 'DISCARD' });
    if (data.success) {
      gitModalFeedback('All changes discarded.', 'success');
      loadGitStatus(false, true);
      refreshRepos();
    } else {
      gitModalFeedback(data.output || data.error || 'Discard failed', 'error');
    }
  } catch (e) {
    gitModalFeedback(e.message || 'Request failed', 'error');
  }
}

async function doGitDiscardSelected() {
  if (!gitModalRepo) return;
  var checked = document.querySelectorAll('#gitFilesList .git-file-cb:checked');
  if (!checked.length) {
    gitModalFeedback('Select one or more files to discard.', 'error');
    return;
  }
  if (!confirm('Discard changes in ' + checked.length + ' file(s)?')) return;
  gitModalFeedback('Discarding...', 'processing');
  var failed = 0;
  for (var i = 0; i < checked.length; i++) {
    var cb = checked[i];
    var filePath = cb.getAttribute('data-path');
    var status = cb.getAttribute('data-status') || '';
    if (!filePath) continue;
    try {
      var data = await apiPost('/repos/' + encodeURIComponent(gitModalRepo.account) + '/' + encodeURIComponent(gitModalRepo.name) + '/git/discard-file', { path: filePath, includeStaged: true, allowUntracked: status === 'untracked' });
      if (!data.success) failed++;
    } catch (e) { failed++; }
  }
  if (failed) gitModalFeedback('Discarded with ' + failed + ' error(s).', 'error');
  else gitModalFeedback('Selected files discarded.', 'success');
  loadGitStatus(false, true);
  refreshRepos();
}

async function doGitStashPush() {
  if (!gitModalRepo) return;
  gitModalFeedback('Stashing...', 'processing');
  try {
    var data = await apiPost('/repos/' + encodeURIComponent(gitModalRepo.account) + '/' + encodeURIComponent(gitModalRepo.name) + '/git/stash/push', { includeUntracked: false });
    if (data.success) {
      gitModalFeedback('Changes stashed.', 'success');
      loadGitStatus(false, true);
      refreshRepos();
    } else {
      gitModalFeedback(data.output || data.error || 'Stash failed', 'error');
    }
  } catch (e) {
    gitModalFeedback(e.message || 'Request failed', 'error');
  }
}

async function doGitStashApply(btn) {
  if (!gitModalRepo || !btn) return;
  var ref = btn.getAttribute('data-stash-ref');
  if (!ref) return;
  gitModalFeedback('Applying stash...', 'processing');
  try {
    var data = await apiPost('/repos/' + encodeURIComponent(gitModalRepo.account) + '/' + encodeURIComponent(gitModalRepo.name) + '/git/stash/apply', { ref: ref });
    if (data.success) {
      gitModalFeedback('Stash applied.', 'success');
      loadGitStatus(false, true);
      refreshRepos();
    } else {
      gitModalFeedback(data.output || data.error || 'Apply failed', 'error');
    }
  } catch (e) {
    gitModalFeedback(e.message || 'Request failed', 'error');
  }
}

async function doGitStashPop(btn) {
  if (!gitModalRepo || !btn) return;
  var ref = btn.getAttribute('data-stash-ref');
  if (!ref) return;
  if (!confirm('Pop this stash? It will be removed from the stash list.')) return;
  gitModalFeedback('Popping stash...', 'processing');
  try {
    var data = await apiPost('/repos/' + encodeURIComponent(gitModalRepo.account) + '/' + encodeURIComponent(gitModalRepo.name) + '/git/stash/pop', { ref: ref });
    if (data.success) {
      gitModalFeedback('Stash popped.', 'success');
      loadGitStatus(false, true);
      refreshRepos();
    } else {
      gitModalFeedback(data.output || data.error || 'Pop failed', 'error');
    }
  } catch (e) {
    gitModalFeedback(e.message || 'Request failed', 'error');
  }
}

function gitStageAll() {
  document.querySelectorAll('#gitFilesList .git-file-cb').forEach(function(cb) { cb.checked = true; });
}

async function doGitCheckout() {
  if (!gitModalRepo) return;
  var sel = document.getElementById('gitBranchSelect');
  var branch = sel && sel.value;
  if (!branch) { gitModalFeedback('Select a branch first.', 'error'); return; }
  try {
    var data = await apiPost('/repos/' + encodeURIComponent(gitModalRepo.account) + '/' + encodeURIComponent(gitModalRepo.name) + '/git/checkout', { branch: branch });
    if (data.success) { gitModalFeedback('Switched to ' + branch + '.', 'success'); loadGitStatus(); }
    else { gitModalFeedback(data.output || data.error || 'Checkout failed', 'error'); }
  } catch (e) { gitModalFeedback(e.message || 'Request failed', 'error'); }
}

async function doGitCreateBranch() {
  if (!gitModalRepo) return;
  var name = document.getElementById('gitNewBranchName').value.trim();
  if (!name) { gitModalFeedback('Enter a branch name.', 'error'); return; }
  try {
    var data = await apiPost('/repos/' + encodeURIComponent(gitModalRepo.account) + '/' + encodeURIComponent(gitModalRepo.name) + '/git/branch', { name: name });
    if (data.success) { gitModalFeedback('Created and switched to ' + name + '.', 'success'); document.getElementById('gitNewBranchName').value = ''; loadGitStatus(); }
    else { gitModalFeedback(data.output || data.error || 'Failed', 'error'); }
  } catch (e) { gitModalFeedback(e.message || 'Request failed', 'error'); }
}

async function doGitCommit() {
  if (!gitModalRepo) return;
  var msg = document.getElementById('gitCommitMessage').value.trim();
  if (!msg) { gitModalFeedback('Enter a commit message.', 'error'); return; }
  var commitBtn = document.getElementById('gitCommitBtn');
  var pushBtn = document.getElementById('gitPushBtn');
  if (commitBtn) commitBtn.disabled = true;
  if (pushBtn) pushBtn.disabled = true;
  gitModalFeedback('Committing...', 'processing');
  var files = [];
  document.querySelectorAll('#gitFilesList .git-file-cb:checked').forEach(function(cb) {
    var p = cb.getAttribute('data-path');
    if (p) files.push(p);
  });
  try {
    var data = await apiPost('/repos/' + encodeURIComponent(gitModalRepo.account) + '/' + encodeURIComponent(gitModalRepo.name) + '/git/commit', { message: msg, files: files.length ? files : undefined });
    if (data.success) {
      var out = (data.output && data.output.split('\n')[0]) ? data.output.split('\n')[0].trim() : '';
      gitModalFeedback(out ? 'Commit done. ' + out : 'Commit done.', 'success');
      addLog('Commit: ' + gitModalRepo.name, 'ok');
      document.getElementById('gitCommitMessage').value = '';
      if (pushBtn) pushBtn.disabled = false;
      loadGitStatus(false, true);
      refreshRepos();
    } else {
      gitModalFeedback(data.output || data.error || 'Commit failed', 'error');
      if (commitBtn) commitBtn.disabled = false;
      if (pushBtn) pushBtn.disabled = false;
    }
  } catch (e) {
    gitModalFeedback(e.message || 'Request failed', 'error');
    if (commitBtn) commitBtn.disabled = false;
    if (pushBtn) pushBtn.disabled = false;
  }
}

async function doGitRevert(commitHash) {
  if (!gitModalRepo || !commitHash) return;
  if (!confirm('Revert commit ' + commitHash + '? This will create a new commit that undoes that change.')) return;
  gitModalFeedback('Reverting...', 'processing');
  try {
    var data = await apiPost('/repos/' + encodeURIComponent(gitModalRepo.account) + '/' + encodeURIComponent(gitModalRepo.name) + '/git/revert', { commit: commitHash });
    if (data.success) {
      gitModalFeedback('Revert done.', 'success');
      loadGitStatus(false, true);
      refreshRepos();
    } else {
      gitModalFeedback(data.output || data.error || 'Revert failed', 'error');
    }
  } catch (e) {
    gitModalFeedback(e.message || 'Request failed', 'error');
  }
}

async function doGitPull(useRebase) {
  if (!gitModalRepo) return;
  gitModalFeedback((useRebase ? 'Pulling with rebase...' : 'Pulling...'), 'processing');
  try {
    var data = await apiPost('/repos/' + encodeURIComponent(gitModalRepo.account) + '/' + encodeURIComponent(gitModalRepo.name) + '/git/pull', { rebase: !!useRebase });
    if (data.success) {
      gitModalFeedback(data.output ? 'Pull done. ' + data.output.split('\n')[0] : 'Pull done.', 'success');
      addLog('Pull: ' + gitModalRepo.name, 'ok');
      loadGitStatus(false, true);
      refreshRepos();
    } else {
      gitModalFeedback(data.output || data.error || 'Pull failed', 'error');
    }
  } catch (e) {
    gitModalFeedback(e.message || 'Request failed', 'error');
  }
}

async function doGitPush() {
  if (!gitModalRepo) return;
  var commitBtn = document.getElementById('gitCommitBtn');
  var pushBtn = document.getElementById('gitPushBtn');
  if (pushBtn) pushBtn.disabled = true;
  if (commitBtn) commitBtn.disabled = true;
  gitModalFeedback('Pushing...', 'processing');
  var body = {};
  if (gitModalPushState && !gitModalPushState.hasUpstream && gitModalPushState.currentBranch && gitModalPushState.currentBranch !== 'HEAD' && gitModalPushState.currentBranch !== 'unknown') {
    body.branch = gitModalPushState.currentBranch;
  }
  try {
    var data = await apiPost('/repos/' + encodeURIComponent(gitModalRepo.account) + '/' + encodeURIComponent(gitModalRepo.name) + '/git/push', body);
    if (data.success) {
      var out = (data.output && data.output.split('\n')[0]) ? data.output.split('\n')[0].trim() : '';
      gitModalFeedback(out ? 'Push done. ' + out : 'Push done.', 'success');
      addLog('Push: ' + gitModalRepo.name, 'ok');
      if (commitBtn) commitBtn.disabled = false;
      if (pushBtn) pushBtn.disabled = false;
      loadGitStatus(false, true);
      refreshRepos();
    } else {
      gitModalFeedback(data.output || data.error || 'Push failed', 'error');
      if (commitBtn) commitBtn.disabled = false;
      if (pushBtn) pushBtn.disabled = false;
    }
  } catch (e) {
    gitModalFeedback(e.message || 'Request failed', 'error');
    if (commitBtn) commitBtn.disabled = false;
    if (pushBtn) pushBtn.disabled = false;
  }
}

// --- Confirm action (Pull / Fetch) ---
var ACTION_MESSAGES = {
  pull: 'This will pull the latest changes from remote into your local copy.',
  fetch: 'This will check for remote updates without modifying your local files.'
};

function askConfirmAction(action, account, name) {
  pendingConfirmAction = { action: action, account: account, name: name };
  document.getElementById('confirmActionTitle').textContent = 'Confirm ' + (action === 'pull' ? 'Pull' : 'Fetch');
  document.getElementById('confirmActionRepo').textContent = name;
  document.getElementById('confirmActionMsg').textContent = ACTION_MESSAGES[action] || '';
  openModal('confirmActionModal');
}

function confirmActionExecute() {
  if (!pendingConfirmAction) return;
  var a = pendingConfirmAction.account;
  var n = pendingConfirmAction.name;
  var action = pendingConfirmAction.action;
  closeModal('confirmActionModal');
  pendingConfirmAction = null;
  if (action === 'pull') doPull(a, n);
  else if (action === 'fetch') doFetch(a, n);
}

// --- README ---
async function openReadme(account, name) {
  var titleEl = document.getElementById('readmeRepoName');
  var contentEl = document.getElementById('readmeContent');
  var loadingEl = document.getElementById('readmeLoading');
  var errorEl = document.getElementById('readmeError');
  titleEl.textContent = name;
  contentEl.innerHTML = '';
  contentEl.style.display = 'none';
  errorEl.style.display = 'none';
  errorEl.textContent = '';
  loadingEl.style.display = 'block';
  openModal('readmeModal');
  try {
    var data = await apiGet('/repos/' + encodeURIComponent(account) + '/' + encodeURIComponent(name) + '/readme');
    loadingEl.style.display = 'none';
    if (data.success && data.content) {
      if (typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
        marked.setOptions({ gfm: true, breaks: true });
        var raw = marked.parse(data.content);
        contentEl.innerHTML = DOMPurify.sanitize(raw);
      } else {
        contentEl.textContent = data.content;
      }
      contentEl.style.display = 'block';
      if (data.source) titleEl.textContent = name + (data.source === 'local' ? ' (local)' : ' (GitHub)');
    } else {
      errorEl.textContent = data.error || 'No README found';
      errorEl.style.display = 'block';
    }
  } catch (e) {
    loadingEl.style.display = 'none';
    errorEl.textContent = e.message || 'Failed to load README';
    errorEl.style.display = 'block';
  }
}

// --- Actions ---
function showCloneOverlay(repoName) {
  var ov = document.getElementById('cloneOverlay');
  var title = document.getElementById('cloneOverlayTitle');
  var sub = document.getElementById('cloneOverlaySub');
  if (title) title.textContent = 'Cloning ' + repoName + '...';
  if (sub) sub.textContent = 'This may take a moment depending on repo size.';
  if (ov) ov.classList.add('active');
}
function hideCloneOverlay() {
  var ov = document.getElementById('cloneOverlay');
  if (ov) ov.classList.remove('active');
}

async function doClone(account, name) {
  showCloneOverlay(name);
  addLog('Cloning '+name+'...','info');
  try {
    var data = await apiPost('/repos/clone',{account:account,repoName:name});
    if(data.success){addLog('Clone started: '+name,'ok');}
    else{hideCloneOverlay();toast('Clone failed: '+data.error,'error');addLog('Clone failed: '+name+' - '+data.error,'err');}
  }catch(e){hideCloneOverlay();toast('Error: '+e.message,'error');addLog('Clone error: '+e.message,'err');}
}

function openCloneUrlModal() {
  var input = document.getElementById('cloneUrlInput');
  var folder = document.getElementById('cloneUrlFolderName');
  var sel = document.getElementById('cloneUrlAccount');
  if (input) input.value = '';
  if (folder) folder.value = '';
  if (sel) {
    var preferred = (filters && filters.account && allAccounts[filters.account]) ? filters.account : (Object.keys(allAccounts)[0] || '');
    sel.value = preferred;
  }
  openModal('cloneUrlModal');
  setTimeout(function(){ if (input) input.focus(); }, 80);
}

async function doCloneUrl() {
  var urlEl = document.getElementById('cloneUrlInput');
  var folderEl = document.getElementById('cloneUrlFolderName');
  var accEl = document.getElementById('cloneUrlAccount');
  var url = urlEl && urlEl.value ? urlEl.value.trim() : '';
  var folderName = folderEl && folderEl.value ? folderEl.value.trim() : '';
  var account = accEl && accEl.value ? accEl.value : (Object.keys(allAccounts)[0] || '');
  if (!url) { toast('Paste a GitHub repo URL', 'error'); return; }
  if (!account || !allAccounts[account]) { toast('Select a valid account', 'error'); return; }

  closeModal('cloneUrlModal');
  var displayName = folderName || url.split('/').pop().replace(/\.git$/, '') || 'repo';
  showCloneOverlay(displayName);
  addLog('Cloning from URL...','info');
  try {
    var body = { account: account, url: url };
    if (folderName) body.folderName = folderName;
    var data = await apiPost('/repos/clone-url', body);
    if (data.success) {
      var used = data.usedFolder || data.repo || '';
      addLog('Clone URL started' + (used ? (': ' + used) : ''), 'ok');
    } else {
      hideCloneOverlay();
      toast('Clone failed: ' + (data.error || 'unknown error'), 'error');
      addLog('Clone URL failed: ' + (data.error || 'unknown error'), 'err');
    }
  } catch (e) {
    hideCloneOverlay();
    toast('Error: ' + (e.message || 'Request failed'), 'error');
    addLog('Clone URL error: ' + (e.message || 'Request failed'), 'err');
  }
}

async function doPull(account, name) {
  addLog('Pulling '+name+'...','info');
  try {
    var data = await apiPost('/repos/pull',{account:account,repoName:name});
    if(data.success){toast(name+' updated!','success');addLog('Pulled: '+name,'ok');}
    else{toast('Pull failed: '+data.error,'error');addLog('Pull failed: '+name+' - '+data.error,'err');}
  }catch(e){toast('Error: '+e.message,'error');}
  refreshRepos();
}

async function doFetch(account, name) {
  addLog('Fetching '+name+'...','info');
  try {
    var data = await apiPost('/repos/fetch',{account:account,repoName:name});
    if(data.success){toast(name+' fetched!','success');addLog('Fetched: '+name,'ok');}
    else{toast('Fetch failed: '+data.error,'error');}
  }catch(e){toast('Error: '+e.message,'error');}
  refreshRepos();
}

async function doPullAll() {
  addLog('Pulling all local repos...','info');
  toast('Updating all local repos...','info');
  try {
    var data = await apiPost('/repos/pull-all',{});
    if(data.success){
      var ok = data.results.filter(function(r){return r.success}).length;
      var fail = data.results.filter(function(r){return !r.success}).length;
      toast('Updated '+ok+' repos'+(fail>0?', '+fail+' skipped':''),'success');
      addLog('Pull all: '+ok+' ok, '+fail+' skipped','ok');
    }
  }catch(e){toast('Error: '+e.message,'error');}
  refreshRepos();
}

function askRemove(account, name) {
  pendingRemove = {account:account, name:name};
  document.getElementById('removeMsg').textContent = 'Remove "'+name+'" from your local computer? The repo stays safe on GitHub.';
  document.getElementById('removeWarning').style.display = 'none';
  var repo = allRepos.find(function(r){return r.name===name && r.account===account});
  if(repo && repo.localStatus === 'dirty'){
    document.getElementById('removeWarning').style.display = 'block';
    document.getElementById('removeWarning').textContent = 'WARNING: This repo has uncommitted changes that will be LOST!';
  }
  if(repo && repo.ahead > 0){
    document.getElementById('removeWarning').style.display = 'block';
    document.getElementById('removeWarning').textContent = 'WARNING: This repo has '+repo.ahead+' unpushed commit(s) that will be LOST!';
  }
  document.getElementById('removeModalConfirm').style.display = '';
  document.getElementById('removeModalProgress').style.display = 'none';
  openModal('removeModal');
}

async function confirmRemove() {
  if(!pendingRemove) return;
  var name = pendingRemove.name;
  document.getElementById('removeModalConfirm').style.display = 'none';
  document.getElementById('removeModalProgress').style.display = 'flex';
  document.getElementById('removeProgressText').textContent = 'Removing "'+name+'" from your computer…';
  addLog('Removing '+name+'...','warn');
  try {
    var data = await apiPost('/repos/remove',{account:pendingRemove.account,repoName:pendingRemove.name,force:true});
    closeModal('removeModal');
    if(data.success){ toast(data.message,'success'); addLog('Removed: '+name,'ok'); }
    else{ toast('Remove failed: '+data.error,'error'); addLog('Remove failed: '+data.error,'err'); }
  }catch(e){
    closeModal('removeModal');
    toast('Error: '+e.message,'error');
  }
  pendingRemove = null;
  refreshRepos();
}

function askTransfer(account, name, githubUser) {
  var others = Object.keys(allAccounts).filter(function(a){ return a !== account; });
  var destAccount = others.length > 0 ? others[0] : null;
  var destUser = destAccount && allAccounts[destAccount] ? allAccounts[destAccount].githubUser : '';
  var sel = document.getElementById('transferToAccount');
  if (sel) {
    sel.innerHTML = others.map(function(a) {
      var acc = allAccounts[a];
      return '<option value="'+escAttr(a)+'">' + esc(acc ? acc.label + ' (' + acc.githubUser + ')' : a) + '</option>';
    }).join('');
    if (others.length > 0) sel.value = others[0];
  }
  pendingTransfer = {fromAccount:account, toAccount:destAccount, name:name};
  document.getElementById('transferInfo').innerHTML =
    '<strong>Repo:</strong> '+esc(name)+'<br>'+
    '<strong>From:</strong> '+esc(githubUser)+'<br>'+
    '<strong>To:</strong> <span id="transferToUser">'+esc(destUser)+'</span><br>'+
    '<strong>New URL:</strong> github.com/<span id="transferToUserUrl">'+esc(destUser)+'</span>/'+esc(name);
  document.getElementById('transferConfirm').value = '';
  document.getElementById('transferConfirm').placeholder = name;
  if (sel && sel.addEventListener) {
    sel.onchange = function() {
      var to = allAccounts[sel.value];
      var u = to ? to.githubUser : '';
      var tu = document.getElementById('transferToUser');
      var tuUrl = document.getElementById('transferToUserUrl');
      if (tu) tu.textContent = u;
      if (tuUrl) tuUrl.textContent = u;
    };
  }
  openModal('transferModal');
}

async function doTransfer() {
  if(!pendingTransfer) return;
  var toSel = document.getElementById('transferToAccount');
  var toAccount = (toSel && toSel.value) ? toSel.value : pendingTransfer.toAccount;
  if (!toAccount) { toast('Select a destination account', 'error'); return; }
  var typed = document.getElementById('transferConfirm').value;
  if(typed !== pendingTransfer.name){toast('Repo name does not match. Transfer cancelled.','error');return;}
  closeModal('transferModal');
  pendingTransfer.toAccount = toAccount;
  addLog('Transferring '+pendingTransfer.name+'...','warn');
  toast('Transferring '+pendingTransfer.name+'...','info');
  try {
    var payload = { repoName: pendingTransfer.name, fromAccount: pendingTransfer.fromAccount, toAccount: pendingTransfer.toAccount };
    var data = await apiPost('/repos/transfer', payload);
    if(data.success){
      if(data.transferComplete){
        toast(data.message,'success');
        addLog('Transfer complete: '+pendingTransfer.name,'ok');
      } else {
        toast(data.message,'info');
        addLog('Transfer pending acceptance: '+pendingTransfer.name,'warn');
      }
    }
    else{toast('Transfer failed: '+data.error,'error');addLog('Transfer failed: '+data.error,'err');}
  }catch(e){toast('Error: '+e.message,'error');}
  pendingTransfer = null;
  setTimeout(refreshRepos, 2000);
}

async function doMigrate() {
  var sourcePath = document.getElementById('migratePath').value.trim();
  var repoName = document.getElementById('migrateName').value.trim();
  var account = document.getElementById('migrateAccount').value;
  if(!sourcePath||!repoName){toast('Fill in all fields','error');return;}
  closeModal('migrateModal');
  addLog('Migrating '+repoName+'...','info');
  try {
    var data = await apiPost('/repos/migrate',{sourcePath:sourcePath,account:account,repoName:repoName});
    if(data.success){toast(data.message,'success');addLog('Migrated: '+repoName,'ok');}
    else{toast('Migrate failed: '+data.error,'error');addLog('Migrate failed: '+data.error,'err');}
  }catch(e){toast('Error: '+e.message,'error');}
  document.getElementById('migratePath').value='';
  document.getElementById('migrateName').value='';
  refreshRepos();
}

// --- Search ---
document.getElementById('searchInput').addEventListener('input',function(e){search=e.target.value;renderRepos();document.getElementById('searchClear').classList.toggle('visible',e.target.value.length>0);});
function clearSearch(){var input=document.getElementById('searchInput');input.value='';search='';document.getElementById('searchClear').classList.remove('visible');renderRepos();input.focus();}
document.addEventListener('keydown',function(e){
  var inp=document.getElementById('searchInput');
  if(e.key==='/'&&document.activeElement!==inp){e.preventDefault();inp.focus();}
  if(e.key==='Escape'){inp.blur();inp.value='';search='';renderRepos();closeModal('removeModal');closeModal('migrateModal');closeModal('cloneUrlModal');closeModal('transferModal');closeModal('confirmActionModal');closeModal('readmeModal');closeModal('gitModal');closeModal('accountManagerModal');closeModal('hubModal');}
});

// --- SSE (real-time updates) ---
function connectSSE() {
  try {
    var es = new EventSource(API + '/events');
    es.onmessage = async function(e) {
      var data = JSON.parse(e.data);
      if(data.type === 'operation_complete') {
        if(data.success) {
          addLog(data.operation + ' completed: ' + data.repo, 'ok');
        } else {
          addLog(data.operation + ' failed: ' + data.repo, 'err');
        }
        await refreshRepos();
        hideCloneOverlay();
        if(data.success) {
          toast(data.repo + ': ' + data.operation + ' completed!', 'success');
        } else {
          toast(data.repo + ': ' + data.operation + ' failed', 'error');
        }
      }
    };
    es.onerror = function() {
      document.getElementById('lastUpdated').innerHTML = '<span class="status-dot-live dot-off"></span> Server offline';
    };
    es.onopen = function() {
      document.getElementById('lastUpdated').innerHTML = '<span class="status-dot-live dot-ok"></span> Connected';
    };
  } catch(e) { /* SSE not supported */ }
}

// --- Alias modal keyboard support ---
document.getElementById('aliasInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') { e.preventDefault(); confirmAlias(false); }
  if (e.key === 'Escape') { e.preventDefault(); closeModal('aliasModal'); }
});

// --- Clone URL modal keyboard support ---
document.getElementById('cloneUrlInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') { e.preventDefault(); doCloneUrl(); }
  if (e.key === 'Escape') { e.preventDefault(); closeModal('cloneUrlModal'); }
});

document.getElementById('cloneUrlFolderName').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') { e.preventDefault(); doCloneUrl(); }
  if (e.key === 'Escape') { e.preventDefault(); closeModal('cloneUrlModal'); }
});

// --- Init ---
connectSSE();
refreshRepos();
</script>
</body>
</html>
